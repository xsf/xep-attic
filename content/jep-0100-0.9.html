<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>JEP-0100: Gateway Interaction</title>
<link rel="stylesheet" type="text/css" href="jep.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Gateway Interaction">
<meta name="DC.Creator" content="Peter Saint-Andre">
<meta name="DC.Creator" content="Dave Smith">
<meta name="DC.Description" content="This JEP specifies best practices for interactions between Jabber clients and client proxy gateways to legacy IM services.">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="JEP Editor">
<meta name="DC.Date" content="2004-10-27">
<meta name="DC.Type" content="Jabber Enhancement Proposal">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="JEP-0100">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This Jabber Enhancement Proposal is copyright 1999 - 2005 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.jabber.org/jsf/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Open Publication License, v1.0 or later (the latest version is presently available at &lt;http://www.opencontent.org/openpub/&gt;).">
</head>
<body bgcolor="#FFFFFF">
<h1>JEP-0100: Gateway Interaction</h1>
<p>This JEP specifies best practices for interactions between Jabber clients and client proxy gateways to legacy IM services.</p>
<p><hr></p>
<p style="color:red">WARNING: This Informational JEP is Experimental. Publication as a Jabber Enhancement Proposal does not imply approval of this proposal by the Jabber Software Foundation. Implementation of the best practice or protocol profile described herein is encouraged in exploratory implementations, although production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p>
<p><hr></p>
<h2>JEP Information</h2>
<p class="indent">
            Status: Experimental<br>
            Type: Informational<br>
            Number: 0100<br>
            Version: 0.9<br>
            Last Updated: 2004-10-27<br>
            JIG: Standards JIG<br>
                Approving Body: Jabber Council<br>Dependencies: XMPP Core, XMPP IM, JEP-0030, JEP-0077, JEP-0144<br>
                Supersedes: None<br>
                Superseded By: None<br>
            Short Name: N/A<br></p>
<h2>Author Information</h2>
<h3>Peter Saint-Andre</h3>
<p class="indent">
        Email: stpeter@jabber.org<br>
        JID: stpeter@jabber.org</p>
<h3>Dave Smith</h3>
<p class="indent">
        Email: dizzyd@jabber.org<br>
        JID: dizzyd@jabber.org</p>
<h2>Legal Notice</h2>
<p class="indent">This Jabber Enhancement Proposal is copyright 1999 - 2005 by the <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a> (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.jabber.org/jsf/ipr-policy.shtml">http://www.jabber.org/jsf/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Open Publication License, v1.0 or later (the latest version is presently available at &lt;<a href="http://www.opencontent.org/openpub/">http://www.opencontent.org/openpub/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocols defined in this JEP have been developed outside the Internet Standards Process and are to be understood as extensions to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119.</p>
<p><hr></p>
<h2>Table of Contents</h2>
<dl>
<dt>1.  <a href="#intro">Introduction</a>
</dt>
<dt>2.  <a href="#terms">Terminology</a>
</dt>
<dl><dt>2.1.  <a href="#terms-glossary">Architectural Terms</a>
</dt></dl>
<dt>3.  <a href="#reqs">Requirements</a>
</dt>
<dt>4.  <a href="#usecases-jabber">Jabber User Use Cases</a>
</dt>
<dl>
<dt>4.1.  <a href="#usecases-jabber-register">Register</a>
</dt>
<dl>
<dt>4.1.1.  <a href="#usecases-jabber-register-pri">Primary Flow</a>
</dt>
<dt>4.1.2.  <a href="#usecases-jabber-register-alt">Alternate Flows</a>
</dt>
</dl>
<dt>4.2.  <a href="#usecases-jabber-edit">Edit Registration</a>
</dt>
<dl>
<dt>4.2.1.  <a href="#usecases-jabber-edit-pri">Primary Flow</a>
</dt>
<dt>4.2.2.  <a href="#usecases-jabber-edit-alt">Alternate Flows</a>
</dt>
</dl>
<dt>4.3.  <a href="#usecases-jabber-unregister">Unregister</a>
</dt>
<dl>
<dt>4.3.1.  <a href="#usecases-jabber-unregister-pri">Primary Flow</a>
</dt>
<dt>4.3.2.  <a href="#usecases-jabber-unregister-alt">Alternate Flows</a>
</dt>
</dl>
<dt>4.4.  <a href="#usecases-jabber-login">Log In</a>
</dt>
<dl>
<dt>4.4.1.  <a href="#usecases-jabber-login-pri">Primary Flow</a>
</dt>
<dt>4.4.2.  <a href="#usecases-jabber-login-alt">Alternate Flows</a>
</dt>
</dl>
<dt>4.5.  <a href="#usecases-jabber-logout">Log Out</a>
</dt>
<dl>
<dt>4.5.1.  <a href="#usecases-jabber-logout-pri">Primary Flow</a>
</dt>
<dt>4.5.2.  <a href="#usecases-jabber-logout-alt">Alternate Flows</a>
</dt>
</dl>
<dt>4.6.  <a href="#usecases-jabber-addcontact">Add Contact</a>
</dt>
<dl>
<dt>4.6.1.  <a href="#usecases-jabber-addcontact-pri">Primary Flow</a>
</dt>
<dt>4.6.2.  <a href="#usecases-jabber-addcontact-alt">Alternate Flows</a>
</dt>
</dl>
<dt>4.7.  <a href="#usecases-jabber-deletecontact">Delete Contact</a>
</dt>
<dl>
<dt>4.7.1.  <a href="#usecases-jabber-deletecontact-pri">Primary Flow</a>
</dt>
<dt>4.7.2.  <a href="#usecases-jabber-deletecontact-alt">Alternate Flows</a>
</dt>
</dl>
<dt>4.8.  <a href="#usecases-jabber-send">Send Message</a>
</dt>
<dl>
<dt>4.8.1.  <a href="#usecases-jabber-send-pri">Primary Flow</a>
</dt>
<dt>4.8.2.  <a href="#usecases-jabber-send-alt">Alternate Flows</a>
</dt>
</dl>
</dl>
<dt>5.  <a href="#usecases-legacy">Legacy User Use Cases</a>
</dt>
<dl>
<dt>5.1.  <a href="#usecases-legacy-add">Add Contact</a>
</dt>
<dl>
<dt>5.1.1.  <a href="#usecases-legacy-add-pri">Primary Flow</a>
</dt>
<dt>5.1.2.  <a href="#usecases-legacy-add-alt">Alternate Flows</a>
</dt>
</dl>
<dt>5.2.  <a href="#usecases-legacy-delete">Delete Contact</a>
</dt>
<dl>
<dt>5.2.1.  <a href="#usecases-legacy-delete-pri">Primary Flow</a>
</dt>
<dt>5.2.2.  <a href="#usecases-legacy-delete-alt">Alternate Flows</a>
</dt>
</dl>
<dt>5.3.  <a href="#usecases-legacy-send">Send Message</a>
</dt>
<dl>
<dt>5.3.1.  <a href="#usecases-legacy-send-pri">Primary Flow</a>
</dt>
<dt>5.3.2.  <a href="#usecases-legacy-send-alt">Alternate Flows</a>
</dt>
</dl>
</dl>
<dt>6.  <a href="#addressing">Addressing</a>
</dt>
<dl>
<dt>6.1.  <a href="#addressing-gateway">Gateways</a>
</dt>
<dt>6.2.  <a href="#addressing-user">Users</a>
</dt>
</dl>
<dt>7.  <a href="#rosters">Contact Lists</a>
</dt>
<dt>8.  <a href="#bizrules">Business Rules</a>
</dt>
<dt>9.  <a href="#security">Security Considerations</a>
</dt>
<dt>10.  <a href="#iana">IANA Considerations</a>
</dt>
<dt>11.  <a href="#registrar">Jabber Registrar Considerations</a>
</dt>
<dl><dt>11.1.  <a href="#registrar-ns">Jabber Registrar Considerations</a>
</dt></dl>
<dt>12.  <a href="#schema">XML Schema</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl>
<p><hr></p>
<h2>1.
       <a name="intro">Introduction</a>
</h2>
  <p class="" style="">One distinguishing characteristic of Jabber technologies from its earliest days has been the existence of gateways (also called "transports") between the Jabber network and legacy instant messaging services such as AOL Instant Messenger (AIM), ICQ, MSN Messenger, and Yahoo! Instant Messenger. Surprisingly, the recommended behavior of such gateways, including the protocol elements used by a client to interact with a gateway, has never been fully documented. This JEP attempts to fill that void by codifying best practices for gateway interaction.</p>
  <p class="" style="">Note well that this JEP defines protocol usage with regard to client proxy gateways, i.e., gateways that "masquerade" as a client on a non-Jabber IM service. Gateways that perform direct protocol translation without proxying for an account on a non-Jabber service are not addressed in this JEP. Furthermore, this JEP does not define any interaction between a gateway and the non-Jabber service, only interactions between a Jabber client and the gateway. Although what happens on the other side of the gateway is highly dependent on the nature of the legacy service, gateways should at least provide a common interface on the Jabber side of the gateway so that Jabber clients can be written in a consistent fashion.</p>
<h2>2.
       <a name="terms">Terminology</a>
</h2>
  <div class="indent">
<h3>2.1 <a name="terms-glossary">Architectural Terms</a>
</h3>
    <p class="caption">Table 1: Glossary</p>
<table border="1" cellpadding="3" cellspacing="0">
      <tr class="body">
        <th colspan="" rowspan="">Term</th>
        <th colspan="" rowspan="">Definition</th>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">Gateway</td>
        <td align="" colspan="" rowspan="">A service on the Jabber network that translates between the Jabber/XMPP protocols and the protocol used by a Legacy Service; in the context of this JEP, by "gateway" we mean a "client proxy service" that acts as a client with regard to a Legacy Service and thereby "masquerades" as a user on such a service.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">Jabber User</td>
        <td align="" colspan="" rowspan="">A human user who has registered an account with a Jabber server; a Jabber User who wants to use a Gateway must first have also registered an account with a Legacy Service.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">Legacy Service</td>
        <td align="" colspan="" rowspan="">A non-XMPP instant messaging service.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">Legacy User</td>
        <td align="" colspan="" rowspan="">A human user who has registered an account with a Legacy Service.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">Server</td>
        <td align="" colspan="" rowspan="">An instant messaging server as defined in <span style="font-weight: bold">XMPP Core</span>
</td>
      </tr>
    </table>
  </div>
<h2>3.
       <a name="reqs">Requirements</a>
</h2>
  <p class="" style="">The requirements defined by this JEP are captured in two sets of use cases: one set from the perspective of the Jabber User, and a smaller set from the perspective of the Legacy User who wants to interact with the Jabber User.</p>
  <p class="" style="">The Jabber User use cases are:</p>
  <ol start="" type="">
    <li>Register</li>
    <li>Edit Registration</li>
    <li>Unregister</li>
    <li>Log In</li>
    <li>Log Out</li>
    <li>Add Contact</li>
    <li>Delete Contact</li>
    <li>Send Message</li>
  </ol>
  <p class="" style="">The Legacy User use cases are:</p>
  <ol start="" type="">
    <li>Add Contact</li>
    <li>Delete Contact</li>
    <li>Send Message</li>
  </ol>
<h2>4.
       <a name="usecases-jabber">Jabber User Use Cases</a>
</h2>
  <div class="indent">
<h3>4.1 <a name="usecases-jabber-register">Register</a>
</h3>
    <p class="" style="">All existing client proxy gateways require a Jabber User to register with the Gateway before sending messages or presence through the gateway. Although strictly speaking registration is not required (e.g., a Gateway could prompt the Jabber User for credentials every time the user attempted to communicate through the gateway, or once per "session"), in practice this step is required.</p>
    <div class="indent">
<h3>4.1.1 <a name="usecases-jabber-register-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends IQ get in the <span class="ref" style="">Service Discovery</span>  [<a href="#nt-id2255217">1</a>] information namespace to the Gateway, and/or IQ get in the <span class="ref" style="">Agent Information</span>  [<a href="#nt-id2255240">2</a>] namespace to the Gateway's parent (the latter method is deprecated but still in use).</p>
          <p class="caption">Example 1. User Queries Gateway Regarding Service Discovery Identity</p>
<div class="indent"><pre>
&lt;iq type='get'
    from='romeo@montague.net/orchard'
    to='aim.shakespeare.lit'
    id='disco1'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
          </pre></div>
          <p class="caption">Example 2. User Queries Gateway's Parent Regarding Agent Information</p>
<div class="indent"><pre>
&lt;iq type='get'
    from='romeo@montague.net/orchard'
    to='shakespeare.lit'
    id='agent1'&gt;
  &lt;query xmlns='jabber:iq:agents'/&gt;
&lt;/iq&gt;
          </pre></div>
          <p class="" style="">Note: Although most existing gateway implementations support only the older Agent Information protocol, it is RECOMMENDED that gateways support the Service Discovery protocol, since the former protocol is deprecated in favor of the latter. Until existing gateways are upgraded, clients SHOULD support both.</p>
        </li>
        <li>
          <p class="" style="">Gateway and/or parent returns identity information to Jabber User's Client.</p>
          <p class="caption">Example 3. Gateway Returns Service Discovery Identity</p>
<div class="indent"><pre>
&lt;iq type='result'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='disco1'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    &lt;identity category='gateway'
              type='aim'
              name='AIM Gateway'/&gt;
    &lt;feature var='jabber:iq:register'/&gt;
    &lt;feature var='jabber:iq:time'/&gt;
    &lt;feature var='jabber:iq:version'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
          <p class="caption">Example 4. Gateway's Parent Returns Agent Information</p>
<div class="indent"><pre>
&lt;iq type='get'
    from='romeo@montague.net/orchard'
    to='shakespeare.lit'
    id='agent1'&gt;
  &lt;query xmlns='jabber:iq:agents'&gt;
    &lt;agent jid='aim.shakespeare.lit'&gt;
      &lt;name&gt;AIM Gateway&lt;/name&gt;
      &lt;service&gt;aim&lt;/service&gt;
      &lt;transport/&gt;
      &lt;register/&gt;
    &lt;/agent&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
          <p class="" style="">Note: Given the foregoing, a client can determine the identity of the gateway, specifically (1) that it is a gateway and (2) to which legacy service it provides a gateway.</p>
        </li>
        <li>
          <p class="" style="">Jabber User sends IQ get in the <span class="ref" style="">In-Band Registration</span>  [<a href="#nt-id2255350">3</a>] (jabber:iq:register) namespace to Gateway.</p>
          <p class="caption">Example 5. User Queries Gateway Regarding Registration Requirements</p>
<div class="indent"><pre>
&lt;iq type='get'
    from='romeo@montague.net/orchard'
    to='aim.shakespeare.lit'
    id='reg1'&gt;
  &lt;query xmlns='jabber:iq:register'/&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway returns IQ result to Jabber User, specifying information that is required in order to register.</p>
          <p class="caption">Example 6. Gateway Returns Registration Requirements</p>
<div class="indent"><pre>
&lt;iq type='result'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='reg1'&gt;
  &lt;query xmlns='jabber:iq:register'&gt;
    &lt;instructions&gt;
      Please provide your AIM username and password.
    &lt;/instructions&gt;
    &lt;username/&gt;
    &lt;password/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Jabber User sends IQ set qualified by the 'jabber:iq:register' namespace to Gateway, containing information required to register.</p>
          <p class="caption">Example 7. User Provides Registration Information</p>
<div class="indent"><pre>
&lt;iq type='set'
    from='romeo@montague.net/orchard'
    to='aim.shakespeare.lit'
    id='reg2'&gt;
  &lt;query xmlns='jabber:iq:register'&gt;
    &lt;username&gt;RomeoMyRomeo&lt;/username&gt;
    &lt;password&gt;ILoveJuliet&lt;/password&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway verifies that registration information provided by Jabber User is valid (using whatever means appropriate for the Legacy Service) and informs Jabber User of success [A1].</p>
          <p class="caption">Example 8. Gateway Informs Jabber User of Success</p>
<div class="indent"><pre>
&lt;iq type='result'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='reg2'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Optionally, Jabber User sends IQ set qualified by the 'jabber:iq:roster' namespace to its server (see <span class="ref" style="">XMPP IM</span>  [<a href="#nt-id2255461">4</a>]), containing a roster item for Gateway.</p>
          <p class="caption">Example 9. User Creates Roster Entry</p>
<div class="indent"><pre>
&lt;iq type='set'
    from='romeo@montague.net/orchard'
    id='roster1'&gt;
  &lt;query xmlns='jabber:iq:roster'&gt;
    &lt;item jid='aim.shakespeare.lit' name='AIM Gateway'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
          <p class="caption">Example 10. Server Response</p>
<div class="indent"><pre>
&lt;iq type='result'
    to='romeo@montague.net/orchard'
    id='roster1'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">If Gateway logged using into Legacy Service in preceding step, Gateway buffers any translatable events (e.g., messages and presence) queued up for Jabber User on Legacy Service.</p></li>
        <li>
          <p class="" style="">Gateway sends subscription request to Jabber User (i.e., by sending a presence stanza of type "subscribe" to Jabber User's bare JID).</p>
          <p class="caption">Example 11. Gateway Subscribes to User's Presence</p>
<div class="indent"><pre>
&lt;presence type='subscribe'
          from='aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Jabber User's client SHOULD approve the subscription request (i.e., by sending a presence stanza of type "subscribed" to Gateway).</p>
          <p class="caption">Example 12. Jabber User Approves Subscription Request</p>
<div class="indent"><pre>
&lt;presence type='subscribed'
          from='romeo@montague.net'
          to='aim.shakespeare.lit'/&gt;
          </pre></div>
          <p class="" style="">Note: As specified in <span style="font-weight: bold">XMPP IM</span>, Jabber User's server will generate a "roster push" at this point if client did not previously perform a roster set to add Gateway to user's roster (as mentioned in Step 7).</p>
        </li>
        <li>
          <p class="" style="">Jabber User sends subscription request to Gateway (i.e., by sending a presence stanza of type "subscribe" to Gateway).</p>
          <p class="caption">Example 13. Jabber User Subscribes to Gateway's Presence</p>
<div class="indent"><pre>
&lt;presence type='subscribe'
          from='romeo@montague.net'
          to='aim.shakespeare.lit'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway sends approves subscription request (i.e., by sending a presence stanza of type "subscribed" to Jabber User's bare JID).</p>
          <p class="caption">Example 14. Gateway Approves Subscription Request</p>
<div class="indent"><pre>
&lt;presence type='subscribed'
          from='aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Execute "Log In" use case.</p></li>
        <li><p class="" style="">Gateway sends any buffered messages to Jabber User.</p></li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>4.1.2 <a name="usecases-jabber-register-alt">Alternate Flows</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">User information not verified:
          <ol start="" type="">
            <li>
              <p class="" style="">Gateway returns "Not Acceptable" error to Jabber User.</p>
              <p class="caption">Example 15. Gateway Informs Jabber User of Registration Error</p>
<div class="indent"><pre>
&lt;iq type='error'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='reg2'&gt;
  &lt;query xmlns='jabber:iq:register'&gt;
    &lt;username&gt;RomeoMyRomeo&lt;/username&gt;
    &lt;password&gt;ILoveJuliet&lt;/password&gt;
  &lt;/query&gt;
  &lt;error code='406' type='modify'&gt;
    &lt;not-acceptable
        xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
              </pre></div>
            </li>
            <li><p class="" style="">Use Case Ends unsuccessfully.</p></li>
          </ol>
        </p></li>
      </ol>
    </div>
  </div>
  <div class="indent">
<h3>4.2 <a name="usecases-jabber-edit">Edit Registration</a>
</h3>
    <p class="" style="">After a Jabber User has registered with a Gateway, the user may wish to modify its existing registration information (e.g., because the user has changed his or her password on the legacy IM service).</p>
    <div class="indent">
<h3>4.2.1 <a name="usecases-jabber-edit-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends IQ get qualified by the 'jabber:iq:register' namespace to Gateway.</p>
          <p class="caption">Example 16. User Queries Gateway Regarding Registration Requirements</p>
<div class="indent"><pre>
&lt;iq type='get'
    from='romeo@montague.net/orchard'
    to='aim.shakespeare.lit'
    id='edit1'&gt;
  &lt;query xmlns='jabber:iq:register'/&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway returns IQ result to Jabber User, specifying registration information of record and including empty &lt;registered/&gt; element to signify that user is already registered.</p>
          <p class="caption">Example 17. Gateway Returns Registration Information of Record</p>
<div class="indent"><pre>
&lt;iq type='result'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='edit1'&gt;
  &lt;query xmlns='jabber:iq:register'&gt;
    &lt;registered/&gt;
    &lt;username&gt;RomeoMyRomeo&lt;/username&gt;
    &lt;password&gt;ILoveJuliet&lt;/password&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Jabber User sends IQ set qualified by the 'jabber:iq:register' namespace to Gateway, containing all information (i.e., not just the "delta").</p>
          <p class="caption">Example 18. User Provides Registration Information</p>
<div class="indent"><pre>
&lt;iq type='set'
    from='romeo@montague.net/orchard'
    to='aim.shakespeare.lit'
    id='edit2'&gt;
  &lt;query xmlns='jabber:iq:register'&gt;
    &lt;username&gt;RomeoMyRomeo&lt;/username&gt;
    &lt;password&gt;B4lc0ny&lt;/password&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway verifies that, if changed, information provided by Jabber User is still valid (using whatever means appropriate for the Legacy Service) and informs Jabber User of success [A1].</p>
          <p class="caption">Example 19. Gateway Informs Jabber User of Success</p>
<div class="indent"><pre>
&lt;iq type='result'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='edit2'/&gt;
          </pre></div>
        </li>
      </ol>
    </div>
    <div class="indent">
<h3>4.2.2 <a name="usecases-jabber-edit-alt">Alternate Flows</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Edit unsuccessful:
          <ol start="" type="">
            <li>
              <p class="" style="">Gateway returns "Not Acceptable" error to Jabber User.</p>
              <p class="caption">Example 20. Gateway Informs Jabber User of Registration Error</p>
<div class="indent"><pre>
&lt;iq type='error'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='edit2'&gt;
  &lt;query xmlns='jabber:iq:register'&gt;
    &lt;username&gt;RomeoMyRomeo&lt;/username&gt;
    &lt;password&gt;B4lc0ny&lt;/password&gt;
  &lt;/query&gt;
  &lt;error code='406' type='modify'&gt;
    &lt;not-acceptable
        xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
              </pre></div>
            </li>
            <li><p class="" style="">Use Case Ends unsuccessfully.</p></li>
          </ol>
        </p></li>
      </ol>
    </div>
  </div>
  <div class="indent">
<h3>4.3 <a name="usecases-jabber-unregister">Unregister</a>
</h3>
    <p class="" style="">After a Jabber User has registered with a Gateway, the user may choose to unregister with the Gateway, effectively ending his or her relationship with the Gateway (e.g., the user will no longer be allowed to communicate through the gateway with legacy users).</p>
    <div class="indent">
<h3>4.3.1 <a name="usecases-jabber-unregister-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends IQ set in 'jabber:iq:register' namespace to Gateway, containing empty &lt;remove/&gt; element.</p>
          <p class="caption">Example 21. User Unregisters</p>
<div class="indent"><pre>
&lt;iq type='set'
    from='romeo@montague.net/orchard'
    to='aim.shakespeare.lit'
    id='unreg1'&gt;
  &lt;query xmlns='jabber:iq:register'&gt;
    &lt;remove/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Gateway sends unavailable presence from Jabber User to Legacy Users and logs Jabber User out of Legacy Service.</p></li>
        <li><p class="" style="">Gateway deletes Jabber User's information.</p></li>
        <li>
          <p class="" style="">Gateway sends IQ result to Jabber User.</p>
          <p class="caption">Example 22. Gateway Informs Jabber User of Success</p>
<div class="indent"><pre>
&lt;iq type='result'
    from='aim.shakespeare.lit'
    to='romeo@montague.net/orchard'
    id='unreg1'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway cancels subscriptions.</p>
          <p class="caption">Example 23. Gateway Cancels Subscriptions</p>
<div class="indent"><pre>
&lt;presence type='unsubscribe'
          from='aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;

&lt;presence type='unsubscribed'
          from='aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway sends unavailable presence to Jabber User.</p>
          <p class="caption">Example 24. Gateway Logs User Out</p>
<div class="indent"><pre>
&lt;presence type='unavailable'
          from='aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Jabber User's client SHOULD delete from the user's roster (1) the gateway itself, and (2) all legacy cOntacts associated with the gateway.</p></li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>4.3.2 <a name="usecases-jabber-unregister-alt">Alternate Flows</a>
</h3>
      <p class="" style="">None.</p>
    </div>
  </div>
  <div class="indent">
<h3>4.4 <a name="usecases-jabber-login">Log In</a>
</h3>
    <p class="" style="">After a Jabber User has registered with a Gateway, the Jabber User may subsequently log in to the Gateway, effectively creating a "session" with the Gateway and enabling the Gateway to log into the Legacy Service on behalf of the user by sending the user's legacy credentials to the Legacy Service.</p>
    <div class="indent">
<h3>4.4.1 <a name="usecases-jabber-login-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends available presence broadcast to Server or sends directed presence to Gateway or a Legacy User.</p>
          <p class="caption">Example 25. Jabber User Sends Available Presence</p>
<div class="indent"><pre>
&lt;presence/&gt;
          </pre></div>
          <p class="caption">Example 26. Jabber User's Server Broadcasts Available Presence</p>
<div class="indent"><pre>
&lt;presence from='romeo@montague.net/orchard'
          to='juliet@aim.shakespeare.lit'/&gt;
&lt;presence from='romeo@montague.net/orchard'
          to='aim.shakespeare.lit'/&gt;
...
          </pre></div>
        </li>
        <li><p class="" style="">Upon receiving first presence notification stanza from Jabber User to Gateway or Legacy User, Gateway logs Jabber User into Legacy Service [A1].</p></li>
        <li>
          <p class="" style="">Gateway sends presence stanza to Jabber User expressing availability.</p>
          <p class="caption">Example 27. Gateway Sends Presence to Jabber User</p>
<div class="indent"><pre>
&lt;presence from='aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Optionally, Gateway handles Legacy Service contact list; see the <a href="#rosters">Contact Lists</a> section of this document.</p></li>
        <li>
          <p class="" style="">Gateway forwards current presence information from Legacy Users to Jabber User, if possible mapping availability status (e.g., "away").</p>
          <p class="caption">Example 28. Gateway Sends Presence from Legacy Users to Jabber User</p>
<div class="indent"><pre>
&lt;presence from='juliet@aim.shakespeare.lit'
          to='romeo@montague.net'&gt;
  &lt;show&gt;away&lt;/show&gt;
&lt;/presence&gt;
          </pre></div>
          <p class="" style="">Note: If the Legacy Service to which the Gateway connects does not support the concept of "resources", the 'from' address of presence notification stanzas generated by a gateway SHOULD NOT include a resource identifier (i.e., they SHOULD be of the form &lt;user@host&gt; rather than &lt;user@host/resource&gt;). However, the 'from' address MAY include a resource if the Gateway determines that this is appropriate in the context of its communications with the Legacy Service.</p>
        </li>
        <li>
          <p class="" style="">Gateway forwards all subsequent presence stanzas to Legacy Users (except those of type "probe" and those addressed to the Gateway itself).</p>
          <p class="caption">Example 29. Jabber User Modifies Presence</p>
<div class="indent"><pre>
&lt;presence from='romeo@montague.net/orchard'
          to='juliet@aim.shakespeare.lit'&gt;
  &lt;show&gt;dnd&lt;/show&gt;
  &lt;status&gt;Wooing Juliet&lt;/status&gt;
&lt;/presence&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>4.4.2 <a name="usecases-jabber-login-alt">Alternate Flows</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Login fails:
          <ol start="" type="">
            <li>
              <p class="" style="">Gateway sends appropriate presence error to Jabber User (Not Authorized" if password is bad, "Remote Server Timeout" if Legacy Service is down, etc.).</p>
              <p class="caption">Example 30. Gateway Informs Jabber User of Failed Login</p>
<div class="indent"><pre>
&lt;presence to='aim.shakespeare.lit'
          from='romeo@shakespeare.lit'&gt;
  &lt;error code='504' type='wait'&gt;
    &lt;remote-server-timeout
        xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/presence&gt;
              </pre></div>
            </li>
            <li><p class="" style="">Use Case Ends unsuccessfully.</p></li>
          </ol>
        </p></li>
      </ol>
    </div>
  </div>
  <div class="indent">
<h3>4.5 <a name="usecases-jabber-logout">Log Out</a>
</h3>
    <p class="" style="">At any time after logging in to the Gateway, the Jabber User may log out of the Gateway and thereby end his or her session on the Legacy Service. This may happen automatically when the Jabber User terminates his or her session with a Jabber server, or independently of any session on the Jabber network by manually logging out of the Gateway.</p>
    <div class="indent">
<h3>4.5.1 <a name="usecases-jabber-logout-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends unavailable presence broadcast to Server or sends directed presence stanza of type "unavailable" to Gateway or Legacy User.</p>
          <p class="caption">Example 31. Jabber User Sends Unavailable Presence</p>
<div class="indent"><pre>
&lt;presence type='unavailable'/&gt;
          </pre></div>
          <p class="caption">Example 32. Jabber User's Server Broadcasts Unavailable Presence</p>
<div class="indent"><pre>
&lt;presence type='unavailable'
          from='romeo@montague.net/orchard'
          to='aim.shakespeare.lit'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Gateway transforms unavailable presence stanzas received from the Jabber User's server and routes them to all of the Jabber User's contacts on Legacy Service.</p></li>
        <li><p class="" style="">Gateway logs Jabber User out of Legacy Service [A1].</p></li>
        <li>
          <p class="" style="">Gateway sends presence stanza of type "unavailable" to Jabber User.</p>
          <p class="caption">Example 33. Gateway Logs User Out</p>
<div class="indent"><pre>
&lt;presence type='unavailable'
          from='aim.shakespeare.lit'
          to='romeo@montague.net/orchard'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>4.5.2 <a name="usecases-jabber-logout-alt">Alternate Flows</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Legacy Service supports directed presence and Gateway receives presence stanza of type "unavailable" directed to a Legacy User:
          <ol start="" type="">
            <li>
              <p class="" style="">Gateway passes through directed unavailable presence to Legacy User.</p>
              <p class="caption">Example 34. Jabber User Becomes Unavailable</p>
<div class="indent"><pre>
&lt;presence type='unavailable'
          from='romeo@montague.net/orchard'
          to='juliet@aim.shakespeare.lit'/&gt;
              </pre></div>
              </li>
            <li><p class="" style="">Use Case Ends.</p></li>
          </ol>
        </p></li>
      </ol>
    </div>
  </div>
  <div class="indent">
<h3>4.6 <a name="usecases-jabber-addcontact">Add Contact</a>
</h3>
    <p class="" style="">After registering with the Gateway, the Jabber User may want to add Legacy Users to his or her Jabber roster.</p>
    <div class="indent">
<h3>4.6.1 <a name="usecases-jabber-addcontact-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends presence stanza of type "subscribe" to Legacy User.</p>
          <p class="caption">Example 35. Jabber User Sends Subscription Request to Legacy User</p>
<div class="indent"><pre>
&lt;presence type='subscribe'
          from='romeo@montague.net'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;
          </pre></div>
          <p class="" style="">Note: As specified in <span style="font-weight: bold">XMPP IM</span>, sending this packet will result in a "roster push" from the Server to all of the Jabber User's available resources.</p>
        </li>
        <li><p class="" style="">Gateway transforms subscription request and routes it to Legacy User.</p></li>
        <li>
          <p class="" style="">If Legacy User approves subscription request, Gateway sends presence stanza of type "subscribed" to Jabber User on behalf of Legacy User. [A1]</p>
          <p class="caption">Example 36. Gateway Approves Subscription Request on Behalf of Legacy User</p>
<div class="indent"><pre>
&lt;presence type='subscribed'
          from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway sends available presence stanza to Jabber User on behalf of Legacy User.</p>
          <p class="caption">Example 37. Gateway Sends Legacy User's Current Presence Infromation to Jabber User</p>
<div class="indent"><pre>
&lt;presence from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net/orchard'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway sends presence stanza of type "subscribe" to Jabber User on behalf of Legacy User.</p>
          <p class="caption">Example 38. Gateway Sends Subscription Request to Jabber User on Behalf of Legacy User</p>
<div class="indent"><pre>
&lt;presence type='subscribe'
          from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Jabber User sends presence stanza of type "subscribed" to Legacy User.</p>
          <p class="caption">Example 39. Jabber User Approves Subscription Request</p>
<div class="indent"><pre>
&lt;presence type='subscribed'
          from='romeo@montague.net'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>4.6.2 <a name="usecases-jabber-addcontact-alt">Alternate Flows</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Legacy User denies subscription request:</p>
          <ol start="" type="">
            <li>
              <p class="" style="">Gateway transforms subscription denial and routes it to Jabber User.</p>
              <p class="caption">Example 40. Legacy User Denies Subscription Request</p>
<div class="indent"><pre>
&lt;presence type='unsubscribed'
          from='juliet@aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
              </pre></div>
              </li>
            <li><p class="" style="">Use Case Ends unsuccessfully.</p></li>
          </ol>
        </li>
      </ol>
    </div>
  </div>
  <div class="indent">
<h3>4.7 <a name="usecases-jabber-deletecontact">Delete Contact</a>
</h3>
    <p class="" style="">After adding a Legacy User to his or her Jabber roster, the Jabber User may want to delete that contact.</p>
    <div class="indent">
<h3>4.7.1 <a name="usecases-jabber-deletecontact-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends IQ set qualified by the 'jabber:iq:roster' namespace, containing subscription attribute with value of "remove".</p>
          <p class="caption">Example 41. User Removes Roster Entry for Legacy User</p>
<div class="indent"><pre>
&lt;iq type='set'
    from='romeo@montague.net/orchard'
    id='remove1'&gt;
  &lt;query xmlns='jabber:iq:roster'&gt;
    &lt;item jid='CapuletNurse@aim.shakespeare.lit'
          subscription='remove'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Server sends normal "roster push" to Jabber User (see <span style="font-weight: bold">XMPP IM</span>) and sends presence stanzas of type "unsubscribe", "unsubscribed", and "unavailable" to Legacy User.</p>
          <p class="caption">Example 42. Server Sends Presence Changes to Legacy User</p>
<div class="indent"><pre>
&lt;presence type='unsubscribe'
          from='romeo@montague.net'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;

&lt;presence type='unsubscribed'
          from='romeo@montague.net'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;

&lt;presence type='unavailable'
          from='romeo@montague.net/orchard'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Gateway cleans up subscription state, informs Legacy User that Jabber User is unavailable, and MUST NOT send future changes in Jabber User's presence to Legacy User.</p></li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>4.7.2 <a name="usecases-jabber-deletecontact-alt">Alternate Flows</a>
</h3>
      <p class="" style="">None.</p>
    </div>
  </div>
  <div class="indent">
<h3>4.8 <a name="usecases-jabber-send">Send Message</a>
</h3>
    <p class="" style="">Naturally, the Jabber User may want to exchange messages with a Legacy User. For the purposes of this JEP, we discuss one-to-one messaging only (i.e., groupchat messages, such as those defined in <span class="ref" style="">Multi-User Chat</span>  [<a href="#nt-id2257028">5</a>], are out of scope).</p>
    <div class="indent">
<h3>4.8.1 <a name="usecases-jabber-send-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li>
          <p class="" style="">Jabber User sends message stanza to Legacy User.</p>
          <p class="caption">Example 43. Jabber User Sends Message to Legacy User</p>
<div class="indent"><pre>
&lt;message from='romeo@montague.net/orchard'
         to='juliet@aim.shakespeare.lit'
         type='chat'&gt;
  &lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;
&lt;/message&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Gateway transforms message to legacy protocol and sends to Legacy User [A1].</p></li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>4.8.2 <a name="usecases-jabber-send-alt">Alternate Flows</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Legacy Service reports error.</p></li>
        <li>
          <p class="" style="">Gateway sends appropriate error to Jabber User:</p>
          <ul>
            <li><p class="" style="">"Not Found" -- Legacy User address is not valid).</p></li>
            <li><p class="" style="">"Registration Required" -- Jabber User is not registered with Gateway).</p></li>
            <li><p class="" style="">"Service Unavailable" -- Legacy User is offline and Legacy Service does not provide offline message storage).</p></li>
            <li><p class="" style="">"Remote Server Error" -- Legacy Service cannot be reached).</p></li>
          </ul>
          <p class="" style="">For mapping of these error codes to XMPP-compliant error conditions, refer to <span class="ref" style="">Error Condition Mappings</span>  [<a href="#nt-id2257198">6</a>].</p>
        </li>
        <li><p class="" style="">Use Case Ends unsuccessfully.</p></li>
      </ol>
    </div>
  </div>
<h2>5.
       <a name="usecases-legacy">Legacy User Use Cases</a>
</h2>
  <div class="indent">
<h3>5.1 <a name="usecases-legacy-add">Add Contact</a>
</h3>
    <p class="" style="">The Legacy User may want to add the Jabber User to his or her contact list on the Legacy Service. Because the Jabber User has an account on the Legacy Service by definition, the Legacy User will actually add the Jabber User's legacy address to his or her contact list, not the Jabber User's address on the Jabber/XMPP network.</p>
    <div class="indent">
<h3>5.1.1 <a name="usecases-legacy-add-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Legacy User requests subscription to Jabber User (using legacy protocol).</p></li>
        <li>
          <p class="" style="">Gateway sends presence stanza of type "subscribe" to Jabber User on behalf of Legacy User (note: Gateway MUST NOT send presence stanza of type "subscribed").</p>
          <p class="caption">Example 44. Gateway Sends Subscription Request on Behalf of Legacy User</p>
<div class="indent"><pre>
&lt;presence type='subscribe'
          from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Jabber User approves subscription request by sending presence stanza of type "subscribed" to Legacy User [A1].</p>
          <p class="caption">Example 45. Jabber User Approves Subscription Request</p>
<div class="indent"><pre>
&lt;presence type='subscribed'
          from='romeo@montague.net'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Gateway sends Jabber User's presence information to Legacy User.</p></li>
        <li>
          <p class="" style="">Jabber User's Client sends presence stanza of type "subscribe" to Legacy User.</p>
          <p class="caption">Example 46. Jabber User Sends Subscription Request to Legacy User</p>
<div class="indent"><pre>
&lt;presence type='subscribe'
          from='romeo@montague.net'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway sends presence stanza of type "subscribed" to Jabber User on behalf of Legacy User.</p>
          <p class="caption">Example 47. Gateway Approves Subscription Request on Behalf of Legacy User</p>
<div class="indent"><pre>
&lt;presence type='subscribed'
          from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;
          </pre></div>
        </li>
        <li>
          <p class="" style="">Gateway sends Legacy User's presence information to Jabber User.</p>
          <p class="caption">Example 48. Gateway Sends Legacy User's Current Presence Information to Jabber User</p>
<div class="indent"><pre>
&lt;presence from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net/orchard'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>5.1.2 <a name="usecases-legacy-add-alt">Alternate Flows</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Jabber User denies subscription request:
          <ol start="" type="">
            <li>
              <p class="" style="">Jabber User sends presence stanza of type "unsubscribed" to Legacy User.</p>
              <p class="caption">Example 49. Jabber User Denies Subscription Request</p>
<div class="indent"><pre>
&lt;presence type='unsubscribed'
          from='romeo@montague.net'
          to='CapuletNurse@aim.shakespeare.lit'/&gt;
              </pre></div>
            </li>
            <li><p class="" style="">Gateway cleans up subscription state and MUST NOT send Jabber User's presence to Legacy User.</p></li>
            <li><p class="" style="">Use Case Ends unsuccessfully.</p></li>
          </ol>
        </p></li>
      </ol>
    </div>
  </div>
  <div class="indent">
<h3>5.2 <a name="usecases-legacy-delete">Delete Contact</a>
</h3>
    <p class="" style="">After adding the Jabber User to his or her legacy contact list, the Legacy User may want to delete the Jabber User.</p>
    <div class="indent">
<h3>5.2.1 <a name="usecases-legacy-delete-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Legacy User deletes Jabber User (using legacy protocol).</p></li>
        <li>
          <p class="" style="">Gateway sends presence stanzas of type "unsubscribe" and "unsubscribed" to Jabber User on behalf of Legacy User.</p>
          <p class="caption">Example 50. Gateway Cleans Up Subscription on Behalf of Legacy User</p>
<div class="indent"><pre>
&lt;presence type='unsubscribe'
          from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;

&lt;presence type='unsubscribed'
          from='CapuletNurse@aim.shakespeare.lit'
          to='romeo@montague.net'/&gt;

&lt;presence type='unavailable'
          from='CapuletNurse@aim.shakespeare.lit'
          from='romeo@montague.net/orchard'/&gt;
          </pre></div>
        </li>
        <li><p class="" style="">Jabber User's server performs defined functionality for handling presence stanzas of type "unsubscribe" and "unsubscribed" (see <span style="font-weight: bold">XMPP IM</span>).</p></li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>5.2.2 <a name="usecases-legacy-delete-alt">Alternate Flows</a>
</h3>
      <p class="" style="">None.</p>
    </div>
  </div>
  <div class="indent">
<h3>5.3 <a name="usecases-legacy-send">Send Message</a>
</h3>
    <p class="" style="">Naturally, the Legacy User may want to exchange messages with the Jabber User. Here again, groupchat messages are out of scope.</p>
    <div class="indent">
<h3>5.3.1 <a name="usecases-legacy-send-pri">Primary Flow</a>
</h3>
      <ol start="" type="">
        <li><p class="" style="">Legacy User sends message to Jabber User using legacy protocol.</p></li>
        <li>
          <p class="" style="">Gateway transforms message and routes to Jabber User.</p>
          <p class="caption">Example 51. Legacy User Sends Message to Jabber User</p>
<div class="indent"><pre>
&lt;message from='juliet@aim.shakespeare.lit'
         to='romeo@montague.net/orchard'&gt;
  &lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;
&lt;/message&gt;
          </pre></div>
          <p class="" style="">Note: If the Legacy Service to which the Gateway connects does not support a concept equivalent to that of Jabber "resources" as described in <span style="font-weight: bold">XMPP Core</span>, the 'from' address of message stanzas generated by a gateway SHOULD NOT include a resource identifier (i.e., they SHOULD be of the form &lt;user@host&gt; rather than &lt;user@host/resource&gt;). However, the 'from' address MAY include a resource if the Gateway determines that this is appropriate in the context of its communications with the Legacy Service.</p>
        </li>
        <li><p class="" style="">Jabber User's Server delivers message or (optionally) stores it for later retrieval.</p></li>
        <li><p class="" style="">Use Case Ends.</p></li>
      </ol>
    </div>
    <div class="indent">
<h3>5.3.2 <a name="usecases-legacy-send-alt">Alternate Flows</a>
</h3>
      <p class="" style="">None.</p>
    </div>
  </div>
<h2>6.
       <a name="addressing">Addressing</a>
</h2>
  <div class="indent">
<h3>6.1 <a name="addressing-gateway">Gateways</a>
</h3>
    <p class="" style="">The address of a gateway itself SHOULD be a hostname only, and that hostname SHOULD NOT be supplemented with a resource identifier when referring to the gateway's address (e.g., when storing the gateway in a roster). The hostname SHOULD be a subdomain of a primary Jabber host (e.g., icq.jabber.org might be the ICQ gateway run by the jabber.org server).</p>
  </div>
  <div class="indent">
<h3>6.2 <a name="addressing-user">Users</a>
</h3>
    <p class="" style="">Usernames on legacy IM services are not necessarily compatible with Jabber usernames as specified by the Nodeprep profile of stringprep defined in <span class="ref" style="">XMPP Core</span>  [<a href="#nt-id2257764">7</a>], and some legacy services use addresses of the form &lt;user@domain&gt;. Both of these cases must be handled by the Jabber gateway to the relevant service, as well as by the Jabber clients which interact with that gateway. There are two known cases:</p>
    <ol start="" type="">
      <li>AOL screen names used in AIM are allowed to contain spaces, which are illegal in the node identifier portion of a Jabber Identifier</li> 
      <li>MSN addresses used in MSN Messenger are of the form &lt;user@domain&gt;, but the '@' character is illegal in the node identifier portion of a Jabber Identifier.</li>
    </ol>
    <p class="" style="">(There are no known issues with addresses used in legacy services other than AIM and MSN, e.g., ICQ and Yahoo addresses.)</p>
    <p class="" style="">It is RECOMMENDED for client proxy gateways and the clients that interact with such gateways to use the 'jabber:iq:gateway' protocol in order to communicate how to transform legacy addresses into valid JIDs.</p>
    <p class="" style="">The 'jabber:iq:gateway' performs two functions:</p>
    <ol start="" type="">
      <li><p class="" style="">It enables a client to determine the text for the "prompt" to show to a Jabber User when the user wants to add a legacy contact to the user's roster (e.g., "Please enter the AOL Screen Name of the person you would like to contact"), as well as the preferred name for the prompted item (e.g., "Screen Name"). To do so, the client sends an empty &lt;query/&gt; element and the gateway returns a &lt;prompt/&gt; element (the name for the prompted item) and optionally a &lt;desc/&gt; element (the text of the prompt itself).</p></li>
      <li><p class="" style="">It enables a client to send a legacy username to the gateway and receive a properly-formatted JID in return. To do so, the client sends the legacy address to the gateway as the character data of the &lt;prompt/&gt; and the gateway returns a valid JID as the character data of the &lt;jid/&gt; element.</p></li>
    </ol>
    <p class="" style="">Both uses are illustrated below.</p>
    <p class="caption">Example 52. Client Requests Prompt</p>
<div class="indent"><pre>
&lt;iq type='get' to='aim.jabber.org'&gt;
  &lt;query xmlns='jabber:iq:gateway'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 53. Gateway Returns Prompt</p>
<div class="indent"><pre>
  &lt;iq type='result' from='aim.jabber.org'&gt;
    &lt;query xmlns='jabber:iq:gateway'&gt;
      &lt;desc&gt;
        Please enter the AOL Screen Name of the
        person you would like to contact.
      &lt;/desc&gt;
      &lt;prompt&gt;Screen Name&lt;/prompt&gt;
    &lt;/query&gt;
  &lt;/iq&gt;
    </pre></div>
    <p class="" style="">The following table is intended to assist implementors with mapping of gateway identities to English-language prompt names and text.</p>
    <p class="caption">Table 2: Prompt Item Mapping (English)</p>
<table border="1" cellpadding="3" cellspacing="0">
      <tr class="body">
        <th colspan="" rowspan="">Legacy Service</th>
        <th colspan="" rowspan="">Service Discovery Identity</th>
        <th colspan="" rowspan="">Prompt Name</th>
        <th colspan="" rowspan="">Prompt Text</th>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">AOL Instant Messenger</td>
        <td align="" colspan="" rowspan="">gateway/aim</td>
        <td align="" colspan="" rowspan="">AOL Screen Name</td>
	<td align="" colspan="" rowspan="">Please enter the AOL Screen Name of the person you would like to contact.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">ICQ</td>
        <td align="" colspan="" rowspan="">gateway/icq</td>
        <td align="" colspan="" rowspan="">ICQ Number</td>
	<td align="" colspan="" rowspan="">Please enter the ICQ Number of the person you would like to contact.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">MSN Messenger</td>
        <td align="" colspan="" rowspan="">gateway/msn</td>
        <td align="" colspan="" rowspan="">MSN Address</td>
	<td align="" colspan="" rowspan="">Please enter the MSN Address of the person you would like to contact.</td>
      </tr>
      <tr class="body">
        <td align="" colspan="" rowspan="">Yahoo! Instant Messenger</td>
        <td align="" colspan="" rowspan="">gateway/yahoo</td>
        <td align="" colspan="" rowspan="">Yahoo ID</td>
	<td align="" colspan="" rowspan="">Please enter the Yahoo ID of the person you would like to contact.</td>
      </tr>
    </table>
    <p class="" style="">If the client provides an 'xml:lang' attribute with the IQ-get, the gateway SHOULD return localized prompt names and text if available, or default to English if not available.</p>
    <p class="" style="">Once the user enters a legacy username or address, the client MUST send it to the gateway as the character data of the &lt;prompt/&gt; element in an IQ-set; the gateway MUST then return a properly-formed JID based on the provided by the client.</p>
    <p class="caption">Example 54. Client Provides Legacy Username</p>
<div class="indent"><pre>
&lt;iq type='set' to='aim.jabber.org'&gt;
  &lt;query xmlns='jabber:iq:gateway'&gt;
      &lt;prompt&gt;Foo Bar&lt;/prompt&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 55. Gateway Returns JID</p>
<div class="indent"><pre>
&lt;iq type='result' from='aim.jabber.org'&gt;
  &lt;query xmlns='jabber:iq:gateway'&gt;
    &lt;jid&gt;FooBar@aim.jabber.org&lt;/jid&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
<h2>7.
       <a name="rosters">Contact Lists</a>
</h2>
  <p class="" style="">Some legacy services maintain server-side contact lists, which are sent to the gateway when it logs in to the legacy service on behalf of the user. The gateway MAY initiate adding of the legacy contact list items to the user's Jabber roster. Some existing gateways do this by sending a presence stanza of type "subscribed" from the legacy contact's JID (e.g., &lt;LegacyUser@gateway.jabberserver.com&gt;) to the Jabber user; unfortunately, this behavior violates the presence stanza handling rules specified in <span style="font-weight: bold">XMPP IM</span>. Therefore, a gateway SHOULD instead send the legacy contact list items to the Jabber User via the <span class="ref" style="">Roster Item Exchange</span>  [<a href="#nt-id2258186">8</a>] protocol (see JEP-0144 for details).</p>
<h2>8.
       <a name="bizrules">Business Rules</a>
</h2>
  <p class="" style="">The following business rules apply:</p>
  <ol start="" type="">
    <li><p class="" style="">A client SHOULD send a <span style="font-weight: bold">Service Discovery</span> request to the gateway (and/or an <span style="font-weight: bold">Agent Information</span> request to the gateway's parent) before requesting registration information.</p></li>
    <li><p class="" style="">A gateway SHOULD support the <span style="font-weight: bold">Service Discovery</span> protocol.</p></li>
    <li><p class="" style="">A gateway SHOULD support the <span style="font-weight: bold">Agent Information</span> protocol, although it is deprecated.</p></li>
    <li><p class="" style="">A gateway SHOULD map, as best it can, the legacy registration fields onto the fields defined for the 'jabber:iq:register' namespace.</p></li>
    <li><p class="" style="">A gateway SHOULD NOT attempt to emulate offline message storage functionality for legacy services that lack such functionality.</p></li>
    <li>
      <p class="" style="">Existing gateway implementations do not strictly adhere to the bi-directional nature of Jabber presence notifications, since they do not broadcast presence from the gateway itself to registered users of the gateway, but rather wait for a registered user to send presence to the gateway before sending presence to the user. This sidesteps scalability challenges but may be sub-optimal; while this JEP does not require existing gateways to change their current behavior, it does RECOMMEND that they broadcast presence notifications to registered users in accordance with the standard Jabber presence model. Specifically:</p>
      <ul>
        <li><p class="" style="">On startup, a gateway (1) SHOULD send presence to all registered users of that gateway but (2) MAY wait to receive presence changes from each registered user.</p></li>
        <li><p class="" style="">On shutdown, a gateway SHOULD send unavailable presence to all registered users of the gateway.</p></li>
      </ul>
    </li>
  </ol>
<h2>9.
       <a name="security">Security Considerations</a>
</h2>
  <p class="" style="">As defined herein, a gateway is a <span style="font-style: italic">client proxy</span>, since it "masquerades" as a user on a legacy instant messaging service. In order to act as a client proxy, the gateway logs into the user's account on the legacy service. This implies two things:</p>
  <ul>
    <li>The gateway must gather the legacy credentials from the user, and perhaps store them on the user's behalf.</li>
    <li>The gateway must provide the user's credential to the legacy service.</li>
  </ul>
  <p class="" style="">There are obvious security concerns with this approach. The concerns include:</p>
  <ol start="" type="">
    <li>The user's credentials on the legacy service may be sent in the clear from the gateway to the legacy service if the legacy service does not support channel encryption or strong authentication.</li>
    <li>When the user informs the gateway of the user's legacy credentials, the credentials may be sent in the clear between the user's Jabber client and the user's Jabber server (if client-to-server channel encryption is not enabled) or between the user's Jabber server and the gateway (if the gateway is not in the user's "home" domain and server-to-server channel encryption is not enabled).</li>
    <li>If the gateway stores the user's legacy credentials after registration (this is the default behavior of most or all existing gateway implementations), the user's credentials could be acquired by a malicious user if the server hosting the gateway is compromised.</li>
  </ol>
  <p class="" style="">There is no foreseeable solution to these concerns, since they are instrinsic to the client proxy model. Some assurance regarding the second and third concerns can be achieved if the user runs his or her own Jabber server and gateways. However, the only true solution is to move beyond the client proxy model, either by using Jabber for all IM communications or to convince legacy IM services to use open protocols such as Jabber/XMPP, thus making it possible to deploy secure server federation between a legacy service and Jabber/XMPP domains.</p>
<h2>10.
       <a name="iana">IANA Considerations</a>
</h2>
  <p class="" style="">This JEP requires no interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2258458">9</a>].</p>
<h2>11.
       <a name="registrar">Jabber Registrar Considerations</a>
</h2>
  <div class="indent">
<h3>11.1 <a name="registrar-ns">Jabber Registrar Considerations</a>
</h3>
    <p class="" style="">The <span class="ref" style="">Jabber Registrar</span>  [<a href="#nt-id2258509">10</a>] shall include 'jabber:iq:gateway' in its registry of protocol namespaces.</p>
  </div>
<h2>12.
       <a name="schema">XML Schema</a>
</h2>
  <p class="caption"></p>
<div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='jabber:iq:gateway'
    xmlns='jabber:iq:gateway'
    elementFormDefault='qualified'&gt;

  &lt;xs:element name='query'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:choice&gt;
        &lt;xs:sequence
          &lt;xs:element name='desc' minOccurs='0' type='xs:string'/&gt;
          &lt;xs:element name='prompt' type='xs:string'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:element name='jid' type='xs:string'/&gt;
      &lt;/xs:choice&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

&lt;/xs:schema&gt;
  </pre></div>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<p><a name="nt-id2255217">1</a>. JEP-0030: Service Discovery &lt;<a href="http://www.jabber.org/jeps/jep-0030.html">http://www.jabber.org/jeps/jep-0030.html</a>&gt;.</p>
<p><a name="nt-id2255240">2</a>. JEP-0094: Agent Information &lt;<a href="http://www.jabber.org/jeps/jep-0094.html">http://www.jabber.org/jeps/jep-0094.html</a>&gt;.</p>
<p><a name="nt-id2255350">3</a>. JEP-0077: In-Band Registration &lt;<a href="http://www.jabber.org/jeps/jep-0077.html">http://www.jabber.org/jeps/jep-0077.html</a>&gt;.</p>
<p><a name="nt-id2255461">4</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://www.ietf.org/rfc/rfc3921.txt">http://www.ietf.org/rfc/rfc3921.txt</a>&gt;.</p>
<p><a name="nt-id2257028">5</a>. JEP-0045: Multi-User Chat &lt;<a href="http://www.jabber.org/jeps/jep-0045.html">http://www.jabber.org/jeps/jep-0045.html</a>&gt;.</p>
<p><a name="nt-id2257198">6</a>. JEP-0086: Error Condition Mappings &lt;<a href="http://www.jabber.org/jeps/jep-0086.html">http://www.jabber.org/jeps/jep-0086.html</a>&gt;.</p>
<p><a name="nt-id2257764">7</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://www.ietf.org/rfc/rfc3920.txt">http://www.ietf.org/rfc/rfc3920.txt</a>&gt;.</p>
<p><a name="nt-id2258186">8</a>. JEP-0144: Roster Item Exchange &lt;<a href="http://www.jabber.org/jeps/jep-0144.html">http://www.jabber.org/jeps/jep-0144.html</a>&gt;.</p>
<p><a name="nt-id2258458">9</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p>
<p><a name="nt-id2258509">10</a>. The Jabber Registrar maintains a list of reserved Jabber protocol namespaces as well as registries of parameters used in the context of protocols approved by the Jabber Software Foundation. For further information, see &lt;<a href="http://www.jabber.org/registrar/">http://www.jabber.org/registrar/</a>&gt;.</p>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 0.9 (2004-10-27)</h4>
<div class="indent">Added specification of jabber:iq:gateway namespace; added reference to JEP-0144. (psa)
    </div>
<h4>Version 0.8 (2004-05-07)</h4>
<div class="indent">Editorial review: made a number of minor textual changes and clarifications throughout; added introductory paragraph to each use case; specified that groupchat is out of scope. (psa)
    </div>
<h4>Version 0.7 (2004-03-31)</h4>
<div class="indent">Cleaned up several notes, examples, and business rules based on feedback received on list. (psa)
    </div>
<h4>Version 0.6 (2004-03-08)</h4>
<div class="indent">Added note about 'from' address on presence notifications and messages received through gateways from legacy users. (psa)
    </div>
<h4>Version 0.5 (2004-01-21)</h4>
<div class="indent">Further specified the rationale for deprecating the "jabber:iq:gateway" protocol. (psa)
    </div>
<h4>Version 0.4 (2004-01-05)</h4>
<div class="indent">Added Edit Registration use case; modified handling of legacy contact lists to conform to XMPP IM; modified addressing rules; defined gateway startup and shutdown behavior; included XMPP error handling. (psa)
    </div>
<h4>Version 0.3 (2003-12-10)</h4>
<div class="indent">Added security considerations; defined handling of legacy contact lists. (psa)
    </div>
<h4>Version 0.2 (2003-12-03)</h4>
<div class="indent">Corrected some errors; clarified some ambiguities; added protocol flows. (psa)
    </div>
<h4>Version 0.1 (2003-06-25)</h4>
<div class="indent">Initial version. (psa/dss)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
