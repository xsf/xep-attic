<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>JEP-0136: Message Archiving</title>
<link rel="stylesheet" type="text/css" href="jep.css">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="DC.Title" content="Message Archiving">
<meta name="DC.Creator" content="Justin Karneges">
<meta name="DC.Creator" content="Ian Paterson">
<meta name="DC.Creator" content="Jon Perlow">
<meta name="DC.Creator" content="Peter Saint-Andre">
<meta name="DC.Description" content="This document defines mechanisms for server-side archiving of XMPP messages.">
<meta name="DC.Publisher" content="Jabber Software Foundation">
<meta name="DC.Contributor" content="JEP Editor">
<meta name="DC.Date" content="2006-08-18">
<meta name="DC.Type" content="Jabber Enhancement Proposal">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="JEP-0136">
<meta name="DC.Language" content="en">
<meta name="DC.Rights" content="This Jabber Enhancement Proposal is copyright 1999 - 2006 by the Jabber Software Foundation (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;http://www.jabber.org/jsf/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;).">
</head>
<body>
<h1>JEP-0136: Message Archiving</h1>
<p>This document defines mechanisms for server-side archiving of XMPP messages.</p>
<p><hr></p>
<p style="color:red">WARNING: This Standards-Track JEP is Experimental. Publication as a Jabber Enhancement Proposal does not imply approval of this proposal by the Jabber Software Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p>
<p><hr></p>
<h2>JEP Information</h2>
<p class="indent">
            Status: 
            <a href="http://www.jabber.org/jeps/jep-0001.html#states-Experimental">Experimental</a><br>
            Type:
            <a href="http://www.jabber.org/jeps/jep-0001.html#types-Standards%20Track">Standards Track</a><br>
            Number: 0136<br>
            Version: 0.6<br>
            Last Updated: 2006-08-18<br>
            JIG: Standards JIG<br>
                Approving Body: <a href="http://www.jabber.org/council/">Jabber Council</a><br>Dependencies: XMPP Core, XMPP IM, JEP-0030<br>
                Supersedes: None<br>
                Superseded By: None<br>
            Short Name: archive<br>
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Message%20Archiving%20(JEP-0136)">http://wiki.jabber.org/index.php/Message Archiving (JEP-0136)</a>&gt;
            </p>
<h2>Author Information</h2>
<div class="indent">
<h3>Justin Karneges</h3>
<p class="indent">
        Email:
        <a href="mailto:justin@affinix.com">justin@affinix.com</a><br>
        JID: 
        <a href="xmpp:justin@andbit.net">justin@andbit.net</a></p>
<h3>Ian Paterson</h3>
<p class="indent">
        Email:
        <a href="mailto:ian.paterson@clientside.co.uk">ian.paterson@clientside.co.uk</a><br>
        JID: 
        <a href="xmpp:ian@zoofy.com">ian@zoofy.com</a></p>
<h3>Jon Perlow</h3>
<p class="indent">
        Email:
        <a href="mailto:jonp@google.com">jonp@google.com</a><br>
        JID: 
        <a href="xmpp:jonp@google.com">jonp@google.com</a></p>
<h3>Peter Saint-Andre</h3>
<p class="indent">
        Email:
        <a href="mailto:stpeter@jabber.org">stpeter@jabber.org</a><br>
        JID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a></p>
</div>
<h2>Legal Notice</h2>
<p class="indent">This Jabber Enhancement Proposal is copyright 1999 - 2006 by the <a href="http://www.jabber.org/jsf/">Jabber Software Foundation</a> (JSF) and is in full conformance with the JSF's Intellectual Property Rights Policy &lt;<a href="http://www.jabber.org/jsf/ipr-policy.shtml">http://www.jabber.org/jsf/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p>
<h2>Discussion Venue</h2>
<p class="indent">The preferred venue for discussion of this document is the Standards-JIG discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards-jig">http://mail.jabber.org/mailman/listinfo/standards-jig</a>&gt;.</p>
<h2>Relation to XMPP</h2>
<p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the Jabber Software Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this JEP has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p>
<h2>Conformance Terms</h2>
<p class="indent">The following keywords as used in this document are to be interpreted as described in RFC 2119: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p>
<p><hr></p>
<h2>Table of Contents</h2>
<div class="indent"><dl>
<dt>1.  <a href="#intro">Introduction</a>
</dt>
<dt>2.  <a href="#disco">Determining Server Support</a>
</dt>
<dt>3.  <a href="#auto">Automated Archiving</a>
</dt>
<dl>
<dt>3.1.  <a href="#save">Save Mode</a>
</dt>
<dl>
<dt>3.1.1.  <a href="#save-reqs">Requirements</a>
</dt>
<dt>3.1.2.  <a href="#otr-determine">Determining Save Mode States</a>
</dt>
<dt>3.1.3.  <a href="#otr-default">Toggling Default Save Mode State</a>
</dt>
<dt>3.1.4.  <a href="#otr-jid">Toggling Save Mode State for a Contact</a>
</dt>
</dl>
<dt>3.2.  <a href="#otr">Off-the-Record Mode</a>
</dt>
<dl>
<dt>3.2.1.  <a href="#otr-reqs">Requirements</a>
</dt>
<dt>3.2.2.  <a href="#otr-determine">Determining Off-the-Record Mode for a Contact</a>
</dt>
<dt>3.2.3.  <a href="#otr-toggle">Toggling Off-the-Record Mode State for a Contact</a>
</dt>
<dt>3.2.4.  <a href="#otr-message">Sending Message Stanzas</a>
</dt>
</dl>
</dl>
<dt>4.  <a href="#manual">Manual Archiving</a>
</dt>
<dl>
<dt>4.1.  <a href="#manual-req">Requirements</a>
</dt>
<dt>4.2.  <a href="#manual-upload">Uploading Messages to a Collection</a>
</dt>
</dl>
<dt>5.  <a href="#manage">Archive Management</a>
</dt>
<dl>
<dt>5.1.  <a href="#manage-list">Obtaining a List of Collections</a>
</dt>
<dt>5.2.  <a href="#manage-retrieve">Retrieving a Collection</a>
</dt>
<dt>5.3.  <a href="#manage-remove">Removing a Collection</a>
</dt>
</dl>
<dt>6.  <a href="#fileformat">File Format</a>
</dt>
<dt>7.  <a href="#impl">Implementation Notes</a>
</dt>
<dl>
<dt>7.1.  <a href="#impl-bandwidth">Bandwidth Considerations</a>
</dt>
<dt>7.2.  <a href="#impl-karma">Karma Considerations</a>
</dt>
<dt>7.3.  <a href="#impl-sync">Synchronization</a>
</dt>
<dt>7.4.  <a href="#impl-storage">Storage Considerations</a>
</dt>
<dt>7.5.  <a href="#impl-muc">Groupchat Messages</a>
</dt>
</dl>
<dt>8.  <a href="#security">Security Considerations</a>
</dt>
<dl>
<dt>8.1.  <a href="#security-encrypt">Encryption of Archived Messages</a>
</dt>
<dt>8.2.  <a href="#security-store">Store Headers</a>
</dt>
<dt>8.3.  <a href="#security-subject">Subject Attributes</a>
</dt>
</dl>
<dt>9.  <a href="#iana">IANA Considerations</a>
</dt>
<dt>10.  <a href="#registrar">Jabber Registrar Considerations</a>
</dt>
<dl>
<dt>10.1.  <a href="#registrar-ns">Protocol Namespaces</a>
</dt>
<dt>10.2.  <a href="#registrar-features">Service Discovery Features</a>
</dt>
</dl>
<dt>11.  <a href="#schema">XML Schemas</a>
</dt>
<dt><a href="#notes">Notes</a></dt>
<dt><a href="#revs">Revision History</a></dt>
</dl></div>
<p><hr></p>
<h2>1.
       <a name="intro">Introduction</a>
</h2>
  <p class="" style="">Many XMPP clients implement some form of client-side message archiving. However, it is not always convenient or even possible to archive messages locally, e.g., because it is easier to keep all archives in one place (not scattered around on multiple computers or devices) or because the client operates in a web browser or resides on a mobile device that does not have sufficient local storage for message archiving. In addition, server-side archiving makes it possible to offer new services such as integration of IM and email. Therefore it is beneficial to define methods for server-side archiving of XMPP messages.</p>
  <p class="" style="">There are two main approaches to this problem:</p>
  <ol start="1" type="">
    <li>Enable the server (at the client's request) to archive messages as they pass through the server; we call this automated archiving.</li>
    <li>Enable the client to send individual messages or entire conversations to the server for archiving (optionally after encryption); we call this manual archiving.</li>
  </ol>
  <p class="" style="">So that client and server developers can refer to one specification, both approaches are defined in this document. In addition, this document defines common methods for retrieving archived messages.</p>
<h2>2.
       <a name="disco">Determining Server Support</a>
</h2>
  <p class="" style="">A client discovers whether its server supports this protocol using <span class="ref" style="">Service Discovery</span>  [<a href="#nt-id2250871">1</a>].</p>
  <p class="caption">Example 1. Client Service Discovery request</p>
<div class="indent"><pre>
    
&lt;iq type='get' to='montague.net'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
</pre></div>
  <p class="" style="">For each feature defined herein, if the server supports that feature it MUST return a &lt;feature/&gt; element with the 'var' attribute set to 'http://jabber.org/protocol/archive#name', where "name" is "save" for the <a href="#save">Save Mode</a> feature, "otr" for the <a href="#otr">Off-the-Record Mode</a> feature, "manual" for the <a href="#manual">Manual Archiving</a> feature, or "manage" for the <a href="#manage">Archive Management</a> feature.</p>
  <p class="caption">Example 2. Server Service Discovery response</p>
<div class="indent"><pre>
    
&lt;iq type='result'
    from='montague.net'
    to='romeo@montague.net/orchard'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/archive#manage'/&gt;
    &lt;feature var='http://jabber.org/protocol/archive#manual'/&gt;
    &lt;feature var='http://jabber.org/protocol/archive#otr'/&gt;
    &lt;feature var='http://jabber.org/protocol/archive#save'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
</pre></div>
<h2>3.
       <a name="auto">Automated Archiving</a>
</h2>
  <p class="" style="">There are two features related to automated archiving:</p>
  <ol start="1" type="">
    <li>Being able to turn on and turn off automated archiving; this is called "Save Mode".</li>
    <li>Being able to take certain conversations (or conversations with certain contacts) "off-the-record" for both the user and the contact with whom the user is chatting (i.e., neither party's server shall archive the conversation); this is called "Off-the-Record Mode".</li>
  </ol>
  <p class="" style="">Requirements and protocol flows for these features are defined below.</p>
  <div class="indent">
<h3>3.1 <a name="save">Save Mode</a>
</h3>
    <div class="indent">
<h3>3.1.1 <a name="save-reqs">Requirements</a>
</h3>
      <p class="" style="">Automated server-side archiving of XMPP messages eases the burden on clients. However, not all users may want to archive messages on the server. Therefore, a client should be able to toggle archiving (here referred to as Save Mode) on a default basis (i.e., specify whether by default all conversations are to be saved on the server or not). In addition, a user may want to override the default setting for a particular contact. Therefore this document addresses the following requirements for Save Mode:</p>
      <ol start="1" type="">
        <li>A user must be able to toggle default Save Mode.</li>
        <li>A user must be able to determine the current default Save Mode.</li>
        <li>A user should be able to toggle Save Mode for a particular contact.</li>
        <li>A user should be able to determine the current Save Mode for particular contacts.</li>
      </ol>
    </div>
    <div class="indent">
<h3>3.1.2 <a name="otr-determine">Determining Save Mode States</a>
</h3>
      <p class="" style="">In order to determine the current Save Mode states both for the default and for particular contacts, a user sends a query to the user's server:</p>
      <p class="caption">Example 3. Client Requests Save Mode States</p>
<div class="indent"><pre>
&lt;iq type='get' id='save1' from='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The server sends the Save Mode state(s) to the user.</p>
      <p class="" style="">The state may be set only for the default.</p>
      <p class="caption">Example 4. Server Returns Save Mode States</p>
<div class="indent"><pre>
&lt;iq type='result' id='save1' to='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='true'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">If the user has never set the save mode, the value of the 'save' attribute SHOULD be "unset" and the server SHOULD include a 'service' attribute that specifies the default service-wide setting (either "true" or "false").</p>
      <p class="caption">Example 5. Server Returns Save Mode State With Service Default</p>
<div class="indent"><pre>
&lt;iq type='result' id='save1' to='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='unset' service='false'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The state may also include settings for particular contacts.</p>
      <p class="caption">Example 6. Client Requests Save Mode States</p>
<div class="indent"><pre>
&lt;iq type='result' id='save1' to='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='true'/&gt;
    &lt;item jid='romeo@montague.net' save='false'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The server also remembers that the requesting resource is "save-mode aware" and will broadcast it any changes in the Save Mode state.</p>
      <p class="" style="">Note: It is STRONGLY RECOMMENDED for the value of the 'jid' attribute to be a bare JID (&lt;node@domain.tld&gt;).</p>
    </div>
    <div class="indent">
<h3>3.1.3 <a name="otr-default">Toggling Default Save Mode State</a>
</h3>
      <p class="" style="">A user may toggle the default Save Mode state by updating the setting:</p>
      <p class="caption">Example 7. Client Toggles Default Save Mode State</p>
<div class="indent"><pre>
&lt;iq type='set' id='save2' from='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='true'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">If the server can process the request, it acknowledges the change:</p>
      <p class="caption">Example 8. Server Acknowledges Change</p>
<div class="indent"><pre>
&lt;iq type='result' id='save2' to='juliet@capulet.com/chamber'/&gt;
      </pre></div>
      <p class="" style="">The server then MUST inform all of the user's connected resources:</p>
      <p class="caption">Example 9. Server Pushes New Save Mode State</p>
<div class="indent"><pre>
&lt;iq type='set' id='savepush1' to='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='true'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;

&lt;iq type='set' id='savepush2' to='juliet@capulet.com/pda'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;default save='true'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">Note: Error cases to follow.</p>
    </div>
    <div class="indent">
<h3>3.1.4 <a name="otr-jid">Toggling Save Mode State for a Contact</a>
</h3>
      <p class="" style="">A user may toggle the Save Mode state for a particular contact by updating the setting:</p>
      <p class="caption">Example 10. Client Toggles Save Mode State for a Contact</p>
<div class="indent"><pre>
&lt;iq type='set' item='save3' from='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;item jid='romeo@montague.net' save='false'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">If the server can process the request, it acknowledges the change:</p>
      <p class="caption">Example 11. Server Acknowleges Change</p>
<div class="indent"><pre>
&lt;iq type='result' id='save3' to='juliet@capulet.com/chamber'/&gt;
      </pre></div>
      <p class="" style="">The server then MUST inform all of the user's connected resources:</p>
      <p class="caption">Example 12. Server Pushes New Save Mode State</p>
<div class="indent"><pre>
&lt;iq type='set' id='savepush3' to='juliet@capulet.com/chamber'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;item jid='romeo@montague.net' save='false'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;

&lt;iq type='set' id='savepush4' to='juliet@capulet.com/pda'&gt;
  &lt;save xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;item jid='romeo@montague.net' save='false'/&gt;
  &lt;/save&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">Note: Error cases to follow.</p>
    </div>
  </div>
  <div class="indent">
<h3>3.2 <a name="otr">Off-the-Record Mode</a>
</h3>
    <div class="indent">
<h3>3.2.1 <a name="otr-reqs">Requirements</a>
</h3>
      <p class="" style="">Even if a user does not save chat conversations with a particular contact, the user may also want to request that the contact also not save their chat conversations; this is in effect a shared off-the-record state that can be enabled and disabled by either user. Therefore, a client should be able to take a chat "off the record" by requesting use of the Off-the-Record Mode with that contact. Therefore this document addresses the following requirements for Off-the-Record Mode:</p>
      <ol start="1" type="">
        <li>A user must be able to determine the current Off-the-Record Mode for a particular contact.</li>
        <li>A user must be able to toggle Off-the-Record Mode for a particular contact.</li>
        <li>The user's server must be able to inform the contact's server of any change in the Off-the-Record Mode (from true to false or from false to true).</li>
        <li>The contact's server must toggle the state appropriately on request and inform the contact's resources.</li>
        <li>If the servers get out of sync regarding the Off-the-Record Mode state, they must be able to quickly converge again.</li>
      </ol>
      <p class="" style="">Note: a similar Off-the-Record Mode for <span class="ref" style="">Multi-User Chat</span>  [<a href="#nt-id2260143">2</a>] conversations is out of scope.</p>
      <p class="" style="">It is understood that at this time most clients will not be compatible with this document. It is expected that clients and servers will adopt this specification over time. Servers that save chats in a server-side store should implement this specification as soon as possible since server-side archiving of messages is more sensitive than client-side archiving.</p>
      <p class="" style=""><span class="ref" style="">Stanza Headers and Internet Metadata</span>  [<a href="#nt-id2260190">3</a>] introduces the Store header, which indicates whether the stanza may be stored or archived by the recipient. This is a partial solution to the problem we're trying to solve. First, it doesn't create a way for the two users to negotiate whether a chat conversation can be saved. Second, it only applies to the recipient of a chat, not the recipient's server. In real world scenarios, we want to make sure that the recipient's server also respects the negotiation of Off-the-Record Mode between the two parties.</p>
    </div>
    <div class="indent">
<h3>3.2.2 <a name="otr-determine">Determining Off-the-Record Mode for a Contact</a>
</h3>
      <p class="" style="">The user (romeo@montague.net) wishes to find out which contacts have Off-the-Record Mode enabled. This process is very similar to how roster requests, updates, and broadcasts work.</p>
      <p class="caption">Example 13. Client Requests the Off-the-Record Mode States</p>
<div class="indent"><pre>
&lt;iq type='get' id='otr1' from='romeo@montague.net/castle'&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The server responds with the list of contacts whose Off-the-Record Mode state is "true". The &lt;record/&gt; element SHOULD include a 'source' attribute that specifies which entity set the Off-the-Record mode.</p>
      <p class="caption">Example 14. Server Returns Off-the-Record Mode States</p>
<div class="indent"><pre>
&lt;iq type='result' id='otr1' to='juliet@capulet.com/chamber'&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;record jid='priest@church.org' otr='true' source='juliet@capulet.com'/&gt;
  &lt;/otr&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The server also remembers that the requesting resource is now "OTR aware" and will broadcast it any changes in the OTR states. </p>
      <p class="" style="">Note: Error cases to follow.</p>
    </div>
    <div class="indent">
<h3>3.2.3 <a name="otr-toggle">Toggling Off-the-Record Mode State for a Contact</a>
</h3>
      <p class="" style="">The user (juliet@capulet.com) wishes to enter Off-the-Record Mode with contact (romeo@montague.net).</p>
      <p class="caption">Example 15. Client Enters Off-the-Record Mode</p>
<div class="indent"><pre>
&lt;iq type='set' id='otr2' from='juliet@capulet.com/chamber'&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;record jid='romeo@montague.net' otr='true' source='juliet@capulet.com'/&gt;
  &lt;/otr&gt;
/iq&gt;
      </pre></div>
      <p class="" style="">The user's server (capulet.com) updates its state so that chats with romeo@montague.net are not saved. It also informs the contact's server that chats with Juliet are not to be saved (this is done by sending an IQ-set from the user's bare JID to the user's bare JID; these IQs are handled by the servers rather than any connected clients).</p>
      <p class="caption">Example 16. User's Server Informs Contact's Server of Change</p>
<div class="indent"><pre>
&lt;iq type='set' from='juliet@capulet.com' to='romeo@montague.net' id='notify1'&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;record otr='true' source='juliet@capulet.com'/&gt;
  &lt;/otr&gt;
&lt;/iq&gt;

&lt;iq type='result' from='romeo@montague.net' to='juliet@capulet.com' id='notify1'/&gt;
      </pre></div>
      <p class="" style="">The user's server also broadcasts to all of the user's otr-aware resources that the state has changed:</p>
      <p class="caption">Example 17. OTR Broadcast to User</p>
<div class="indent"><pre>
&lt;iq type='set' to='juliet@capulet.com/chamber' id='update1'&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;record jid='romeo@montague.net' otr='true' source='juliet@capulet.com'/&gt;
  &lt;/otr&gt;
&lt;/iq&gt;

&lt;iq type='set' to='juliet@capulet.com/pda' id='update2'&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;record jid='romeo@montague.net' otr='true' source='juliet@capulet.com'/&gt;
  &lt;/otr&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">The user's server then sends the result for the IQ-set.</p>
      <p class="caption">Example 18. IQ Result</p>
<div class="indent"><pre>
&lt;iq type='result' id='otr2' to='juliet@capulet.com/chamber'&gt;
      </pre></div>
      <p class="" style="">The contact's server receives the notification, swaps the JIDs in the &lt;record/&gt; element, and broadcasts the change to all of the contact's otr-aware resources:</p>
      <p class="caption">Example 19. OTR Broadcast for Contact</p>
<div class="indent"><pre>
&lt;iq type='set' to='romeo@montague.net/orchard' id='update3'&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;record jid='juliet@capulet.com' otr='true' source='juliet@capulet.com'/&gt;
  &lt;/otr&gt;
&lt;/iq&gt;
      </pre></div>
      <p class="" style="">Note: Error cases to follow.</p>
      <p class="" style="">Some deployments (especially in enterprise settings) are required to archive all messages sent through the server, for example to comply with various government regulations. Such a deployment MUST return a &lt;not-allowed/&gt; error in response to a request to enter Off-the-Record mode and SHOULD stamp all message stanzas with &lt;record otr='false'/&gt;.</p>
    </div>
    <div class="indent">
<h3>3.2.4 <a name="otr-message">Sending Message Stanzas</a>
</h3>
      <p class="" style="">The archiving-aware server stamps all messages with the current OTR state as demonstrated by the following examples. This allows servers that become out of sync to update each other on the current state as soon as a message is sent.</p>
      <p class="" style="">Rome sends a message to Juliet.</p>
      <p class="caption">Example 20. Client sends a normal text message</p>
<div class="indent"><pre>
&lt;message from='romeo@montague.net/home' to='juliet@capulet.com'&gt;
  &lt;body&gt;Juliet, can you sneak out tonight?&lt;/body&gt;
&lt;/message&gt;
      </pre></div>
      <p class="" style="">(Optionally the sender's client MAY also include the SHIM Store header.)</p>
      <p class="" style="">Romeo's server adds an element to the message stanza indicating the current Off-the-Record Mode state before routing it to Juliet's server.</p>
      <p class="caption">Example 21. Server stamps message with current Off-the-Record Mode state.</p>
<div class="indent"><pre>
&lt;message from='romeo@montague.net/home' to='juliet@capulet.com'&gt;
  &lt;body&gt;Juliet, can you sneak out tonight?&lt;/body&gt;
  &lt;otr xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;record otr='true' source='juliet@capulet.com'/&gt;
  &lt;/otr&gt;
&lt;/message&gt;
      </pre></div>
      <p class="" style="">When the contact's server receives the message, it MAY compare the user's Off-the-Record Mode state with its own Off-the-Record Mode state for the contact. If the two states are out of sync, it SHOULD update its state and broadcast an updated IQ set to the contact's connected resources.</p>
    </div>
  </div>
<h2>4.
       <a name="manual">Manual Archiving</a>
</h2>
  <div class="indent">
<h3>4.1 <a name="manual-req">Requirements</a>
</h3>
    <p class="" style="">While automated archiving is easy for the client and server to implement, there are contexts in which automated archiving is unacceptable (e.g., because the client does not trust the server) or unworkable (e.g., when messages are encrypted using evanscent keys, as in <span class="ref" style="">Encrypted Sessions</span>  [<a href="#nt-id2260578">4</a>]). Therefore, often a client will want to receive a message, optionally process it (e.g., encrypt it), then ask the server to store the message.</p>
    <p class="" style="">Such messages SHOULD be stored in the form of a "collection", i.e., a set of messages from the same user that are received near each other in time. A collection is intended to mimic the natural flow of human conversations, which in instant messaging (IM) systems tend to occur in bursts (e.g., a five-minute conversation one day, followed by a ten-minute conversation the next). However, sometimes IM message exchange does not follow this conversational pattern; in that case, collections SHOULD be arbitrarily truncated so that transferring them does not violate common rate limiting restrictions (in Jabber systems, often called "karma") or memory limitations for constrained devices.</p>
    <p class="" style="">Messages are stored in message collections on the server. The client uniquely specifies a collection using the pair of attributes: 'with' (the bare JID with which the messages were exchanged) and 'start' (the UTC start time of the conversation thread, which MUST adhere to the DateTime format specified in <span class="ref" style="">Jabber Date and Time Profiles</span>  [<a href="#nt-id2260606">5</a>]).</p>
    <p class="" style="">The content of each individual message MUST be encapsulated in a &lt;to/&gt; or &lt;from/&gt; element. The time in seconds of the message relative to the start-time of the collection SHOULD be specified with a 'secs' attribute. The content SHOULD include a &lt;body/&gt; element. Other elements MAY be included, but they are NOT RECOMMENDED. To conserve bandwidth and storage space, elements qualified by the 'http://jabber.org/protocol/xhtml-im' namespace SHOULD NOT be included. &lt;thread/&gt; elements and elements qualified by the 'jabber:x:delay', 'jabber:x:event' and 'http://jabber.org/protocol/chatstates' namespaces MUST NOT be included.</p>
    <p class="" style="">Complying with <span style="font-weight: bold">XMPP Core</span>, the server MUST respond to all &lt;iq/&gt; element of type 'get' or 'set'. However, most successful responses have been omitted from this document in the interest of conciseness.</p>
    <p class="" style="">All times MUST be set to UTC.</p>
  </div>
  <div class="indent">
<h3>4.2 <a name="manual-upload">Uploading Messages to a Collection</a>
</h3>
    <p class="" style="">The messages to be uploaded are encapsulated in the &lt;store/&gt; element.</p>
    <p class="caption">Example 22. Storing messages in a collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='up1'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'&gt;
    &lt;from secs='0'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the collection does not exist then the server MUST create a new collection. If the collection already exists then the server MUST append the messages to the existing collection.</p>
    <p class="" style="">A friendly name for the collection MAY be specified with a 'subject' attribute. If the collection already has a 'subject' then it is simply replaced. Note the <a href="#security-subject">Security Considerations</a> regarding the subject attribute.</p>
    <p class="caption">Example 23. Successful reply</p>
<div class="indent"><pre>
&lt;iq type='result' to='romeo@montague.net/orchard' id='up1'/&gt;
    </pre></div>
    <p class="" style="">If the server cannot service a store request because the collection is too large then it MUST return a &lt;not-acceptable/&gt; error:</p>
    <p class="caption">Example 24. Unsuccessful reply</p>
<div class="indent"><pre>
&lt;iq type='error' to='romeo@montague.net/orchard'&gt;
  &lt;error code='406' type='modify'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The client MAY specify an absolute time for any message by providing a longer 'utc' attribute instead of a 'secs' attribute:</p>
    <p class="caption">Example 25. Storing offline messages in a collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='up2'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'&gt;
    &lt;from utc='1469-07-21T00:32:29Z'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
<h2>5.
       <a name="manage">Archive Management</a>
</h2>
  <p class="" style="">There are three main areas of functionality related to management of saved or uploaded archives:</p>
  <ol start="1" type="">
    <li>Obtaining a list of collections.</li>
    <li>Retrieving a collection.</li>
    <li>Removing a collection.</li>
  </ol>
  <p class="" style="">Requirements and protocol flows for these use cases are defined below.</p>
  <div class="indent">
<h3>5.1 <a name="manage-list">Obtaining a List of Collections</a>
</h3>
    <p class="" style="">To request a list of collections the client sends an empty &lt;list/&gt; element. The 'start' and 'end' attributes MAY be specified to indicate a date range (the values of these attributes MUST adhere to the DateTime format specified in <span style="font-weight: bold">JEP-0082</span>).</p>
    <p class="" style="">If the 'with' attribute is omitted then collections with any JID are returned. If only 'start' is specified then all collections on or after that date should be returned. If only 'end' is specified then all collections prior to that date should be returned.</p>
    <p class="caption">Example 26. Requesting a list</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        with='juliet@capulet.com'
        start='1469-07-21T02:00:00Z'
        end='1479-07-21T04:00:00Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 27. Requesting a list of all collections with a JID</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        with='juliet@capulet.com'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The client MAY limit the number of items returned by the server with the 'maxitems' attribute.</p>
    <p class="caption">Example 28. Requesting a list of all collections</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'
        maxitems='50'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The collections (empty &lt;store/&gt; elements) in the result MUST be listed in chronological order.</p>
    <p class="caption">Example 29. Receiving a list</p>
<div class="indent"><pre>
&lt;iq type='result' id='a1' to='romeo@montague.net/orchard'&gt;
  &lt;list xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;store with='juliet@capulet.com'
           start='1469-07-21T02:56:15Z'
           subject='She speaks!'/&gt;
    &lt;store with='balcony@house.capulet.com'
           start='1469-07-21T03:16:37Z'/&gt;
    ...
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the requested list would be too long to return in its entirety without exceeding karma limits (or any other limit specified by an administrator), then the server SHOULD only return the first part of the list. In this case the server MUST indicate that the list is incomplete by setting the optional 'partial' attribute of the &lt;list/&gt; element to 'true'.</p>
    <p class="caption">Example 30. Receiving a partial list</p>
<div class="indent"><pre>
&lt;iq type='result' id='a1' to='romeo@montague.net/orchard'&gt;
  &lt;list partial='true' xmlns='http://jabber.org/protocol/archive'&gt;
    &lt;store with='juliet@capulet.com'
           start='1469-07-21T02:56:15Z'
           subject='She speaks!'/&gt;
    &lt;store with='balcony@house.capulet.com'
           start='1469-07-21T03:16:37Z'/&gt;
    ...
  &lt;/list&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If it has received a partial list, the client MAY then request the remainder of the list, taking care to set the value of the 'start' attribute to one second after the time of the last collection in the partial list that it received.</p>
  </div>
  <div class="indent">
<h3>5.2 <a name="manage-retrieve">Retrieving a Collection</a>
</h3>
    <p class="" style="">The client sends an empty &lt;retrieve/&gt; element to request the download of a collection:</p>
    <p class="caption">Example 31. Requesting a collection</p>
<div class="indent"><pre>
&lt;iq type='get' to='montague.net' id='down1'&gt;
  &lt;retrieve xmlns='http://jabber.org/protocol/archive'
            with='juliet@capulet.com'
            start='1469-07-21T02:56:15Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 32. Receiving a collection</p>
<div class="indent"><pre>
&lt;iq type='result' to='montague.net'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'&gt;
    &lt;from secs='0'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the collection does not exist then the server MUST return an &lt;item-not-found/&gt; error:</p>
    <p class="caption">Example 33. Unsuccessful reply</p>
<div class="indent"><pre>
&lt;iq type='error' to='romeo@montague.net/orchard'&gt;
  &lt;error code='404' type='cancel'&gt;
    &lt;item-not-found xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the collection would be too long to return in its entirety without exceeding karma limits (or any other limit specified by an administrator), then the server SHOULD return only the first part of the collection. In this case the server MUST indicate that the collection is incomplete by setting the optional 'partial' attribute of the &lt;list/&gt; element to 'true'.</p>
    <p class="caption">Example 34. Receiving a partial collection</p>
<div class="indent"><pre>
&lt;iq type='result' id='a1' to='romeo@montague.net/orchard'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         partial='true'
         start='1469-07-21T02:56:15Z'
         subject='She speaks!'
         with='juliet@capulet.com'&gt;
    &lt;from secs='0'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If it has received a partial collection, the client MAY then request the remainder of the collection, taking care to set the value of the 'start' attribute to one second after the time of the last &lt;from/&gt; or &lt;to/&gt; element in the partial collection that it received.</p>
  </div>
  <div class="indent">
<h3>5.3 <a name="manage-remove">Removing a Collection</a>
</h3>
    <p class="" style="">To request the removal of a collection the client sends an empty &lt;remove/&gt; element.</p>
    <p class="caption">Example 35. Removing a single collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          with='juliet@capulet.com'
          start='1469-07-21T02:56:15Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the collection does not exist then the server MUST return a Not Found error:</p>
    <p class="caption">Example 36. Unsuccessful reply</p>
<div class="indent"><pre>
&lt;iq type='error' to='romeo@montague.net/orchard'&gt;
  &lt;error code='404' type='cancel'&gt;
    &lt;item-not-found xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The client may remove several collections at once. The 'start' and 'end' elements MAY be specified to indicate a date range.</p>
    <p class="caption">Example 37. Removing all collections with a specified JID between two times</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          with='juliet@capulet.com'
          start='1469-07-21T02:00:00Z'
          end='1469-07-21T04:00:00Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the 'with' attribute is omitted then collections with any JID are removed.</p>
    <p class="" style="">If the end date is in the future then then all collections after the start date are removed.</p>
    <p class="caption">Example 38. Removing all collections after a date</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          start='1469-07-21T02:00:00Z'
          end='2038-01-01T00:00:00Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the start date is before all the collections in the archive then all collections prior to the end date are removed.</p>
    <p class="caption">Example 39. Removing all collections before a date</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'
          start='0000-01-01T00:00:00Z'
          end='1469-07-21T04:00:00Z'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="caption">Example 40. Removing all collections</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net'&gt;
  &lt;remove xmlns='http://jabber.org/protocol/archive'/&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
<h2>6.
       <a name="fileformat">File Format</a>
</h2>
  <p class="" style="">So that clients can share archived messages, this document specifies a common format for storage on disk (similar to email formats like mbox and Maildir). The file format uses the same XML constructs as the protocol. Each file may contain messages exchanged with a single JID. Any number of items may be stored in an archive file.</p>
  <p class="caption">Example 41. Example file</p>
<div class="indent"><pre>
&lt;?xml version='1.0'?&gt;
&lt;archive xmlns='http://jabber.org/protocol/archive'
         with='juliet@capulet.com'&gt;
  &lt;store start='1469-07-21T02:56:15Z' subject='She speaks!'&gt;
    &lt;from secs='0'&gt;&lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;&lt;/from&gt;
    &lt;to secs='11'&gt;&lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;&lt;/to&gt;
    &lt;from secs='14'&gt;&lt;body&gt;How cam'st thou hither, tell me, and wherefore?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/archive&gt;
  </pre></div>
<h2>7.
       <a name="impl">Implementation Notes</a>
</h2>
  <div class="indent">
<h3>7.1 <a name="impl-bandwidth">Bandwidth Considerations</a>
</h3>
    <p class="" style="">When uploading messages using manual archiving, a client SHOULD NOT store one message at a time on the server since this increases both bandwidth consumption and the total number of transactions. It is instead RECOMMENDED that clients store messages only when the conversation thread appears to be terminated, i.e. when the user closes the chat window. If the user reopens the window and the thread continues then the client should append the new messages to the collection when the user closes the window again.</p>
  </div>
  <div class="indent">
<h3>7.2 <a name="impl-karma">Karma Considerations</a>
</h3>
    <p class="" style="">When appending messages to a collection clients SHOULD try to ensure that the total size of the collection will not exceed karma limits when it is retrieved later. This may be achieved by starting a new collection whenever a message thread becomes too long.</p>
  </div>
  <div class="indent">
<h3>7.3 <a name="impl-sync">Synchronization</a>
</h3>
    <p class="" style="">It is RECOMMENDED for the client synchronize all the times it sends to the server with server time. The client can achieve this using <span class="ref" style="">Entity Time</span>  [<a href="#nt-id2261302">6</a>] to estimate the difference between the server and client clocks.</p>
  </div>
  <div class="indent">
<h3>7.4 <a name="impl-storage">Storage Considerations</a>
</h3>
    <p class="" style="">Server implementations SHOULD give system administrators the option to disable support for both automated and manual archiving, since archived conversations can consume significant storage space.</p>
  </div>
  <div class="indent">
<h3>7.5 <a name="impl-muc">Groupchat Messages</a>
</h3>
    <p class="" style="">A client MAY archive messages that it receives in the context of <span class="ref" style="">Multi-User Chat</span>  [<a href="#nt-id2261349">7</a>] rooms. The client SHOULD include a 'name' attribute to specify the room nickname of all messages:</p>
    <p class="caption">Example 42. Storing groupchat messages in a collection</p>
<div class="indent"><pre>
&lt;iq type='set' to='montague.net' id='up3'&gt;
  &lt;store xmlns='http://jabber.org/protocol/archive'
         with='balcony@house.capulet.com'
         start='1469-07-21T03:16:37Z'&gt;
    &lt;from secs='0' name='benvolio'&gt;&lt;body&gt;She will indite him to some supper.&lt;/body&gt;&lt;/from&gt;
    &lt;from secs='5' name='mercutio'&gt;&lt;body&gt;A bawd, a bawd, a bawd! So ho!&lt;/body&gt;&lt;/from&gt;
    &lt;from secs='11' name='romeo'&gt;&lt;body&gt;What hast thou found?&lt;/body&gt;&lt;/from&gt;
  &lt;/store&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
<h2>8.
       <a name="security">Security Considerations</a>
</h2>
  <div class="indent">
<h3>8.1 <a name="security-encrypt">Encryption of Archived Messages</a>
</h3>
    <p class="" style="">Because a server can be compromised, it is RECOMMENDED to encrypt archived messages. Methods for doing so are under development and will be specified in a separate document or in a new section of this document.</p>
  </div>
  <div class="indent">
<h3>8.2 <a name="security-store">Store Headers</a>
</h3>
    <p class="" style="">The client that originates a message MAY specify a 'false' value for the 'store' header (see <span class="ref" style="">Stanza Headers and Internet Metadata</span>  [<a href="#nt-id2261425">8</a>]). The recipient MUST NOT archive such a message or any of the information it contains. If the sender plans to use 'store' headers it MUST use Service Discovery to determine whether or not the recipient supports them. If not, the sender MUST warn its human user (if any) before sending the message.</p>
  </div>
  <div class="indent">
<h3>8.3 <a name="security-subject">Subject Attributes</a>
</h3>
    <p class="" style="">Since the subject of each collection is not encrypted, the client MUST warn its human user (if any) before including 'subject' attributes on encrypted collections.</p>
  </div>
<h2>9.
       <a name="iana">IANA Considerations</a>
</h2>
  <p class="" style="">No interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2261506">9</a>] is required as a result of this JEP.</p>
<h2>10.
       <a name="registrar">Jabber Registrar Considerations</a>
</h2>
  <div class="indent">
<h3>10.1 <a name="registrar-ns">Protocol Namespaces</a>
</h3>
    <p class="" style="">The <span class="ref" style="">Jabber Registrar</span>  [<a href="#nt-id2261557">10</a>] shall include 'http://jabber.org/protocol/archive' in its registry of protocol namespaces (see &lt;<a href="http://www.jabber.org/registrar/namespaces.html">http://www.jabber.org/registrar/namespaces.html</a>&gt;):</p>
  </div>
  <div class="indent">
<h3>10.2 <a name="registrar-features">Service Discovery Features</a>
</h3>
    <p class="" style="">The Jabber Registrar shall include the following features in its registry of service discovery features (see &lt;<a href="http://www.jabber.org/registrar/disco-features.html">http://www.jabber.org/registrar/disco-features.html</a>&gt;):</p>
    <ul>
      <li>http://jabber.org/protocol/archive#manage</li>
      <li>http://jabber.org/protocol/archive#manual</li>
      <li>http://jabber.org/protocol/archive#otr</li>
      <li>http://jabber.org/protocol/archive#save</li>
    </ul>
  </div>
<h2>11.
       <a name="schema">XML Schemas</a>
</h2>
  <p class="caption"></p>
<div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://jabber.org/protocol/archive'
    xmlns='http://jabber.org/protocol/archive'
    elementFormDefault='qualified'&gt;

  &lt;xs:annotation&gt;
    &lt;xs:documentation&gt;
      The allowable root element for the namespace defined
      herein are:
        - archive
        - list
        - otr
        - remove
        - retrieve
        - save
        - store
    &lt;/xs:documentation&gt;
  &lt;/xs:annotation&gt;

  &lt;xs:element name='archive'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='store' minOccurs='1' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
      &lt;xs:attribute name='with' type='xs:string' use='optional'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='list'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='store' minOccurs='0' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
      &lt;xs:attribute name='end' type='xs:dateTime' use='optional'/&gt;
      &lt;xs:attribute name='maxitems' type='xs:positiveInteger' use='optional'/&gt;
      &lt;xs:attribute name='partial' type='xs:boolean' use='optional'/&gt;
      &lt;xs:attribute name='start' type='xs:dateTime' use='optional'/&gt;
      &lt;xs:attribute name='with' type='xs:string' use='optional'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='otr'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='record' minOccurs='0' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='record'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='jid' use='optional' type='xs:string'/&gt;
          &lt;xs:attribute name='otr' use='required' type='xs:boolean'/&gt;
          &lt;xs:attribute name='source' use='optional' type='xs:string'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='remove'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='end' type='xs:dateTime' use='optional'/&gt;
          &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
          &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='retrieve'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
          &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='save'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element ref='default' minOccurs='0' maxOccurs='1'/&gt;
        &lt;xs:element ref='item' minOccurs='0' maxOccurs='unbounded'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='store'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:choice maxOccurs='unbounded'&gt;
        &lt;xs:element name='from' type='messageType'/&gt;
        &lt;xs:element name='to' type='messageType'/&gt;
      &lt;/xs:choice&gt;
      &lt;xs:attribute name='partial' type='xs:boolean' use='optional'/&gt;
      &lt;xs:attribute name='start' type='xs:dateTime' use='required'/&gt;
      &lt;xs:attribute name='subject' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='with' type='xs:string' use='required'/&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='default'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='save' use='required'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='false'/&gt;
                &lt;xs:enumeration value='true'/&gt;
                &lt;xs:enumeration value='unset'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
          &lt;xs:attribute name='service' use='optional' type='xs:boolean'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='item'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='jid' use='required' type='xs:string'/&gt;
          &lt;xs:attribute name='save' use='required' type='xs:boolean'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:complexType name='messageType'&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element name='body' type='xs:string' maxOccurs='unbounded'/&gt;
    &lt;/xs:sequence&gt;
    &lt;xs:attribute name='secs' type='xs:nonNegativeInteger' use='required'/&gt;
  &lt;/xs:complexType&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
  </pre></div>
<p><hr></p>
<a name="notes"></a><h2>Notes</h2>
<div class="indent">
<p><a name="nt-id2250871">1</a>. JEP-0030: Service Discovery &lt;<a href="http://www.jabber.org/jeps/jep-0030.html">http://www.jabber.org/jeps/jep-0030.html</a>&gt;.</p>
<p><a name="nt-id2260143">2</a>. JEP-0045: Multi-User Chat &lt;<a href="http://www.jabber.org/jeps/jep-0045.html">http://www.jabber.org/jeps/jep-0045.html</a>&gt;.</p>
<p><a name="nt-id2260190">3</a>. JEP-0131: Stanza Headers and Internet Metadata &lt;<a href="http://www.jabber.org/jeps/jep-0131.html">http://www.jabber.org/jeps/jep-0131.html</a>&gt;.</p>
<p><a name="nt-id2260578">4</a>. JEP-0116: Encrypted Sessions &lt;<a href="http://www.jabber.org/jeps/jep-0116.html">http://www.jabber.org/jeps/jep-0116.html</a>&gt;.</p>
<p><a name="nt-id2260606">5</a>. JEP-0082: Jabber Date and Time Profiles &lt;<a href="http://www.jabber.org/jeps/jep-0082.html">http://www.jabber.org/jeps/jep-0082.html</a>&gt;.</p>
<p><a name="nt-id2261302">6</a>. JEP-0090: Entity Time &lt;<a href="http://www.jabber.org/jeps/jep-0090.html">http://www.jabber.org/jeps/jep-0090.html</a>&gt;.</p>
<p><a name="nt-id2261349">7</a>. JEP-0045: Multi-User Chat &lt;<a href="http://www.jabber.org/jeps/jep-0045.html">http://www.jabber.org/jeps/jep-0045.html</a>&gt;.</p>
<p><a name="nt-id2261425">8</a>. JEP-0131: Stanza Headers and Internet Metadata &lt;<a href="http://www.jabber.org/jeps/jep-0131.html">http://www.jabber.org/jeps/jep-0131.html</a>&gt;.</p>
<p><a name="nt-id2261506">9</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p>
<p><a name="nt-id2261557">10</a>. The Jabber Registrar maintains a list of reserved Jabber protocol namespaces as well as registries of parameters used in the context of protocols approved by the Jabber Software Foundation. For further information, see &lt;<a href="http://www.jabber.org/registrar/">http://www.jabber.org/registrar/</a>&gt;.</p>
</div>
<p><hr></p>
<a name="revs"></a><h2>Revision History</h2>
<div class="indent">
<h4>Version 0.6 (2006-08-18)</h4>
<div class="indent">
<p class="" style="">Added unset value for save attribute and added service attribute on default element; added source attribute on record element; specified that services should (not must) support save mode for particular contacts.</p> (jp/psa)
    </div>
<h4>Version 0.5 (2006-05-03)</h4>
<div class="indent">
<p class="" style="">Integrated text from server-side archiving proposal; added partial support to collection retrieval; harmonized XML formats and namespaces; defined Jabber Registrar considerations and XML schema.</p> (psa/jp/ip/jk)
    </div>
<h4>Version 0.4 (2005-12-21)</h4>
<div class="indent">
<p class="" style="">Added Replication and Searching section, partial attribute; minor improvements</p> (ip)
    </div>
<h4>Version 0.3 (2005-10-21)</h4>
<div class="indent">
<p class="" style="">Added more examples to Removing Collections</p> (ip)
    </div>
<h4>Version 0.2 (2005-04-18)</h4>
<div class="indent">
<p class="" style="">Complete rewrite.</p> (ip)
    </div>
<h4>Version 0.1 (2004-06-04)</h4>
<div class="indent">
<p class="" style="">Initial version.</p> (jk)
    </div>
</div>
<p><hr></p>
<p>END</p>
</body>
</html>
