<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>XEP-0384: OMEMO Encryption</title><style type="text/css">
/* don't mind this hack */
nav#toc h2:before {
display: none;
content: "XEP-0384";
}
        </style><link rel="stylesheet" type="text/css" href="xmpp.css"><link href="prettify.css" type="text/css" rel="stylesheet"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"><script type="text/javascript" src="prettify.js"></script><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0"><meta name="DC.Title" content="OMEMO Encryption"><meta name="DC.Creator" content="Andreas Straub"><meta name="DC.Creator" content="Daniel Gultsch"><meta name="DC.Creator" content="Tim Henkes"><meta name="DC.Creator" content="Klaus Herberth"><meta name="DC.Creator" content="Paul Schaub"><meta name="DC.Creator" content="Marvin Wißfeld"><meta name="DC.Description" content="This specification defines a protocol for end-to-end encryption in one-to-one chats, as well as group chats where each participant may have multiple clients per account."><meta name="DC.Publisher" content="XMPP Standards Foundation"><meta name="DC.Contributor" content="XMPP Extensions Editor"><meta name="DC.Date" content="2021-10-07"><meta name="DC.Type" content="XMPP Extension Protocol"><meta name="DC.Format" content="XHTML"><meta name="DC.Identifier" content="XEP-0384"><meta name="DC.Language" content="en"><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright © 1999 – 2020 by the XMPP Standards Foundation (XSF)."></head><body onload="prettyPrint()"><h1>XEP-0384: OMEMO Encryption</h1><div class="docmeta-wrap"><dl id="docmeta" class="compact"><dt>Abstract</dt><dd>This specification defines a protocol for end-to-end encryption in one-to-one chats, as well as group chats where each participant may have multiple clients per account.</dd><dt>Authors</dt><dd><ul class="authors"><li>Andreas Straub</li><li>Daniel Gultsch</li><li>Tim Henkes</li><li>Klaus Herberth</li><li>Paul Schaub</li><li>Marvin Wißfeld</li></ul></dd><dt>Copyright</dt><dd>© 1999 – 2021 XMPP Standards Foundation. <a href="#appendix-legal">SEE LEGAL NOTICES</a>.</dd><dt>Status</dt><dd><p>Experimental</p><div id="status-notice" class="experimental standards track">WARNING: This Standards-Track document is Experimental. Publication as an XMPP Extension Protocol does not imply approval of this proposal by the XMPP Standards Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems are advised to carefully consider whether it is appropriate to deploy implementations of this protocol before it advances to a status of Draft.</div></dd><dt>Type</dt><dd>Standards Track</dd><dt>Version</dt><dd>0.8.1 (2021-10-07)</dd></dl><div class="timeline-wrap"><div class="timeline-head">Document Lifecycle</div><ol class="timeline"><li class="current">Experimental</li><li>Proposed</li><li>Stable</li><li>Final</li></ol></div></div><nav id="toc"><a href="#top"><h2>Table of Contents</h2></a><ol class="toc"><li><a href="#intro">Introduction</a><ol><li><a href="#intro-motivation">Motivation</a></li><li><a href="#intro-overview">Overview</a></li></ol></li><li><a href="#reqs">Requirements</a><ol><li><a href="#reqs-threat-model">Threat Model</a></li></ol></li><li><a href="#glossary">Glossary</a></li><li><a href="#protocol">Protocol Definition</a><ol><li><a href="#protocol-overview">Overview</a></li><li><a href="#protocol-key_exchange">Key Exchange</a></li><li><a href="#protocol-double_ratchet">Double Ratchet</a></li><li><a href="#protocol-message_encryption">Message Encryption</a></li><li><a href="#protocol-message_decryption">Message Decryption</a></li></ol></li><li><a href="#usecases">Use Cases</a><ol><li><a href="#usecases-setup">Setup</a></li><li><a href="#usecases-discovering">Discovering peer support</a></li><li><a href="#usecases-announcing">Announcing support</a><ol><li><a href="#devices">Device list</a></li><li><a href="#bundles">Bundles</a></li></ol></li><li><a href="#usecases-building">Building a session</a></li><li><a href="#usecases-messagesend">Sending a message</a><ol><li><a href="#sce">SCE Profile</a></li><li><a href="#encrypt">Encryption</a></li><li><a href="#message-structure-description">Message structure description</a></li></ol></li><li><a href="#usecases-receiving">Receiving a message</a></li><li><a href="#opt-out">Opt-out</a></li><li><a href="#group-chats">Group Chats</a><ol><li><a href="#members-list">Retrieving and maintaining members list</a></li><li><a href="#group-fetch">Fetching devices and bundles</a></li><li><a href="#group-send">Sending a message</a></li></ol></li></ol></li><li><a href="#rules">Business Rules</a></li><li><a href="#impl">Implementation Notes</a><ol><li><a href="#server-side">Server side requirements</a></li></ol></li><li><a href="#security">Security Considerations</a></li><li><a href="#iana">IANA Considerations</a></li><li><a href="#registrar">XMPP Registrar Considerations</a><ol><li><a href="#namespaces">Protocol Namespaces</a></li><li><a href="#versioning">Protocol Versioning</a></li></ol></li><li><a href="#schema">XML Schema</a></li><li><a href="#protobuf-schema">Protobuf Schema</a></li><li><a href="#ack">Acknowledgements</a></li></ol><h6><a href="#appendices">Appendices</a></h6><ol class="toc-appendices"><li><a href="#appendix-docinfo">Document Information</a></li><li><a href="#appendix-authorinfo">Author Information</a></li><li><a href="#appendix-legal">Legal Notices</a></li><li><a href="#appendix-xmpp">Relation to XMPP</a></li><li><a href="#appendix-discuss">Discussion Venue</a></li><li><a href="#appendix-conformance">Requirements Conformance</a></li><li><a href="#appendix-notes">Notes</a></li><li><a href="#appendix-revs">Revision History</a></li><li><a href="#appendix-biblatex">Bib(La)Tex Entry</a></li></ol></nav><h2 id="intro">1.
       Introduction<a class="anchor-link" href="#intro"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <div class="indent"><h3 id="intro-motivation">1.1 Motivation<a class="anchor-link" href="#intro-motivation"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      There are two main end-to-end encryption schemes in common use in the XMPP
      ecosystem, Off-the-Record (OTR) messaging (<span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0364.html">Current Off-the-Record Messaging Usage (XEP-0364)</a></span>  [<a href="#nt-idm159">1</a>]) and OpenPGP
      (<span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0027.html">Current Jabber OpenPGP Usage (XEP-0027)</a></span>  [<a href="#nt-idm163">2</a>]). Older OTR versions have had significant usability drawbacks for inter-client
      mobility. As OTR sessions existed between exactly two clients, the chat
      history would not be synchronized across other clients of the involved
      parties. Furthermore, OTR chats were only possible if both participants were
      online at the same time, due to how the rolling key agreement scheme of OTR
      worked. Some of those problems have been addressed in OTRv4.
      OpenPGP, while not suffering from these mobility issues, does not
      provide any kind of forward secrecy and is vulnerable to replay attacks.
      Additionally, PGP over XMPP uses a custom wireformat which is defined by
      convention rather than standardization, and involves quite a bit of
      external complexity. The wire format issues were resolved with <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0373.html">OpenPGP for XMPP (XEP-0373)</a></span>  [<a href="#nt-idm167">3</a>].
    </p>
    <p class="" style="">
      This XEP defines a protocol that leverages the Double Ratchet encryption scheme to provide
      multi-end to multi-end encryption, allowing messages to be synchronized
      securely across multiple clients, even if some of them are offline.
      The Double Ratchet encryption scheme is based on work by Trevor Perrin
      and Moxie Marlinspike and was first published as the Axolotl protocol.
      The specification for the protocol is available in the public domain.
    </p>
  </div>
  <div class="indent"><h3 id="intro-overview">1.2 Overview<a class="anchor-link" href="#intro-overview"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      The general idea behind this protocol is to maintain separate,
      long-standing Double Ratchet-encrypted sessions with each device of each contact
      (as well as with each of our other devices), which are used as secure key
      transport channels. In this scheme, each message is encrypted with a
      fresh, randomly generated encryption key. An encrypted header is added to
      the message for each device that is supposed to receive it. These headers
      simply contain the key that the payload message is encrypted with, and
      they are separately encrypted using the session corresponding to the
      counterpart device. The encrypted payload is sent together with the
      headers as a &lt;message&gt; stanza. Individual recipient devices can
      decrypt the header item intended for them, and use the contained payload
      key to decrypt the payload message.
    </p>
    <p class="" style="">
      As the encrypted payload is common to all recipients, it only has to be
      included once, reducing overhead. Furthermore, the transparent handling by the
      Double Ratchet encryption scheme of messages that were lost or received out of order, as well
      as those sent while the recipient was offline, is maintained by this protocol. As a
      result, in combination with <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0280.html">Message Carbons (XEP-0280)</a></span>  [<a href="#nt-idm175">4</a>] and <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0313.html">Message Archive Management (XEP-0313)</a></span>  [<a href="#nt-idm179">5</a>], the desired property
      of inter-client history synchronization is achieved.
    </p>
    <p class="" style="">
      While in the future a dedicated key server component could be used to distribute
      key material for session creation, the current specification relies on <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0060.html">Publish-Subscribe (XEP-0060)</a></span>  [<a href="#nt-idm184">6</a>] and <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0163.html">Personal Eventing Protocol (XEP-0163)</a></span>  [<a href="#nt-idm188">7</a>] to publish
      and acquire key bundles.
    </p>
  </div>
<h2 id="reqs">2.
       Requirements<a class="anchor-link" href="#reqs"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">It is a result of XMPP's federated nature that a message may pass more than just one server. Therefore it is in the users' interest to secure their communication from any intermediate host. End-to-end encryption is an efficient way to protect any data exchanged between sender and receiver against passive and active attackers such as servers and network nodes.</p>
  <p class="" style="">OMEMO is an end-to-end encryption protocol based on the Double Ratchet specified in section <a href="#protocol-double_ratchet">Double Ratchet</a>. It provides the following guarantees under the threat model described in the next section:</p>
  <ul class="" style="">
    <li class="" style="">Confidentiality: Nobody else except sender and receiver is able to read the content of a message.</li>
    <li class="" style="">Forward Secrecy: Compromised key material does not compromise previous message exchanges.
    It has been <a href="https://www.cypherpunks.ca/~iang/pubs/dakez-popets18.pdf">demonstrated</a>, that OMEMO provides only weak forward secrecy (it protects the session key only once both parties complete the key exchange).</li>
    <li class="" style="">Break-in Recovery: A session which has been compromised due to leakage of key material recovers from the compromise after a few communication rounds.</li>
    <li class="" style="">Authentication: Every peer is able to authenticate the sender or receiver of a message, even if the details of the authentication process is out-of-scope for this specification.</li>
    <li class="" style="">Integrity: Every peer can ensure that a message was not changed by any intermediate node.</li>
    <li class="" style="">Deniability: X3DH is weakly offline deniable and provides no online deniability, as far as the research shows.</li>
    <li class="" style="">Asynchronicity: The usability of the protocol does not depend on the online status of any participant.</li>
  </ul>
  <p class="" style="">OMEMO is not intended to protect against the following use cases:</p>
  <ul class="" style="">
    <li class="" style="">An attacker has permanent access to your device. In this case, the attacker may extract decrypted messages from the device, eg. from the applications database. If the access is temporary, security will eventually be restored through break-in recovery.</li>
    <li class="" style="">You lost your device and an attacker can read messages on your notification screen.</li>
    <li class="" style="">Any kind of denial-of-service attack.</li>
    <li class="" style="">tbc</li>
  </ul>
  <p class="" style="">
    Trust management is a difficult topic, which is out of scope of this document.
  </p>
  <div class="indent"><h3 id="reqs-threat-model">2.1 Threat Model<a class="anchor-link" href="#reqs-threat-model"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">The use case for OMEMO is a situation where the content of a conversation needs to be protected, but where the servers the message passes by can’t be trusted to keep the content of the message secret. For example when information that is under strict embargo needs to passed within an organization and the server administrator is not one of the persons cleared to see the information or when a couple is exchanging intimate messages and they want to avoid leaking of those messages to the server administrator.</p>
    <p class="" style="">The OMEMO protocol protects against passive and active attackers which are able to read, modify, replay, delay and delete messages. The OMEMO protocol does not protect against attackers who rely on metadata and traffic analysis. The quality of the verification of the conversation participants OMEMO identity keys determines the level of protection OMEMO offers.</p>
  </div>
<h2 id="glossary">3.
       Glossary<a class="anchor-link" href="#glossary"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <div class="indent"><dl>
    <dt><strong>Device</strong></dt><dd>A communication end point, i.e. a specific client instance</dd>
    <dt><strong>OMEMO element</strong></dt><dd>An &lt;encrypted&gt; element in the <code>urn:xmpp:omemo:2</code> namespace</dd>
    <dt><strong>Bundle</strong></dt><dd>A collection of publicly accessible data used by the X3DH key agreement protocol that can be used to build a session with a device, namely its public IdentityKey, a signed PreKey with corresponding signature, and a list of (single use) PreKeys.</dd>
    <dt><strong>rid</strong></dt><dd>The device id of the intended recipient of the containing &lt;key&gt;</dd>
    <dt><strong>sid</strong></dt><dd>The device id of the sender of the containing OMEMO element</dd>
  </dl></div>
<h2 id="protocol">4.
       Protocol Definition<a class="anchor-link" href="#protocol"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <div class="indent"><h3 id="protocol-overview">4.1 Overview<a class="anchor-link" href="#protocol-overview"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      This protocol uses the <span class="ref" style=""><a href="https://signal.org/docs/specifications/doubleratchet/">DoubleRatchet</a></span>  [<a href="#nt-idm236">8</a>] encryption scheme in conjunction with the <span class="ref" style=""><a href="https://www.signal.org/docs/specifications/x3dh/">X3DH</a></span>  [<a href="#nt-idm240">9</a>] key agreement protocol. The following section provides detailed technical information about the protocol that should be sufficient to build an implementation of the OMEMO Double Ratchet. Readers who do not intend to build an OMEMO-compatible library can safely skip this section, relevant details are repeated where needed.
    </p>
  </div>
  <div class="indent"><h3 id="protocol-key_exchange">4.2 Key Exchange<a class="anchor-link" href="#protocol-key_exchange"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      The <span class="ref" style=""><a href="https://www.signal.org/docs/specifications/x3dh/">X3DH</a></span>  [<a href="#nt-idm240">9</a>] key agreement protocol was specified by Trevor Perrin and Moxie Marlinspike and placed under the public domain. OMEMO uses a modified version of this key agreement protocol with the following parameters/settings:
    </p>
    <div class="indent"><dl>
      <dt><strong>curve</strong></dt><dd>Curve25519/Ed25519</dd>
      <dt><strong>hash function</strong></dt><dd>SHA-256</dd>
      <dt><strong>info string</strong></dt><dd>"OMEMO X3DH"</dd>
      <dt><strong>signed PreKey rotation period</strong></dt><dd>Signed PreKeys SHOULD be rotated periodically once a week to once a month. A faster or slower rotation period should not be required.</dd>
      <dt><strong>time to keep the private key of the old signed PreKey after rotating it</strong></dt><dd>The private key of the old signed PreKey SHOULD be kept for another rotation period as defined above, to account for delayed messages using the old signed PreKey.</dd>
      <dt><strong>number of PreKeys to provide in the bundle</strong></dt><dd>The bundle SHOULD always contain around 100 PreKeys.</dd>
      <dt><strong>minimum number of PreKeys to provide in the bundle</strong></dt><dd>The bundle MUST always contain at least 25 PreKeys.</dd>
      <dt><strong>usage of PeyKeys</strong></dt><dd>All key exchanges MUST use a PreKey, key exchanges that don't use a PreKey MUST be rejected.</dd>
      <dt><strong>associated data</strong></dt><dd>The associated data is created by concatenating the IdentityKeys of Alice and Bob: <code>AD = Encode(IK_A) || Encode(IK_B)</code>. <code>Alice</code> is the party that <em>actively initiated</em> the key exchange, while <code>Bob</code> is the party that <em>passively accepted</em> the key exchange.</dd>
      <dt><strong>XEdDSA</strong></dt><dd>OMEMO does not mandate the usage of <span class="ref" style=""><a href="https://www.signal.org/docs/specifications/xeddsa/">XEdDSA</a></span>  [<a href="#nt-idm286">10</a>] with <span class="ref" style=""><a href="https://www.signal.org/docs/specifications/x3dh/">X3DH</a></span>  [<a href="#nt-idm240">9</a>] for the IdentityKey. Instead, there are three simple rules that implementations MUST follow:
        <ol start="" class="" style="">
          <li class="" style="">Implementations must use the birational map between the curves Curve25519 and Ed25519 to convert the public part of the IdentityKey whenever required, as defined in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc7748">RFC 7748</a></span>  [<a href="#nt-idm296">11</a>] (on page 5).</li>
          <li class="" style="">Implementations must be able to perform X25519 (ECDH on Curve25519) using the IdentityKey.</li>
          <li class="" style="">Implementations must be able to create EdDSA-compatible signatures on the curve Ed25519 using the IdentityKey.</li>
        </ol>
        There are essentially two ways in which libraries can fulfill these requirements:
        <ol start="" class="" style="">
          <li class="" style="">Libraries can use a Curve25519 key pair as their internal IdentityKey. In this case, the IdentityKey can be used for X25519 directly, and XEdDSA has to be used to produce EdDSA-compatible signatures. Note that libsignal by default does <strong>NOT</strong> use XEdDSA. libsignal <em>includes</em> XEdDSA though and has to be modified to use that to be compatible with OMEMO.</li>
          <li class="" style="">Libraries can use an Ed25519 key pair as their internal IdentityKey. In this case, the IdentityKey can create EdDSA-compatible signatures directly, and has to be converted first to perform X25519.</li>
        </ol>
        Note that this decision is purely local to each client and OMEMO library. The public key is ALWAYS transferred in its Ed25519 form and only valid EdDSA signatures are transferred. The choice between Curve25519 and Ed25519 affects the definition of the <code>Sig(PK, M)</code> and <code>DH(PK1, PK2)</code> functions as defined below.</dd>
      <dt><strong>Sig(PK, M)</strong></dt><dd>If the IdentityKey pair is chosen to be a Curve25519 key pair, the definition of <code>Sig(PK, M)</code> found in the X3DH specification applies. If the IdentityKey pair is chosen to be an Ed25519 key pair, the following definition applies: <code>Sig(PK, M)</code> represents the byte sequence that is an Ed25519 signature on the byte sequence <code>M</code> and verifies with public key <code>PK</code>, and which was created by signing <code>M</code> with <code>PK</code>'s corresponding private key. The byte-format of the signature is defined in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc8032">RFC 8032</a></span>  [<a href="#nt-idm318">12</a>].</dd>
      <dt><strong>DH(PK1, PK2)</strong></dt><dd>The original definition of <code>DH(PK1, PK2)</code> found in the X3DH specification applies with one exception: if the IdentityKey pair is chosen to be an Ed25519 key pair and either <code>PK1</code> or <code>PK2</code> corresponds to the IdentityKey, the respective key first has to be converted into its Curve25519 equivalent (see above). This conversion is implemented for example by <code>libsodium</code>, which exports the conversion as <code>crypto_sign_ed25519_sk_to_curve25519</code> and <code>crypto_sign_ed25519_pk_to_curve25519</code> for the private and public key, respectively (documented on <a href="https://download.libsodium.org/doc/advanced/ed25519-curve25519">libsodium.org</a>).</dd>
      <dt><strong>Encode(PK)</strong></dt><dd>The public part of the IdentityKey pair is encoded as defined in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc8032">RFC 8032</a></span>  [<a href="#nt-idm318">12</a>]. Note that the IdentityKey is always transferred in its Ed25519 form. When using a Curve25519 key pair internally, the public key has to be converted to Ed25519 first. Curve25519 public keys are encoded using the little-endian encoding of the u-coordinate as specified in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc7748">RFC 7748</a></span>  [<a href="#nt-idm296">11</a>].</dd>
    </dl></div>
    <p class="" style="">
      The key exchange is done just-in-time when sending the first message to a device. Thus, each key exchange message always also contains encrypted content as produced by the Double Ratchet encryption scheme below.
    </p>
  </div>
  <div class="indent"><h3 id="protocol-double_ratchet">4.3 Double Ratchet<a class="anchor-link" href="#protocol-double_ratchet"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">NOTE: <code>OMEMOMessage.proto</code>, <code>OMEMOAuthenticatedMessage.proto</code> and <code>OMEMOKeyExchange.proto</code> refer to the protobuf structures as defined in the <a href="#protobuf-schema">Protobuf Schemas</a>.</p>
    <p class="" style="">
      The <span class="ref" style=""><a href="https://signal.org/docs/specifications/doubleratchet/">DoubleRatchet</a></span>  [<a href="#nt-idm236">8</a>] encryption scheme was specified by Trevor Perrin and Moxie Marlinspike and placed under the public domain. OMEMO uses this protocol with the following parameters/settings:
    </p>
    <div class="indent"><dl>
      <dt><strong>ratchet initialization</strong></dt><dd>
        The Double Ratchet is initialized using the shared secret, ad and public keys as yielded by the X3DH key agreement protocol, as explained in the Double Ratchet specification. Additionally, the ephemeral key pair (ek) used by the X3DH key agreement is stored with the session.
      </dd>
      <dt><strong>MAX_SKIP</strong></dt><dd>Storing skipped message keys introduces two potential DoS attacks. First, the maximum number of skipped message keys to store has to be limited, otherwise an attacker could fill the storage of the receiving device with skipped message keys. It is RECOMMENDED to keep 1000 skipped message keys around per session. Second, the maximum number of skipped message keys in a single message has to be limited, otherwise, with just a single malicious message, an attacker could make the receiving device calculate up to around 2^32 skipped message keys. The choice of this limit depends on the hardware capabilities of the device, though modern hardware is safe to choose values of around 1000 here too.</dd>
      <dt><strong>deletion policy for skipped message keys</strong></dt><dd>As soon as the maximum number of skipped message keys are stored for a session, keys for that session are discarded on a FIFO basis to make space for new skipped message keys. Implementations SHOULD NOT keep skipped message keys around forever, but discard old keys on a different implementation-defined policy. It is RECOMMENDED to base this policy on deterministic events rather than time.</dd>
      <dt><strong>authentication tag truncation</strong></dt><dd>Authentication tags are truncated to 16 bytes/128 bits by cutting off excess bytes from the end.</dd>
      <dt><strong>CONCAT(ad, header)</strong></dt><dd><code>CONCAT(ad, header) = ad || OMEMOMessage.proto(header)</code> NOTE: the <code>OMEMOMessage.proto</code> is initialized without the ciphertext, which is optional. NOTE: Implementations are not strictly required to return a parseable byte array, as the unpacked/parsed data is required later in the protocol.</dd>
      <dt><strong>KDF_RK(rk, dh_out)</strong></dt><dd>HKDF-SHA-256 using the root key (rk) as HKDF salt, the output of a Diffie-Hellman (dh_out) as HKDF input material and "OMEMO Root Chain" as HKDF info.</dd>
      <dt><strong>KDF_CK(ck)</strong></dt><dd>HMAC-SHA-256 using a chain key (ck) as the HMAC key, a single byte constant <code>0x01</code> as HMAC input to produce the next message key (mk) and a single byte constant <code>0x02</code> as HMAC input to produce the next chain key.</dd>
      <dt><strong>ENCRYPT(mk, plaintext, associated_data)</strong></dt><dd>
        The encryption step uses authenticated encryption consisting of AES-256-CBC with HMAC-SHA-256.
        <ol start="" class="" style="">
          <li class="" style="">Use HKDF-SHA-256 to generate 80 bytes of output from the message key by providing mk as HKDF input, 256 zero-bits as HKDF salt and "OMEMO Message Key Material" as HKDF info.</li>
          <li class="" style="">Divide the HKDF output into a 32-byte encryption key, a 32-byte authentication key and a 16 byte IV.</li>
          <li class="" style="">Encrypt the plaintext (which consists of a 32 bytes key and a 32 bytes HMAC as specified in the section about <a href="#protocol-message_encryption">Message Encryption</a>) using AES-256-CBC with PKCS#7 padding, using the encryption key and IV derived in the previous step.</li>
          <li class="" style="">Split the associated data as returned by <code>CONCAT</code> into the original ad and the <code>OMEMOMessage.proto</code> structure.</li>
          <li class="" style="">Add the ciphertext to the <code>OMEMOMessage.proto</code> structure.</li>
          <li class="" style="">Serialize the <code>OMEMOMessage.proto</code> structure into a parseable byte array. To avoid potential problems regarding non-uniqueness of the serialization, make sure to only serialize <em>once</em> and to use that exact byte sequence in the following steps.</li>
          <li class="" style="">Concatenate the ad and the <code>OMEMOMessage.proto</code> structure into a parseable byte array. The result builds the HMAC input material for the next step.</li>
          <li class="" style="">Calculate the HMAC-SHA-256 using the authentication key and the input material as derived in the steps above. Truncate the output of the HMAC to 16 bytes/128 bits by cutting off excess bytes from the end.</li>
          <li class="" style="">Put the serialized <code>OMEMOMessage.proto</code> structure and the HMAC into a new <code>OMEMOAuthenticatedMessage.proto</code> structure.</li>
        </ol>
      </dd>
    </dl></div>
    <p class="" style="">Information on the functions mentioned above can be found in the <a href="https://signal.org/docs/specifications/doubleratchet/#external-functions">Double Ratchet</a> specification.</p>
    <p class="" style="">
      If encrypting this message required a key exchange, the X3DH header data is placed into a new <code>OMEMOKeyExchange.proto</code> structure together with the <code>OMEMOAuthenticatedMessage.proto</code> structure.
    </p>
    <p class="" style="">
      To account for lost and out-of-order messages during the key exchange, <code>OMEMOKeyExchange.proto</code> structures are sent until a response by the recipient confirms that the key exchange was successfully completed. To do so, the X3DH header data is stored and added on each subsequent message until a response is received. This looks roughly as follows:
    </p>
    <ol start="" class="" style="">
      <li class="" style="">The first content is encrypted for a new recipient. This results in an X3DH header and a <code>OMEMOAuthenticatedMessage.proto</code> structure. Both are packed into an <code>OMEMOKeyExchange.proto</code> structure. The X3DH header is stored for following messages.</li>
      <li class="" style="">A second message is encrypted for the same recipient. This results in only an <code>OMEMOAuthenticatedMessage.proto</code> structure, as a new key exchange is not required. Together with the X3DH header that was stored in the previous step, an <code>OMEMOKeyExchange.proto</code> structure is constructed and sent to the recipient.</li>
    </ol>
    <p class="" style="">
      When receiving an OMEMOKeyExchange, the receiving device checks if it already has a Double Ratchet session with the sending device. If that is the case, the device compares the ephemeral public key stored in the Double Ratchet state with the ephemeral public key in the <code>OMEMOKeyExchange.proto</code> structure. If both are equal, the receiving device only processes the <code>OMEMOAuthenticatedMessage.proto</code> contained in the <code>OMEMOKeyExchange.proto</code>. Otherwise, it processes the whole <code>OMEMOKeyExchange.proto</code> structure.
    </p>
  </div>
  <div class="indent"><h3 id="protocol-message_encryption">4.4 Message Encryption<a class="anchor-link" href="#protocol-message_encryption"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      The contents are encrypted and authenticated using a combination of AES-256-CBC and HMAC-SHA-256.
    </p>
    <ol start="" class="" style="">
      <li class="" style="">Generate 32 bytes of <a href="https://tools.ietf.org/html/rfc4086">cryptographically secure random data</a>, called <code>key</code> in the remainder of this algorithm.</li>
      <li class="" style="">Use HKDF-SHA-256 to generate 80 bytes of output from the key by providing the key as HKDF input, 256 zero-bits as HKDF salt and "OMEMO Payload" as HKDF info.</li>
      <li class="" style="">Divide the HKDF output into a 32-byte encryption key, a 32-byte authentication key and a 16 byte IV.</li>
      <li class="" style="">Encrypt the plaintext using AES-256-CBC with PKCS#7 padding, using the encryption key and IV derived in the previous step.</li>
      <li class="" style="">Calculate the HMAC-SHA-256 using the authentication key and the ciphertext from the previous steps. Truncate the output of the HMAC to 16 bytes/128 bits by cutting off excess bytes from the end.</li>
      <li class="" style="">Concatenate the key and the HMAC, encrypt them using the Double Ratchet as specified above, once for each intended recipient. This yields one OMEMOKeyExchange or OMEMOAuthenticatedMessage per recipient device.</li>
    </ol>
  </div>
  <div class="indent"><h3 id="protocol-message_decryption">4.5 Message Decryption<a class="anchor-link" href="#protocol-message_decryption"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      The contents are decrypted by reversing the encryption steps.
    </p>
    <ol start="" class="" style="">
      <li class="" style="">Decrypt the key and HMAC from the OMEMOKeyExchange or OMEMOAuthenticatedMessage, encrypted using the Double Ratchet belonging to this device.</li>
      <li class="" style="">Use HKDF-SHA-256 to generate 80 bytes of output from the key by providing the key as HKDF input, 256 zero-bits as HKDF salt and "OMEMO Payload" as HKDF info.</li>
      <li class="" style="">Divide the HKDF output into a 32-byte encryption key, a 32-byte authentication key and a 16 byte IV.</li>
      <li class="" style="">Verify the (truncated) HMAC-SHA-256 using the authentication key derived in the previous step and the ciphertext.</li>
      <li class="" style="">Decrypt the ciphertext using AES-256-CBC with PKCS#7 padding, using the encryption key and IV derived in the previous steps.</li>
    </ol>
  </div>
<h2 id="usecases">5.
       Use Cases<a class="anchor-link" href="#usecases"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <div class="indent"><h3 id="usecases-setup">5.1 Setup<a class="anchor-link" href="#usecases-setup"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      To participate in OMEMO-encrypted chats, clients need to set up an OMEMO library and generate a device id, which is a randomly generated integer between 1 and 2^31 - 1 (the positive numbers of a signed 32 bit integer, without 0). The device id must be unique for the account.
    </p>
  </div>
  <div class="indent"><h3 id="usecases-discovering">5.2 Discovering peer support<a class="anchor-link" href="#usecases-discovering"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">In order to determine whether a given contact has devices that support OMEMO, the devices node in PEP is consulted. Devices MUST subscribe to <code>urn:xmpp:omemo:2:devices</code> via PEP, so that they are informed whenever their contacts add a new device. They MUST cache the most up-to-date version of the device list.</p>
    <figure class="code-example" id="example-1"><figcaption><strong>Example 1.</strong> Devicelist update received by subscribed clients<a class="anchor-link" href="#example-1"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;message from='juliet@capulet.lit'
         to='romeo@montague.lit'
         type='headline'
         id='update_01'&gt;
  &lt;event xmlns='http://jabber.org/protocol/pubsub#event'&gt;
    &lt;items node='urn:xmpp:omemo:2:devices'&gt;
      &lt;item id='current'&gt;
        &lt;devices xmlns='urn:xmpp:omemo:2'&gt;
          &lt;device id='12345' /&gt;
          &lt;device id='4223' label='Gajim on Ubuntu Linux' /&gt;
        &lt;/devices&gt;
      &lt;/item&gt;
    &lt;/items&gt;
  &lt;/event&gt;
&lt;/message&gt;</pre></figure>
  </div>
  <div class="indent"><h3 id="usecases-announcing">5.3 Announcing support<a class="anchor-link" href="#usecases-announcing"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <div class="indent"><h4 id="devices">5.3.1 Device list<a class="anchor-link" href="#devices"><abbr title="Link to this point in the document">¶</abbr></a></h4>
    <p class="" style="">In order for other devices to be able to initiate a session with a given device, it first has to announce itself by adding its device id to the devices PEP node.</p>
    <p class="" style="">It is REQUIRED to set the access model of the <code>urn:xmpp:omemo:2:devices</code> node to ‘open’ to give entities without presence subscription read access to the devices and allow them to establish an OMEMO session. Not having presence subscription is a common occurrence on the first few messages between two contacts and can also happen fairly frequently in group chats as not every participant had prior communication with every other participant.</p>
    <p class="" style="">The access model can be changed efficiently by using publish-options.</p>
    <p class="" style="">The device element MAY contain an attribute called label, which is a user defined string describing the device that published that bundle. It is RECOMMENDED to keep the length of the label under 53 Unicode code points.</p>
    <figure class="code-example" id="example-2"><figcaption><strong>Example 2.</strong> Adding the own device id to the list<a class="anchor-link" href="#example-2"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;iq from='juliet@capulet.lit' type='set' id='announce1'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;publish node='urn:xmpp:omemo:2:devices'&gt;
      &lt;item id='current'&gt;
        &lt;devices xmlns='urn:xmpp:omemo:2'&gt;
          &lt;device id='12345' label='Dino on Lenovo Thinkpad T495'/&gt;
          &lt;device id='4223' /&gt;
          &lt;device id='31415' label='Conversations on Pixel 3' /&gt;
        &lt;/devices&gt;
      &lt;/item&gt;
    &lt;/publish&gt;
    &lt;publish-options&gt;
      &lt;x xmlns='jabber:x:data' type='submit'&gt;
        &lt;field var='FORM_TYPE' type='hidden'&gt;
          &lt;value&gt;http://jabber.org/protocol/pubsub#publish-options&lt;/value&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#access_model'&gt;
          &lt;value&gt;open&lt;/value&gt;
        &lt;/field&gt;
      &lt;/x&gt;
    &lt;/publish-options&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre></figure>
    <p class="" style="">NOTE: as per <a href="https://xmpp.org/extensions/xep-0060.html#impl-singleton"><span class="ref">XEP-0060</span> §12.20</a>, it is RECOMMENDED for the publisher to specify an ItemID of "current" to ensure that the publication of a new item will overwrite the existing item.</p>
    <p class="" style="">This step presents the risk of introducing a race condition: Two devices might simultaneously try to announce themselves, unaware of the other's existence. The second device would overwrite the first one. To mitigate this, devices MUST check that their own device id is contained in the list whenever they receive a PEP update from their own account. If they have been removed, they MUST reannounce themselves.</p>
    </div>
    <div class="indent"><h4 id="bundles">5.3.2 Bundles<a class="anchor-link" href="#bundles"><abbr title="Link to this point in the document">¶</abbr></a></h4>
    <p class="" style="">Furthermore, a device MUST publish its IdentityKey, a signed PreKey, and a list of PreKeys. This tuple is called a bundle and is provided by OMEMO libraries. Bundles are maintained as multiple items in a PEP node called <code>urn:xmpp:omemo:2:bundles</code>. Each bundle MUST be stored in a seperate item. The item id MUST be set to the device id.</p>
    <p class="" style="">A bundle is an element called 'bundle' in the <code>urn:xmpp:omemo:2</code> namespace. It has a child element called ‘spk’ that contains the public part of the signed PreKey as base64 encoded data, a child element called ‘spks’ that contains the signed PreKey signature as base64 encoded data and a child element called ‘ik’ that contains the public part of the IdentityKey as base64 encoded data. PreKeys are multiple elements called ‘pk’ that each contain the public part of one PreKey as base64 encoded data. PreKeys are wrapped in an element called ‘prekeys’ which is a child of the bundle element. The ‘spk’ and the ‘pk’s are tagged with an ‘id’-attribute which is a positive integer between 1 and 2^31 - 1 (the positive numbers of a signed 32 bit integer, without 0) that uniquely identifies the keys. The ‘spk’ and the ‘pk’s are considered separate, which means that an ‘spk’ can have the same ‘id’ as a ‘pk’. These ids are used to save bandwidth during key exchanges, which refer to the keys using their id instead of their full public parts.</p>
    <p class="" style="">When publishing bundles a client MUST make sure that the <code>urn:xmpp:omemo:2:bundles</code> node is configured to store multiple items. This is not the default with <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0163.html">Personal Eventing Protocol (XEP-0163)</a></span>  [<a href="#nt-idm188">7</a>]. If the node doesn’t exist yet it can be configured on the fly by using publish-options as described in <a href="https://xmpp.org/extensions/xep-0060.html#publisher-publish-options"><span class="ref">XEP-0060</span> §7.1.5</a>. The value for 'pubsub#max_items' in publish_options MUST be set to 'max'. If the node did exist and was configured differently the bundle publication will fail. Clients MUST then reconfigure the node as described in <a href="https://xmpp.org/extensions/xep-0060.html#owner-configure"><span class="ref">XEP-0060</span> §8.2</a>.</p>
    <figure class="code-example" id="example-3"><figcaption><strong>Example 3.</strong> Publishing bundle information<a class="anchor-link" href="#example-3"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;iq from='juliet@capulet.lit' type='set' id='annouce2'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;publish node='urn:xmpp:omemo:2:bundles'&gt;
      &lt;item id='31415'&gt;
        &lt;bundle xmlns='urn:xmpp:omemo:2'&gt;
          &lt;spk id='0'&gt;b64/encoded/data&lt;/spk&gt;
          &lt;spks&gt;b64/encoded/data&lt;/spks&gt;
          &lt;ik&gt;b64/encoded/data&lt;/ik&gt;
          &lt;prekeys&gt;
            &lt;pk id='0'&gt;b64/encoded/data&lt;/pk&gt;
            &lt;pk id='1'&gt;b64/encoded/data&lt;/pk&gt;
            &lt;!-- … --&gt;
            &lt;pk id='99'&gt;b64/encoded/data&lt;/pk&gt;
          &lt;/prekeys&gt;
        &lt;/bundle&gt;
      &lt;/item&gt;
    &lt;/publish&gt;
    &lt;publish-options&gt;
      &lt;x xmlns='jabber:x:data' type='submit'&gt;
        &lt;field var='FORM_TYPE' type='hidden'&gt;
          &lt;value&gt;http://jabber.org/protocol/pubsub#publish-options&lt;/value&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#max_items'&gt;
          &lt;value&gt;max&lt;/value&gt;
        &lt;/field&gt;
      &lt;/x&gt;
    &lt;/publish-options&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre></figure>
  <p class="" style="">As with the <code>urn:xmpp:omemo:2:devices</code> node it is REQUIRED to set the access model of the <code>urn:xmpp:omemo:2:bundles</code> to open.</p>
  <p class="" style="">The access model can be changed efficiently by using publish-options.</p>
  <figure class="code-example" id="example-4"><figcaption><strong>Example 4.</strong> Publishing bundle information with an open access model<a class="anchor-link" href="#example-4"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;iq from='juliet@capulet.lit' type='set' id='annouce2'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;publish node='urn:xmpp:omemo:2:bundles'&gt;
      &lt;item id='31415'&gt;
        &lt;bundle xmlns='urn:xmpp:omemo:2'&gt;
          &lt;!-- … --&gt;
        &lt;/bundle&gt;
      &lt;/item&gt;
    &lt;/publish&gt;
    &lt;publish-options&gt;
      &lt;x xmlns='jabber:x:data' type='submit'&gt;
        &lt;field var='FORM_TYPE' type='hidden'&gt;
          &lt;value&gt;http://jabber.org/protocol/pubsub#publish-options&lt;/value&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#max_items'&gt;
          &lt;value&gt;max&lt;/value&gt;
        &lt;/field&gt;
        &lt;field var='pubsub#access_model'&gt;
          &lt;value&gt;open&lt;/value&gt;
        &lt;/field&gt;
      &lt;/x&gt;
    &lt;/publish-options&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre></figure>
  </div>
  </div>
  <div class="indent"><h3 id="usecases-building">5.4 Building a session<a class="anchor-link" href="#usecases-building"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">In order to build a session with a device, their bundle information is fetched.</p>
    <figure class="code-example" id="example-5"><figcaption><strong>Example 5.</strong> Fetching a device's bundle information<a class="anchor-link" href="#example-5"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;iq type='get'
    from='romeo@montague.lit'
    to='juliet@capulet.lit'
    id='fetch1'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;items node='urn:xmpp:omemo:2:bundles'&gt;
      &lt;item id='31415'/&gt;
    &lt;items&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre></figure>
    <p class="" style="">A random pk entry is selected, and used to build an OMEMO session.</p>
  </div>
  <div class="indent"><h3 id="usecases-messagesend">5.5 Sending a message<a class="anchor-link" href="#usecases-messagesend"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">
      In order to send a message, extension elements that are deemed sensible first have to be
      encrypted. For this purpose, extensions that are only intended to be accessible to the recipient
      are placed inside a <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0420.html">Stanza Content Encryption (XEP-0420)</a></span>  [<a href="#nt-idm487">13</a>] &lt;envelope/&gt; element, which is then encrypted using a message key.
      For this reason OMEMO defines its own SCE profile.
    </p>
    <div class="indent"><h4 id="sce">5.5.1 SCE Profile<a class="anchor-link" href="#sce"><abbr title="Link to this point in the document">¶</abbr></a></h4>
      <p class="" style="">
        An OMEMO SCE &lt;envelope/&gt; element
      </p>
      <ul class="" style="">
        <li class="" style="">MUST contain an &lt;rpad/&gt; affix element. This is used to prevent an attacker from gaining insights about the content of a message based on the length of the ciphertext.</li>
        <li class="" style="">MAY contain a &lt;time/&gt; affix element. This can be used to prevent the server from modifying the order in which messages from different sending devices have been sent.</li>
        <li class="" style="">SHOULD contain a &lt;from/&gt; affix element.</li>
        <li class="" style="">MUST contain a &lt;to/&gt; affix element whenever a message is sent via a group chat (MUC/MIX). This is used to prevent the server from silently converting a group message into a private message and vice versa.</li>
      </ul>
      <figure class="code-example" id="example-6"><figcaption><strong>Example 6.</strong> Plaintext SCE envelope element<a class="anchor-link" href="#example-6"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;envelope xmlns='urn:xmpp:sce:1'&gt;
  &lt;content&gt;
    &lt;body xmlns='jabber:client'&gt;
     Hello World!
    &lt;/body&gt;
  &lt;/content&gt;
  &lt;rpad&gt;...&lt;/rpad&gt;
  &lt;from jid='romeo@montague.lit'/&gt;
&lt;/envelope&gt;
      </pre></figure>
    </div>
    <div class="indent"><h4 id="encrypt">5.5.2 Encryption<a class="anchor-link" href="#encrypt"><abbr title="Link to this point in the document">¶</abbr></a></h4>
      <p class="" style="">
        The &lt;envelope/&gt; element is encrypted as described in the section about <a href="#protocol-message_encryption">Message Encryption</a>.
      </p>
      <p class="" style="">
        Clients MUST only consider the devices on the <code>urn:xmpp:omemo:2:devices</code> node of each recipient (i.e. including their own devices node, but excluding itself).
      </p>
    </div>
    <div class="indent"><h4 id="message-structure-description">5.5.3 Message structure description<a class="anchor-link" href="#message-structure-description"><abbr title="Link to this point in the document">¶</abbr></a></h4>
      <p class="" style="">
        An OMEMO encrypted message is specified to include an &lt;encrypted&gt; element in the <code>urn:xmpp:omemo:2</code> namespace. It contains up to two child nodes, the &lt;header&gt; and the &lt;payload/&gt; element. The &lt;header&gt; element must always be present, the &lt;payload/&gt; element must be present unless an empty OMEMO message is sent, as described below.
        The &lt;header&gt; element has an attribute named 'sid' referencing the device id of the sending device and contains one or multiple &lt;keys&gt; elements, each with an attribute 'jid' of one of the recipients bare JIDs, as well as one or multiple &lt;key&gt; elements.
        A &lt;key&gt; element has an attribute named 'rid' referencing the device id of the recipient device, and an attribute named 'kex' which defaults to 'false' and indicates if the enclosed encrypted message includes a key exchange. The key and HMAC encrypted using the long-standing OMEMO session for that recipient device are encoded using base64 and placed as text content into the &lt;key&gt; element.
        The encrypted &lt;envelope/&gt; element is encoded using base64 and placed as text content into the &lt;payload/&gt; element.
      </p>
      
      <p class="" style="">A special case are <em>empty</em> OMEMO messages, which are used in various places throughout the protocol purely to manage sessions and not to transfer content. With empty OMEMO messages, the step of creating and encrypting the &lt;payload/&gt; element is skipped. Instead of encrypting the key and authentication tag of the &lt;payload/&gt; ciphertext with the Double Ratchet session, 32 zero-bytes are encrypted with the Double Ratchet session directly. The resulting OMEMOKeyExchange or OMEMOAuthenticatedMessage are put into &lt;key&gt; elements as usual, but the &lt;payload/&gt; element is omitted altogether, so that the &lt;encrypted&gt; element only contains a &lt;header&gt;.</p>
      <figure class="code-example" id="example-7"><figcaption><strong>Example 7.</strong> Sending a message<a class="anchor-link" href="#example-7"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;message to='juliet@capulet.lit' from='romeo@montague.lit' id='send1'&gt;
  &lt;encrypted xmlns='urn:xmpp:omemo:2'&gt;
    &lt;header sid='27183'&gt;
      &lt;keys jid='juliet@capulet.lit'&gt;
        &lt;key rid='31415'&gt;b64/encoded/data&lt;/key&gt;
      &lt;/keys&gt;
      &lt;keys jid='romeo@montague.lit'&gt;
        &lt;key rid='1337'&gt;b64/encoded/data&lt;/key&gt;
        &lt;key kex='true' rid='12321'&gt;b64/encoded/data&lt;/key&gt;
        &lt;!-- ... --&gt;
      &lt;/keys&gt;
    &lt;/header&gt;
    &lt;payload&gt;
      base64/encoded/message/key/encrypted/envelope/element
    &lt;/payload&gt;
  &lt;/encrypted&gt;
  &lt;store xmlns='urn:xmpp:hints'/&gt;
&lt;/message&gt;</pre></figure>
    </div>
  </div>
  <div class="indent"><h3 id="usecases-receiving">5.6 Receiving a message<a class="anchor-link" href="#usecases-receiving"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">When an OMEMO element is received, the client MUST check whether there is a &lt;keys&gt; element with a jid attribute matching its own bare jid and an inner &lt;key&gt; element with a rid attribute matching its own device id. If this is not the case the message was not encrypted for this particular device and a warning message SHOULD be displayed instead. If such an element exists, the client checks whether the element's contents are an OMEMOKeyExchange.</p>
    <p class="" style="">If this is the case, a new session is built from this received element. The client MUST then republish their bundle information, replacing the used PreKey, such that it won't be used again by a different client. If the client already has a session with the sender's device, it MUST replace this session with the newly built session. The client MUST eventually delete the private key belonging to the PreKey after use (this is subject to the <a href="#business-rules">Business rules</a>).</p>
    <p class="" style="">If the element's contents are an OMEMOAuthenticatedMessage, and the client has a session with the sender's device, it tries to decrypt the OMEMOAuthenticatedMessage using this session. If the decryption fails or there is no session with the sending device, a warning message SHOULD be displayed instead. Also refer to the section about recovering from broken sessions in the <a href="#business-rules">Business Rules</a>.</p>
    <p class="" style="">
      After either the OMEMOKeyExchange or the OMEMOAuthenticatedMessage is decrypted, the content is decrypted as described in the section about <a href="#protocol-message_decryption">Message Decryption</a>.
    </p>
  </div>
  <div class="indent"><h3 id="opt-out">5.7 Opt-out<a class="anchor-link" href="#opt-out"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">An account can signal to a peer that it wants to stop communicating using
    OMEMO encrypted messages and would like to proceed in plain text instead. To do
    that any of that account’s devices sends an &lt;opt-out/&gt; element qualified
    by the <code>urn:xmpp:omemo:2</code> namespace to all intended recipient devices
    inside an encrypted stanza. The element MAY contain a child element &lt;reason&gt;.
    If a device is receiving an encrypted stanza containing an &lt;opt-out/&gt; element,
    it SHOULD display the information, that the peer would like to receive plain text messages.
    To prevent that the user is accidentally sending plaintext messages, the client MUST
    block all outgoing message until the user has confirmed the switch to plaintext.
    Any existing double ratchet sessions SHOULD remain intact. At any point any party MAY
    revert their decision and go back to sending OMEMO encrypted messages again.</p>
    <figure class="code-example" id="example-8"><figcaption><strong>Example 8.</strong> A client signaling that it’s account no longer wants to receive OMEMO-encrypted messages<a class="anchor-link" href="#example-8"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;envelope xmlns='urn:xmpp:sce:1'&gt;
  &lt;content&gt;
    &lt;opt-out xmlns='urn:xmpp:omemo:2'&gt;
      &lt;reason&gt;
        Sorry, but for compliance reasons I need a permanent,
        server-side, record of our conversation.
      &lt;/reason&gt;
    &lt;/opt-out&gt;
  &lt;/content&gt;
&lt;/envelope&gt;
</pre></figure>
  </div>
  <div class="indent"><h3 id="group-chats">5.8 Group Chats<a class="anchor-link" href="#group-chats"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">NOTE: OMEMO encrypted group chats are currently specified to work with <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0045.html">Multi-User Chat (XEP-0045)</a></span>  [<a href="#nt-idm524">14</a>]. This XEP might be updated in the future to specify the usage of OMEMO in conjunction with <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0369.html">Mediated Information eXchange (MIX) (XEP-0369)</a></span>  [<a href="#nt-idm528">15</a>].</p>
    <p class="" style="">A Multi-User Chat room that supports OMEMO MUST be configured non-anonymous and SHOULD be configured members-only.</p>
    <p class="" style="">A participant wanting to send a message to a group chat MUST first retrieve the members list and then fetch the device list for each member (via pubsub and to their real JIDs) and then subsequently fetch all bundles referenced by the device lists.</p>
    <div class="indent"><h4 id="members-list">5.8.1 Retrieving and maintaining members list<a class="anchor-link" href="#members-list"><abbr title="Link to this point in the document">¶</abbr></a></h4>
    <p class="" style="">On join a participant MUST request the member list, the admin list and the owner list as described in <a href="https://xmpp.org/extensions/xep-0045.html#modifymember"><span class="ref">XEP-0045</span> §9.5</a>, <a href="https://xmpp.org/extensions/xep-0045.html#modifyadmin"><span class="ref">XEP-0045</span> §10.8</a>, and <a href="https://xmpp.org/extensions/xep-0045.html#modifyowner"><span class="ref">XEP-0045</span> §10.5</a> respectively. The real JIDs from those three lists MUST be combined as the recipients of OMEMO encrypted messages. This includes recipients who are currently offline. Once joined a participant MUST keep track of affiliation changes that occur in the room. This is both for removals (users getting banned or have their affiliation set to none) and users becoming members, admins or owners.</p>
    </div>
    <div class="indent"><h4 id="group-fetch">5.8.2 Fetching devices and bundles<a class="anchor-link" href="#group-fetch"><abbr title="Link to this point in the document">¶</abbr></a></h4>
    <p class="" style="">Before sending a message a participant MUST explicitly fetch device lists (if not already cached) for each of the members.</p>
    <figure class="code-example" id="example-9"><figcaption><strong>Example 9.</strong> Juliet fetching devices for Romeo and Mercutio<a class="anchor-link" href="#example-9"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;iq type='get' from='juliet@capulet.lit' to='romeo@montague.lit' id='gfetch0'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;items node='urn:xmpp:omemo:2:devices'/&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
&lt;iq type='get' from='juliet@capulet.lit' to='mercutio@verona.lit' id='gfetch1'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;items node='urn:xmpp:omemo:2:devices'/&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre></figure>
    <figure class="code-example" id="example-10"><figcaption><strong>Example 10.</strong> Juliet fetches bundles for Romeo and Mercutio<a class="anchor-link" href="#example-10"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;iq type='get' from='juliet@capulet.lit' to='romeo@montague.lit' id='gfetch2'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;items node='urn:xmpp:omemo:2:bundles'&gt;
      &lt;item id='123'/&gt;
    &lt;items&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;
&lt;iq type='get' from='juliet@capulet.lit' to='mercutio@verona.lit' id='gfetch3'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;items node='urn:xmpp:omemo:2:bundles'&gt;
      &lt;item id='456'/&gt;
    &lt;items&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre></figure>
    </div>
    <div class="indent"><h4 id="group-send">5.8.3 Sending a message<a class="anchor-link" href="#group-send"><abbr title="Link to this point in the document">¶</abbr></a></h4>
    <p class="" style="">Sending a message to a group chat is similiar to sending a message in a 1:1 conversation. Instead of the &lt;header&gt; element having two &lt;keys&gt; elements (one for the recipient and one for other devices of the sender) it will contain multiple &lt;keys&gt; elements. One for each participant of the room; including, again, other devices of the sender.</p>
    <figure class="code-example" id="example-11"><figcaption><strong>Example 11.</strong> Juliet sends a message to a group chat with Romeo and Mercutio<a class="anchor-link" href="#example-11"><abbr title="Link to this point in the document">¶</abbr></a></figcaption><pre class="prettyprint">
&lt;message
    from='juliet@capulet.lit/balcony'
    to='secret-room@conference.capulet.lit'
    type='groupchat'&gt;
  &lt;encrypted xmlns='urn:xmpp:omemo:2'&gt;
    &lt;header sid='27183'&gt;
      &lt;keys jid='juliet@capulet.lit'&gt;
        &lt;key rid='31415'&gt;b64/encoded/data&lt;/key&gt;
      &lt;/keys&gt;
      &lt;keys jid='romeo@montague.lit'&gt;
        &lt;key kex='true' rid='123'&gt;b64/encoded/data&lt;/key&gt;
      &lt;/keys&gt;
      &lt;keys jid='mercutio@verona.lit'&gt;
        &lt;key kex='true' rid='456'&gt;b64/encoded/data&lt;/key&gt;
      &lt;/keys&gt;
    &lt;/header&gt;
    &lt;payload&gt;
      base64/encoded/message/key/encrypted/envelope/element
    &lt;/payload&gt;
  &lt;/encrypted&gt;
  &lt;store xmlns='urn:xmpp:hints'/&gt;
&lt;/message&gt;
</pre></figure>
    </div>
  </div>
<h2 id="rules">6.
       Business Rules<a class="anchor-link" href="#rules"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">Before publishing a freshly generated device id for the first time, a device MUST check whether that device id already exists, and if so, generate a new one.</p>
  <p class="" style="">Clients SHOULD NOT immediately fetch the bundle and build a session as soon as a new device is announced. Before the first message is exchanged, the contact does not know which PreKey has been used (or, in fact, that any PreKey was used at all). As they have not had a chance to remove the used PreKey from their bundle announcement, this could lead to collisions where both Alice and Bob pick the same PreKey to build a session with a specific device. As each PreKey SHOULD only be used once, the party that sends their initial OMEMOKeyExchange later loses this race condition. This means that they think they have a valid session with the contact, when in reality their messages MAY be ignored by the other end. By postponing building sessions, the chance of such issues occurring can be drastically reduced. It is RECOMMENDED to construct sessions only immediately before sending a message.</p>
  <p class="" style="">After receiving an OMEMOKeyExchange and successfully building a new session, the receiving device SHOULD automatically respond with an empty OMEMO message (as per <a href="#usecases-messagesend">Sending a message</a>) to the source of the OMEMOKeyExchange. This is to notify the device that the session initiation was completed successfully and that the device can stop sending OMEMOKeyExchanges.</p>
  <p class="" style="">When receiving a message that is not an OMEMOKeyExchange from a device there is no session with, clients SHOULD create a session with that device and notify it about the new session by responding with an empty OMEMO message as per <a href="#usecases-messagesend">Sending a message</a>.</p>
  <p class="" style="">There are various reasons why decryption of an OMEMOKeyExchange or an OMEMOAuthenticatedMessage could fail. One reason is if the message was received twice and already decrypted once, in this case the client MUST ignore the decryption failure and not show any warnings/errors. In all other cases of decryption failure, clients SHOULD notify their users (if applicable), so that the users know they potentially missed a message.</p>
  <p class="" style="">If an OMEMOKeyExchange is received as part of a message catch-up mechanism (like <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0313.html">Message Archive Management (XEP-0313)</a></span>  [<a href="#nt-idm179">5</a>]) and used to establish a new session with the sender, the client SHOULD postpone deletion of the private key corresponding to the used PreKey until after the catch-up is completed. If this is done, the client MUST send an OMEMO encrypted message with empty SCE payload right after the key exchange is completed, to forward the ratchet and to move away from the possibly double-used PreKey. This practice can mitigate the previously mentioned race condition by preventing message loss.</p>
  <p class="" style="">OMEMO's forward secrecy and backup/restore mechanisms don't play well together. Restoring old data can lead to desynchronized, "broken" sessions. Because these cases exist, clients MUST offer a way to manually replace broken sessions. It is advisable to have a session replacement option per recipient/per chat, if applicable. Otherwise, at least an application-global session reset MUST be available.</p>
  <p class="" style="">When a client receives the first message for a given ratchet key with a counter of 53 or higher, it MUST send a heartbeat message. Heartbeat messages are empty OMEMO messages as per <a href="#usecases-messagesend">Sending a message</a>. These heartbeat messages cause the ratchet to forward, thus consequent messages will have the counter restarted from 0.</p>
  <p class="" style="">When a client receives a message from a device id that is not on the device list, it SHOULD try to retrieve that user's devices node directly to ensure their local cached version of the devices list is up-to-date.</p>
  <p class="" style="">When the user of a client deactivates OMEMO for an account or globally, the client SHOULD delete the corresponding bundles and device ids from the PEP nodes. That way other clients should stop encrypting for that account.</p>
<h2 id="impl">7.
       Implementation Notes<a class="anchor-link" href="#impl"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <div class="indent"><h3 id="server-side">7.1 Server side requirements<a class="anchor-link" href="#server-side"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">While OMEMO uses a Pubsub Service (<span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0060.html">Publish-Subscribe (XEP-0060)</a></span>  [<a href="#nt-idm184">6</a>]) on the user’s account it has more requirments than those defined in <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0163.html">Personal Eventing Protocol (XEP-0163)</a></span>  [<a href="#nt-idm188">7</a>]. The requirements are:</p>
    <ul class="" style="">
      <li class="" style="">The pubsub service MUST persist node items, i.e., the <a href="https://xmpp.org/extensions/xep-0060.html#features">feature 'persistent-items'</a> is announced by the service.</li>
      <li class="" style="">The pubsub service MUST support publishing options as defined in <a href="https://xmpp.org/extensions/xep-0060.html#publisher-publish-options"><span class="ref">XEP-0060</span> §7.1.5</a>.</li>
      <li class="" style="">The pubsub service MUST support 'max' as a value for the 'pubsub#persist_items' node configuration.</li>
      <li class="" style="">The pubsub service MUST support the 'open' access model for node configuration and 'pubsub#access_model' as a publish option.</li>
    </ul>
  </div>
<h2 id="security">8.
       Security Considerations<a class="anchor-link" href="#security"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">Clients MUST NOT use a newly built session to transmit data without user intervention. If a client were to opportunistically start using sessions for sending without asking the user whether to trust a device first, an attacker could publish a fake device for this user, which would then receive copies of all messages sent by/to this user. A client MAY use such "not (yet) trusted" sessions for decryption of received messages, but in that case it SHOULD indicate the untrusted nature of such messages to the user. This rule does not apply to empty OMEMO messages (as per <a href="#usecases-messagesend">Sending a message</a>) that are used purely to transfer key material, e.g. as part of heartbeat messages or automatic key exchange completion.</p>
  <p class="" style="">When prompting the user for a trust decision regarding a key, the client SHOULD present the user with a fingerprint in the form of a hex-string, QR code, or other unique representation, such that it can be compared by the user. To ensure interoperability between clients and older versions of OMEMO, the fingerprint SHOULD be chosen to be the public part of the IdentityKey in its byte-encoded Curve25519 form (see the notes on XEdDSA and the byte-encoding of public keys in the <a href="#protocol-key_exchange">X3DH protocol section</a> for details). When displaying the fingerprint as a hex-string, the RECOMMENDED way to make it easier to compare the fingerprint is to split the lowercase hex-string into 8 substrings of 8 chars each, then coloring each group of 8 lowercase hex chars using <span class="ref" style=""><a href="https://xmpp.org/extensions/xep-0392.html">Consistent Color Generation (XEP-0392)</a></span>  [<a href="#nt-idm591">16</a>].</p>
  <p class="" style="">Clients MUST NOT react to decryption errors by initiating new sessions automatically and without user interaction. An exception to this rule is specified for clients that support automatic session healing as per XEP-XXXX. TODO: Refer to the omemo-session-healing XEP as soon as it is accepted.</p>
  <p class="" style="">While it is RECOMMENDED that clients postpone private key deletion until after message catch-up, the X3DH standard mandates that clients should not use duplicate-PreKey sessions for sending, so clients MAY delete such keys immediately for security reasons. For additional information on potential security impacts of this decision, refer to  [<a href="#nt-idm595">17</a>].</p>
<h2 id="iana">9.
       IANA Considerations<a class="anchor-link" href="#iana"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">This document requires no interaction with the Internet Assigned Numbers Authority (IANA).</p>
<h2 id="registrar">10.
       XMPP Registrar Considerations<a class="anchor-link" href="#registrar"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <div class="indent"><h3 id="namespaces">10.1 Protocol Namespaces<a class="anchor-link" href="#namespaces"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">This specification defines the following XMPP namespaces:</p>
    <ul class="" style="">
      <li class="" style="">urn:xmpp:omemo:2</li>
    </ul>
  </div>
  <div class="indent"><h3 id="versioning">10.2 Protocol Versioning<a class="anchor-link" href="#versioning"><abbr title="Link to this point in the document">¶</abbr></a></h3>
    <p class="" style="">If the protocol defined in this specification undergoes a revision that is not fully backwards-compatible with an older version, the XMPP Registrar shall increment the protocol version number found at the end of the XML namespaces defined herein, as described in Section 4 of <span class="ref">XEP-0053</span>.</p>
  </div>
<h2 id="schema">11.
       XML Schema<a class="anchor-link" href="#schema"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <figure class="code"><figcaption></figcaption><pre class="prettyprint">
&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;xs:schema xmlns:xs='http://www.w3.org/2001/XMLSchema'
           targetNamespace='urn:xmpp:omemo:2'
           xmlns='urn:xmpp:omemo:2'&gt;

    &lt;xs:element name='encrypted'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:all&gt;
                &lt;xs:element ref='header'/&gt;
                &lt;xs:element ref='payload' minOccurs='0' maxOccurs='1'/&gt;
            &lt;/xs:all&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='payload' type='xs:base64Binary'/&gt;

    &lt;xs:element name='header'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:sequence maxOccurs='unbounded'&gt;
                &lt;xs:element ref='keys'/&gt;
            &lt;/xs:sequence&gt;
            &lt;xs:attribute name='sid' type='xs:unsignedInt'/&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='keys'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:sequence maxOccurs='unbounded'&gt;
                &lt;xs:element ref='key'/&gt;
            &lt;/xs:sequence&gt;
            &lt;xs:attribute name='jid' type='xs:string' use='required'/&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='key'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:simpleContent&gt;
                &lt;xs:extension base='xs:base64Binary'&gt;
                    &lt;xs:attribute name='rid' type='xs:unsignedInt' use='required'/&gt;
                    &lt;xs:attribute name='kex' type='xs:boolean' default='false'/&gt;
                &lt;/xs:extension&gt;
            &lt;/xs:simpleContent&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='devices'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:sequence maxOccurs='unbounded'&gt;
                &lt;xs:element ref='device'/&gt;
            &lt;/xs:sequence&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='device'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:attribute name='id' type='xs:unsignedInt' use='required'/&gt;
            &lt;xs:attribute name='label' type='xs:string'/&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='bundle'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:all&gt;
                &lt;xs:element ref='spk'/&gt;
                &lt;xs:element ref='spks'/&gt;
                &lt;xs:element ref='ik'/&gt;
                &lt;xs:element ref='prekeys'/&gt;
            &lt;/xs:all&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='spk'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:simpleContent&gt;
                &lt;xs:extension base='xs:base64Binary'&gt;
                    &lt;xs:attribute name='id' type='xs:unsignedInt' use='required'/&gt;
                &lt;/xs:extension&gt;
            &lt;/xs:simpleContent&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='spks' type='xs:base64Binary'/&gt;
    &lt;xs:element name='ik' type='xs:base64Binary'/&gt;

    &lt;xs:element name='prekeys'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:sequence maxOccurs='unbounded'&gt;
                &lt;xs:element ref='pk'/&gt;
            &lt;/xs:sequence&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;

    &lt;xs:element name='pk'&gt;
        &lt;xs:complexType&gt;
            &lt;xs:simpleContent&gt;
                &lt;xs:extension base='xs:base64Binary'&gt;
                    &lt;xs:attribute name='id' type='xs:unsignedInt' use='required'/&gt;
                &lt;/xs:extension&gt;
            &lt;/xs:simpleContent&gt;
        &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;
&lt;/xs:schema&gt;
</pre></figure>
<h2 id="protobuf-schema">12.
       Protobuf Schema<a class="anchor-link" href="#protobuf-schema"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <figure class="code"><figcaption></figcaption><pre class="prettyprint">
message OMEMOMessage {
    required uint32 n          = 1;
    required uint32 pn         = 2;
    required bytes  dh_pub     = 3;
    optional bytes  ciphertext = 4;
}

message OMEMOAuthenticatedMessage {
    required bytes mac     = 1;
    required bytes message = 2; // Byte-encoding of an OMEMOMessage
}

message OMEMOKeyExchange {
    required uint32 pk_id  = 1;
    required uint32 spk_id = 2;
    required bytes  ik     = 3;
    required bytes  ek     = 4;
    required OMEMOAuthenticatedMessage message = 5;
}
</pre></figure>
<h2 id="ack">13.
       Acknowledgements<a class="anchor-link" href="#ack"><abbr title="Link to this point in the document">¶</abbr></a></h2>
  <p class="" style="">Big thanks to Daniel Gultsch for mentoring me during the development of this protocol. Thanks to Thijs Alkemade and Cornelius Aschermann for talking through some of the finer points of the protocol with me. And lastly I would also like to thank Sam Whited, Holger Weiss, and Florian Schmaus for their input on the standard.</p>
  <p class="" style="">The authors would like to thank the Chaosdorf for hosting them during the development of version 0.4.0 of this specification.</p>
  <p class="" style="">Furthermore, the authors want to thank Sofía Celi for her feedback and input on the document.</p>
<hr><a name="appendices"></a><h2>Appendices</h2><h3 id="appendix-docinfo">Appendix A: Document Information<a class="anchor-link" href="#appendix-docinfo"><abbr title="Link to this point in the document">¶</abbr></a></h3><dl class="compact"><dt>Series</dt><dd><a href="https://xmpp.org/extensions/">XEP</a></dd><dt>Number</dt><dd>0384</dd><dt>Publisher</dt><dd><a href="/xsf/">XMPP Standards Foundation</a></dd><dt>Status</dt><dd><a href="https://xmpp.org/extensions/xep-0001.html#states-Experimental">Experimental</a></dd><dt>Type</dt><dd><a href="https://xmpp.org/extensions/xep-0001.html#types-Standards%20Track">Standards Track</a></dd><dt>Version</dt><dd>0.8.1</dd><dt>Last Updated</dt><dd>2021-10-07</dd><dt>Approving Body</dt><dd><a href="https://xmpp.org/council/">XMPP Council</a></dd><dt>Dependencies</dt><dd>XMPP Core, XEP-0060, XEP-0163, XEP-0420</dd><dt>Supersedes</dt><dd>None</dd><dt>Superseded By</dt><dd>None</dd><dt>Short Name</dt><dd>OMEMO</dd><dt>Source Control</dt><dd><a class="standardsButton" href="https://github.com/xsf/xeps/blob/master/xep-0384.xml">HTML</a></dd></dl><p>
          This document in other formats:
          <a class="standardsButton" href="https://xmpp.org/extensions/xep-0384.xml">XML</a> 
          <a class="standardsButton" href="https://xmpp.org/extensions/xep-0384.pdf">PDF</a></p><h3 id="appendix-authorinfo">Appendix B: Author Information<a class="anchor-link" href="#appendix-authorinfo"><abbr title="Link to this point in the document">¶</abbr></a></h3><h5>Andreas Straub</h5><dl class="compact"><dt>Email</dt><dd><a href="mailto:andy@strb.org">andy@strb.org</a></dd><dt>JabberID</dt><dd><a href="xmpp:andy@strb.org">andy@strb.org</a></dd></dl><h5>Daniel Gultsch</h5><dl class="compact"><dt>Email</dt><dd><a href="mailto:daniel@gultsch.de">daniel@gultsch.de</a></dd><dt>JabberID</dt><dd><a href="xmpp:daniel@gultsch.de">daniel@gultsch.de</a></dd></dl><h5>Tim Henkes</h5><dl class="compact"><dt>Email</dt><dd><a href="mailto:me@syndace.dev">me@syndace.dev</a></dd></dl><h5>Klaus Herberth</h5><dl class="compact"><dt>JabberID</dt><dd><a href="xmpp:klaus@jsxc.org">klaus@jsxc.org</a></dd></dl><h5>Paul Schaub</h5><dl class="compact"><dt>Email</dt><dd><a href="mailto:vanitasvitae@riseup.net">vanitasvitae@riseup.net</a></dd><dt>JabberID</dt><dd><a href="xmpp:vanitasvitae@jabberhead.tk">vanitasvitae@jabberhead.tk</a></dd></dl><h5>Marvin Wißfeld</h5><dl class="compact"><dt>Email</dt><dd><a href="mailto:xmpp@larma.de">xmpp@larma.de</a></dd><dt>JabberID</dt><dd><a href="xmpp:jabber@larma.de">jabber@larma.de</a></dd></dl><h3 id="appendix-legal">Appendix C: Legal Notices<a class="anchor-link" href="#appendix-legal"><abbr title="Link to this point in the document">¶</abbr></a></h3><div class="indent"><h4>Copyright</h4><p>This XMPP Extension Protocol is copyright © 1999 – 2020 by the <a href="https://xmpp.org/">XMPP Standards Foundation</a> (XSF).</p><h4>Permissions</h4><p>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the "Specification"), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.</p><h4>Disclaimer of Warranty</h4><p class="box info">## NOTE WELL: This Specification is provided on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. ##</p><h4>Limitation of Liability</h4><p>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.</p><h4>IPR Conformance</h4><p>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which can be found at &lt;<a href="https://xmpp.org/about/xsf/ipr-policy">https://xmpp.org/about/xsf/ipr-policy</a>&gt; or obtained by writing to XMPP Standards Foundation, P.O. Box 787, Parker, CO 80134 USA).</p><h4>Visual Presentation</h4><p>The HTML representation (you are looking at) is maintained by the XSF. It is based on the <a href="http://yaml.de">YAML CSS Framework</a>, which is licensed under the terms of the <a href="https://creativecommons.org/licenses/by/2.0/">CC-BY-SA 2.0</a> license.</p></div><h3 id="appendix-xmpp">Appendix D: Relation to XMPP<a class="anchor-link" href="#appendix-xmpp"><abbr title="Link to this point in the document">¶</abbr></a></h3><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 6120) and XMPP IM (RFC 6121) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h3 id="appendix-discuss">Appendix E: Discussion Venue<a class="anchor-link" href="#appendix-discuss"><abbr title="Link to this point in the document">¶</abbr></a></h3><p class="indent">The primary venue for discussion of XMPP Extension Protocols is the &lt;<a href="https://mail.jabber.org/mailman/listinfo/standards">standards@xmpp.org</a>&gt; discussion list.</p><p class="indent">Discussion on other xmpp.org discussion lists might also be appropriate; see &lt;<a href="https://xmpp.org/about/discuss.shtml">https://xmpp.org/about/discuss.shtml</a>&gt; for a complete list.</p><p class="indent">Errata can be sent to &lt;<a href="mailto:editor@xmpp.org">editor@xmpp.org</a>&gt;.</p><h3 id="appendix-conformance">Appendix F: Requirements Conformance<a class="anchor-link" href="#appendix-conformance"><abbr title="Link to this point in the document">¶</abbr></a></h3><p class="indent">The following requirements keywords as used in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><h3 id="appendix-notes">Appendix G: Notes<a class="anchor-link" href="#appendix-notes"><abbr title="Link to this point in the document">¶</abbr></a></h3><div class="indent"><p><a name="nt-idm159">1</a>. XEP-0364: Current Off-the-Record Messaging Usage &lt;<a href="https://xmpp.org/extensions/xep-0364.html">https://xmpp.org/extensions/xep-0364.html</a>&gt;.</p><p><a name="nt-idm163">2</a>. XEP-0027: Current Jabber OpenPGP Usage &lt;<a href="https://xmpp.org/extensions/xep-0027.html">https://xmpp.org/extensions/xep-0027.html</a>&gt;.</p><p><a name="nt-idm167">3</a>. XEP-0373: OpenPGP for XMPP &lt;<a href="https://xmpp.org/extensions/xep-0373.html">https://xmpp.org/extensions/xep-0373.html</a>&gt;.</p><p><a name="nt-idm175">4</a>. XEP-0280: Message Carbons &lt;<a href="https://xmpp.org/extensions/xep-0280.html">https://xmpp.org/extensions/xep-0280.html</a>&gt;.</p><p><a name="nt-idm179">5</a>. XEP-0313: Message Archive Management &lt;<a href="https://xmpp.org/extensions/xep-0313.html">https://xmpp.org/extensions/xep-0313.html</a>&gt;.</p><p><a name="nt-idm184">6</a>. XEP-0060: Publish-Subscribe &lt;<a href="https://xmpp.org/extensions/xep-0060.html">https://xmpp.org/extensions/xep-0060.html</a>&gt;.</p><p><a name="nt-idm188">7</a>. XEP-0163: Personal Eventing Protocol &lt;<a href="https://xmpp.org/extensions/xep-0163.html">https://xmpp.org/extensions/xep-0163.html</a>&gt;.</p><p><a name="nt-idm236">8</a>. The Double Ratchet Algorithm &lt;<a href="https://signal.org/docs/specifications/doubleratchet/">https://signal.org/docs/specifications/doubleratchet/</a>&gt;.</p><p><a name="nt-idm240">9</a>. The X3DH Key Agreement Protocol &lt;<a href="https://www.signal.org/docs/specifications/x3dh/">https://www.signal.org/docs/specifications/x3dh/</a>&gt;.</p><p><a name="nt-idm286">10</a>. The XEdDSA and VXEdDSA Signature Schemes &lt;<a href="https://www.signal.org/docs/specifications/xeddsa/">https://www.signal.org/docs/specifications/xeddsa/</a>&gt;.</p><p><a name="nt-idm296">11</a>. RFC 7748: Elliptic Curves for Security &lt;<a href="http://tools.ietf.org/html/rfc7748">http://tools.ietf.org/html/rfc7748</a>&gt;.</p><p><a name="nt-idm318">12</a>. RFC 8032: Edwards-Curve Digital Signature Algorithm (EdDSA) &lt;<a href="http://tools.ietf.org/html/rfc8032">http://tools.ietf.org/html/rfc8032</a>&gt;.</p><p><a name="nt-idm487">13</a>. XEP-0420: Stanza Content Encryption &lt;<a href="https://xmpp.org/extensions/xep-0420.html">https://xmpp.org/extensions/xep-0420.html</a>&gt;.</p><p><a name="nt-idm524">14</a>. XEP-0045: Multi-User Chat &lt;<a href="https://xmpp.org/extensions/xep-0045.html">https://xmpp.org/extensions/xep-0045.html</a>&gt;.</p><p><a name="nt-idm528">15</a>. XEP-0369: Mediated Information eXchange (MIX) &lt;<a href="https://xmpp.org/extensions/xep-0369.html">https://xmpp.org/extensions/xep-0369.html</a>&gt;.</p><p><a name="nt-idm591">16</a>. XEP-0392: Consistent Color Generation &lt;<a href="https://xmpp.org/extensions/xep-0392.html">https://xmpp.org/extensions/xep-0392.html</a>&gt;.</p><p><a name="nt-idm595">17</a>. Menezes, Alfred, and Berkant Ustaoglu. "On reusing ephemeral keys in Diffie-Hellman key agreement protocols." International Journal of Applied Cryptography 2, no. 2 (2010): 154-158.</p></div><h3 id="appendix-revs">Appendix H: Revision History<a class="anchor-link" href="#appendix-revs"><abbr title="Link to this point in the document">¶</abbr></a></h3><p>Note: Older versions of this specification might be available at <a href="https://xmpp.org/extensions/attic/">https://xmpp.org/extensions/attic/</a></p><ol class="revision-history"><li id="revision-history-v0.8.1"><div class="revision-head">Version 0.8.1 (2021-10-07)<a class="anchor-link" href="#revision-history-v0.8.1"><abbr title="Link to this point in the document">¶</abbr></a></div>
      <p class="" style="">Adjust remaining namespaces:</p>
      <ul class="" style="">
        <li class="" style="">Update namespace to 'urn:xmpp:omemo:2:bundles'</li>
        <li class="" style="">Update namespace to 'urn:xmpp:omemo:2:devices'</li>
      </ul>
    <div class="revision-author">melvo</div></li><li id="revision-history-v0.8.0"><div class="revision-head">Version 0.8.0 (2021-09-28)<a class="anchor-link" href="#revision-history-v0.8.0"><abbr title="Link to this point in the document">¶</abbr></a></div>
      <p class="" style="">Update to XEP-0420 version 0.4.0 and adjust namespace:</p>
      <ul class="" style="">
        <li class="" style="">Replace SCE's old 'content' element by its new 'envelope' element</li>
        <li class="" style="">Replace SCE's old 'payload' element by its new 'content' element</li>
        <li class="" style="">Update SCE's namespace to 'urn:xmpp:sce:1'</li>
        <li class="" style="">Update namespace to 'urn:xmpp:omemo:2'</li>
      </ul>
    <div class="revision-author">melvo</div></li><li id="revision-history-v0.7.0"><div class="revision-head">Version 0.7.0 (2020-09-05)<a class="anchor-link" href="#revision-history-v0.7.0"><abbr title="Link to this point in the document">¶</abbr></a></div>
      <ul class="" style="">
        <li class="" style="">Various fixes, clarifications and general improvements.</li>
      </ul>
    <div class="revision-author">th</div></li><li id="revision-history-v0.6.0"><div class="revision-head">Version 0.6.0 (2020-06-09)<a class="anchor-link" href="#revision-history-v0.6.0"><abbr title="Link to this point in the document">¶</abbr></a></div>
      <p class="" style="">Incorporate feedback around cryptographic terms and content by Sofía Celi.</p>
    <div class="revision-author">ps</div></li><li id="revision-history-v0.5.0"><div class="revision-head">Version 0.5.0 (2020-03-26)<a class="anchor-link" href="#revision-history-v0.5.0"><abbr title="Link to this point in the document">¶</abbr></a></div>
      <ul class="" style="">
        <li class="" style="">Usage of Ed25519 public keys, made XEdDSA optional.</li>
        <li class="" style="">Threat model added.</li>
      </ul>
    <div class="revision-author">th</div></li><li id="revision-history-v0.4.0"><div class="revision-head">Version 0.4.0 (2020-03-08)<a class="anchor-link" href="#revision-history-v0.4.0"><abbr title="Link to this point in the document">¶</abbr></a></div>
      <ul class="" style="">
        <li class="" style="">Incorporate the double ratchet protocol specification.</li>
        <li class="" style="">Use one node to store all bundles. One item per bundle.</li>
        <li class="" style="">Recommend 'open' access model for both PEP nodes.</li>
        <li class="" style="">Specify OMEMO encryption for XEP-0045 Multi-User Chats.</li>
        <li class="" style="">Use XEP-0420: Stanza Content Encryption.</li>
        <li class="" style="">Use AES256/CBC to encrypt SCE payload.</li>
        <li class="" style="">Change namespace to <code>urn:xmpp:omemo:1</code></li>
        <li class="" style="">Use wrapping 'keys' element for key elements in 'header'.</li>
        <li class="" style="">Define threat model</li>
        <li class="" style="">Change the state back to Experimental</li>
      </ul>
    <div class="revision-author">dg</div></li><li id="revision-history-v0.3.0"><div class="revision-head">Version 0.3.0 (2018-07-31)<a class="anchor-link" href="#revision-history-v0.3.0"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">Make examples show items published to the id "current", as per <span class="ref">XEP-0060</span> §12.20.</p><div class="revision-author">egp</div></li><li id="revision-history-v0.2.2"><div class="revision-head">Version 0.2.2 (2018-11-03)<a class="anchor-link" href="#revision-history-v0.2.2"><abbr title="Link to this point in the document">¶</abbr></a></div>Fix a bunch of typos, batch-style.<div class="revision-author">pep</div></li><li id="revision-history-v0.2.1"><div class="revision-head">Version 0.2.1 (2018-05-21)<a class="anchor-link" href="#revision-history-v0.2.1"><abbr title="Link to this point in the document">¶</abbr></a></div>Fix attribute names in schema<div class="revision-author">mb</div></li><li id="revision-history-v0.2"><div class="revision-head">Version 0.2 (2017-06-02)<a class="anchor-link" href="#revision-history-v0.2"><abbr title="Link to this point in the document">¶</abbr></a></div>
      <p class="" style="">Depend on SignalProtocol instead of Olm.</p>
      <p class="" style="">Changed to eu.siacs.conversations.axolotl Namespace which is currently used in the wild</p>
    <div class="revision-author">dg</div></li><li id="revision-history-v0.1"><div class="revision-head">Version 0.1 (2016-12-07)<a class="anchor-link" href="#revision-history-v0.1"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">Initial version approved by the council.</p><div class="revision-author">XEP Editor: ssw</div></li><li id="revision-history-v0.0.2"><div class="revision-head">Version 0.0.2 (2016-09-22)<a class="anchor-link" href="#revision-history-v0.0.2"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">Depend on Olm instead of Axolotl.</p><div class="revision-author">ssw, dg</div></li><li id="revision-history-v0.0.1"><div class="revision-head">Version 0.0.1 (2015-10-25)<a class="anchor-link" href="#revision-history-v0.0.1"><abbr title="Link to this point in the document">¶</abbr></a></div><p class="" style="">First draft.</p><div class="revision-author">as</div></li></ol><h3 id="appendix-biblatex">Appendix I: Bib(La)TeX Entry</h3><pre>
@report{straub2015omemo,
  title = {OMEMO Encryption},
  author = {Straub, Andreas and Gultsch, Daniel and Henkes, Tim and Herberth, Klaus and Schaub, Paul and Wißfeld, Marvin},
  type = {XEP},
  number = {0384},
  version = {0.8.1},
  institution = {XMPP Standards Foundation},
  url = {https://xmpp.org/extensions/xep-0384.html},
  date = {2015-10-25/2021-10-07},
}</pre><p>END</p></body></html>
