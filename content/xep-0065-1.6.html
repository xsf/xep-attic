<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0065: SOCKS5 Bytestreams</title><link rel="stylesheet" type="text/css" href="/xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="SOCKS5 Bytestreams" /><meta name="DC.Creator" content="Dave Smith" /><meta name="DC.Creator" content="Matthew Miller" /><meta name="DC.Creator" content="Peter Saint-Andre" /><meta name="DC.Description" content="This document defines an XMPP protocol extension for establishing an out-of-band bytestream between any two Jabber entities." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2004-11-12" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0065" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright 1999 - 2007 by the XMPP Standards Foundation (XSF) and is in full conformance with the XSF's Intellectual Property Rights Policy &lt;http://www.xmpp.org/extensions/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;)." /></head><body><h1>XEP-0065: SOCKS5 Bytestreams</h1><p>This document defines an XMPP protocol extension for establishing an out-of-band bytestream between any two Jabber entities.</p><hr /><p style="color:green">NOTICE: The protocol defined herein is a Draft Standard of the XMPP Standards Foundation. Implementations are encouraged and the protocol is appropriate for deployment in production systems, but some changes to the protocol are possible before it becomes a Final Standard.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0065<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Draft">Draft</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards Track">Standards Track</a><br />
            Version: 1.6<br />
            Last Updated: 2004-11-12<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core, RFC 1928, RFC 3174, XEP-0030<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: bytestreams<br />
        Schema: &lt;<a href="http://www.xmpp.org/schemas/bytestreams.xsd">http://www.xmpp.org/schemas/bytestreams.xsd</a>&gt;<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/SOCKS5 Bytestreams (XEP-0065)">http://wiki.jabber.org/index.php/SOCKS5 Bytestreams (XEP-0065)</a>&gt;
            </p><h2>Author Information</h2><div class="indent"><h3>Dave Smith</h3><p class="indent">
        Email:
        <a href="mailto:dizzyd@jabber.org">dizzyd@jabber.org</a><br />
        JabberID: 
        <a href="xmpp:dizzyd@jabber.org">dizzyd@jabber.org</a></p><h3>Matthew Miller</h3><p class="indent">
        Email:
        <a href="mailto:linuxwolf@outer-planes.net">linuxwolf@outer-planes.net</a><br />
        JabberID: 
        <a href="xmpp:linuxwolf@outer-planes.net">linuxwolf@outer-planes.net</a></p><h3>Peter Saint-Andre</h3><p class="indent">
        Email:
        <a href="mailto:stpeter@jabber.org">stpeter@jabber.org</a><br />
        JabberID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a></p></div><h2>Legal Notice</h2><p class="indent">This XMPP Extension Protocol is copyright 1999 - 2007 by the <a href="http://www.xmpp.org/xsf/">XMPP Standards Foundation</a> (XSF) and is in full conformance with the XSF's Intellectual Property Rights Policy &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><p class="indent">Given that this XMPP Extension Protocol normatively references IETF technologies, discussion on the XSF-IETF list may also be appropriate (see &lt;<a href="http://mail.jabber.org/mailman/listinfo/jsf-ietf">http://mail.jabber.org/mailman/listinfo/jsf-ietf</a>&gt; for details).</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in RFC 2119: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />2.  <a href="#terms">Terminology</a><br />3.  <a href="#narrative">Narrative</a><br />&#xA0;&#xA0;&#xA0;
      3.1.  <a href="#narr-direct">Direct Connection</a><br />&#xA0;&#xA0;&#xA0;
      3.2.  <a href="#narr-mediated">Mediated Connection</a><br />4.  <a href="#proto">Protocol</a><br />&#xA0;&#xA0;&#xA0;
      4.1.  <a href="#proto-disco">Initiator Queries Target Regarding Bytestreams Support</a><br />&#xA0;&#xA0;&#xA0;
      4.2.  <a href="#proto-proxies">Initiator Queries Server For Proxies</a><br />&#xA0;&#xA0;&#xA0;
      4.3.  <a href="#proto-proxyinfo">Initiator Queries Proxy to Find Out if it is a Proxy</a><br />&#xA0;&#xA0;&#xA0;
      4.4.  <a href="#proto-address">Initiator Discovers Network Address of StreamHost</a><br />&#xA0;&#xA0;&#xA0;
      4.5.  <a href="#proto-inform">Initiator Informs Target of StreamHosts</a><br />&#xA0;&#xA0;&#xA0;
      4.6.  <a href="#proto-establish">Target Establishes SOCKS5 Connection with StreamHost</a><br />&#xA0;&#xA0;&#xA0;
      4.7.  <a href="#proto-ack">Target Acknowledges SOCKS5 Connection</a><br />&#xA0;&#xA0;&#xA0;
      4.8.  <a href="#proto-initiator">Initiator Establishes SOCKS5 Connection with StreamHost</a><br />&#xA0;&#xA0;&#xA0;
      4.9.  <a href="#proto-activation">Activation of Bytestream</a><br />5.  <a href="#usecase">Formal Use Case</a><br />&#xA0;&#xA0;&#xA0;
      5.1.  <a href="#usecase-primary">Primary Flow</a><br />&#xA0;&#xA0;&#xA0;
      5.2.  <a href="#usecase-alternate">Alternate Flows</a><br />6.  <a href="#desc">Formal Description</a><br />&#xA0;&#xA0;&#xA0;
      6.1.  <a href="#desc-query">&lt;query/&gt; Element</a><br />&#xA0;&#xA0;&#xA0;
      6.2.  <a href="#desc-streamhost">&lt;streamhost/&gt; Element</a><br />&#xA0;&#xA0;&#xA0;
      6.3.  <a href="#desc-streamhost-used">&lt;streamhost-used/&gt; Element</a><br />&#xA0;&#xA0;&#xA0;
      6.4.  <a href="#desc-activate">&lt;activate/&gt; Element</a><br />7.  <a href="#udp">Optional UDP Support</a><br />&#xA0;&#xA0;&#xA0;
      7.1.  <a href="#udp-disco">Discovering UDP Support</a><br />&#xA0;&#xA0;&#xA0;
      7.2.  <a href="#udp-request">Requesting UDP Mode</a><br />&#xA0;&#xA0;&#xA0;
      7.3.  <a href="#udp-process">UDP Process</a><br />&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;
      7.3.1.  <a href="#udp-process-assoc">Establishing the UDP Association</a><br />&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;
      7.3.2.  <a href="#udp-process-init">Initializing the UDP Channel</a><br />&#xA0;&#xA0;&#xA0;
      7.4.  <a href="#udp-ports">Exchanging UDP Packets</a><br />8.  <a href="#impl">Implementation Notes</a><br />&#xA0;&#xA0;&#xA0;
      8.1.  <a href="#impl-streamhost">StreamHost Requirements</a><br />&#xA0;&#xA0;&#xA0;
      8.2.  <a href="#impl-socks5">SOCKS5 Parameter Mapping</a><br />9.  <a href="#security">Security Considerations</a><br />10.  <a href="#iana">IANA Considerations</a><br />11.  <a href="#registrar">XMPP Registrar Considerations</a><br />&#xA0;&#xA0;&#xA0;
      11.1.  <a href="#registrar-ns">Protocol Namespaces</a><br />&#xA0;&#xA0;&#xA0;
      11.2.  <a href="#registrar-discovar">Service Discovery Features</a><br />&#xA0;&#xA0;&#xA0;
      11.3.  <a href="#registrar-discoid">Service Discovery Category/Type</a><br />12.  <a href="#schema">Schema</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
  <p class="" style="">XMPP is designed for sending relatively small fragments of XML between network entities (see <span class="ref" style="">XMPP Core</span>  [<a href="#nt-id2251135">1</a>]) and is not designed for sending binary data. However, sometimes it is desirable to send binary data to another entity that one has discovered on the XMPP network (e.g., to send a file). Therefore it is widely recognized within the Jabber community that it would be valuable to have a generic protocol for streaming binary data between any two entities on the network. The main application for such a bytestreaming technology would be file transfer, for which there are currently a number of incompatible protocols (resulting in a lack of interoperability). However, other applications are possible, which is why it is important to develop a generic protocol rather than one that is specialized for a particular application such as file transfer. This document defines a protocol that meets the following conditions:</p>
  <ul class="" style="">
    <li class="" style="">Bytestreams are established over standard TCP connections (<span class="ref" style="">RFC 793</span>  [<a href="#nt-id2251187">2</a>]) or UDP associations (<span class="ref" style="">RFC 768</span>  [<a href="#nt-id2251210">3</a>]), where TCP support is REQUIRED and UDP support is OPTIONAL</li>
    <li class="" style="">Sockets may be direct (peer-to-peer) or mediated (established through a bytestreaming service)</li>
    <li class="" style="">Where possible, standard wire protocols are used</li>
  </ul>
  <p class="" style="">Specifically, this document proposes that the Jabber community make use of the SOCKS 5 protocol, which is an IETF-approved, IPv6-ready technology for bytestreams. (Note: Because this proposal uses a subset of the SOCKS5 protocol that is specially adapted for Jabber bytestreams, existing SOCKS5 proxies cannot be used to implement this proposal without modifications.)</p>
<h2>2.
       <a name="terms" id="terms">Terminology</a></h2>
  <p class="" style="">The following terms are used throughout this document.</p>
  <p class="caption">Table 1: Glossary of Entities</p><table border="1" cellpadding="3" cellspacing="0">
    <tr class="body">
      <th colspan="" rowspan="">Term</th><th colspan="" rowspan="">Description</th>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">Initiator</td>
      <td colspan="" rowspan="">A Jabber Entity that wishes to establish a bytestream with another Entity</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">Target</td>
      <td colspan="" rowspan="">The Entity with which the Initiator is attempting to establish a bytestream</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">Proxy</td>
      <td colspan="" rowspan="">A Jabber entity which is not NAT/Firewalled and is willing to be a middleman for the bytestream between the Initiator and the Target</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">StreamHost</td>
      <td colspan="" rowspan="">The system that the Target connects to and that is "hosting" the bytestream -- may be either the Initiator or a Proxy</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">StreamID</td>
      <td colspan="" rowspan="">A relatively unique Stream ID for this connection; this is generated by the Initiator for tracking purposes and MUST be less than 128 characters in length</td>
    </tr>
  </table>
<h2>3.
       <a name="narrative" id="narrative">Narrative</a></h2>
  <p class="" style="">There are two scenarios addressed by this protocol:</p>
  <ol start="" class="" style="">
    <li class="" style="">direct connection (i.e., the StreamHost is the Initiator)</li>
    <li class="" style="">mediated connection (i.e., the StreamHost is a Proxy)</li>
  </ol>
  <p class="" style="">The "happy paths" for these scenarios are described separately below for ease of understanding. A full description of these scenarios is captured in the Formal Use Case. This narrative describes TCP connections only; UDP associations are described in the <a href="#udp">Optional UDP Support</a> section of this document.</p>
  <div class="indent"><h3>3.1 <a name="narr-direct" id="narr-direct">Direct Connection</a></h3>
    <p class="" style="">Direct connection is the simpler case. In this situation, the StreamHost is the Initiator (StreamHost/Initiator), which means that the Initiator knows the network address of the StreamHost and knows when to activate the bytestream. The process for establishing bytestreams in this case is as follows:</p>
    <ol start="" class="" style="">
      <li class="" style=""><p class="" style="">Initiator sends IQ-set to Target specifying the full JID and network address of StreamHost/Initiator as well as the StreamID (SID) of the proposed bytestream.</p></li>
      <li class="" style=""><p class="" style="">Target opens a TCP socket to the specified network address.</p></li>
      <li class="" style=""><p class="" style="">Target requests connection 
       via SOCKS5, with the DST.ADDR and DST.PORT parameters set to the values defined below.</p></li>
      <li class="" style=""><p class="" style="">StreamHost/Initiator sends acknowledgement of successful connection to Target via SOCKS5.</p></li>
      <li class="" style=""><p class="" style="">Target sends IQ-result to Initiator, preserving the 'id' of the initial IQ-set.</p></li>
      <li class="" style=""><p class="" style="">StreamHost/Initiator activates the bytestream.</p></li>
      <li class="" style=""><p class="" style="">Initiator and Target may begin using the bytestream.</p></li>
    </ol>
  </div>
  <div class="indent"><h3>3.2 <a name="narr-mediated" id="narr-mediated">Mediated Connection</a></h3>
    <p class="" style="">Mediated connection is slightly more complicated. In this situation, the StreamHost is not the Initiator but a Proxy, which means that the Initiator must discover the network address of the StreamHost before sending the initial IQ-set, must negotiate a connection with the StreamHost in the same way that the Target does, and must request that the StreamHost activate the bytestream before it can be used. The process for establishing bytestreams in this case is as follows:</p>
    <ol start="" class="" style="">
      <li class="" style=""><p class="" style="">Optionally, Initiator discovers the network address of StreamHost in-band.</p></li>
      <li class="" style=""><p class="" style="">Initiator sends IQ-set to Target specifying the full JID and network address of StreamHost as well as the StreamID (SID) of the proposed bytestream.</p></li>
      <li class="" style=""><p class="" style="">Target opens a TCP socket to the selected StreamHost.</p></li>
      <li class="" style=""><p class="" style="">Target establishes connection via SOCKS5, with the DST.ADDR and DST.PORT parameters set to the values defined below.</p></li>
      <li class="" style=""><p class="" style="">StreamHost sends acknowledgement of successful connection to Target via SOCKS5.</p></li>
      <li class="" style=""><p class="" style="">Target sends IQ-result to Initiator, preserving the 'id' of the initial IQ-set.</p></li>
      <li class="" style=""><p class="" style="">Initiator opens a TCP socket at the StreamHost.</p></li>
      <li class="" style=""><p class="" style="">Initiator establishes connection via SOCKS5, with the DST.ADDR and DST.PORT parameters set to the values defined below.</p></li>
      <li class="" style=""><p class="" style="">StreamHost sends acknowledgement of successful connection to Initiator via SOCKS5.</p></li>
      <li class="" style=""><p class="" style="">Initiator sends IQ-set to StreamHost requesting that StreamHost activate the bytestream associated with the StreamID.</p></li>
      <li class="" style=""><p class="" style="">StreamHost activates the bytestream. (Data is now relayed between the two SOCKS5 connections by the proxy.)</p></li>
      <li class="" style=""><p class="" style="">StreamHost sends IQ-result to Initiator acknowledging that the bytestream has been activated (or specifying an error).</p></li>
      <li class="" style=""><p class="" style="">Initiator and Target may begin using the bytestream.</p></li>
    </ol>
  </div>
<h2>4.
       <a name="proto" id="proto">Protocol</a></h2>
  <div class="indent"><h3>4.1 <a name="proto-disco" id="proto-disco">Initiator Queries Target Regarding Bytestreams Support</a></h3>
    <p class="" style="">Before attempting to initiate a bytestream, the Initiator may want to know if the Target supports the bytestream protocol. It may do so using <span class="ref" style="">Service Discovery</span>  [<a href="#nt-id2259022">4</a>] as follows:</p>
    <p class="caption"><a name="example-1" id="example-1"></a>Example 1. Initiator Sends Service Discovery Request to Target</p><div class="indent"><pre>
&lt;iq type='get' 
    from='initiator@host1/foo' 
    to='target@host2/bar' 
    id='hello'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the Target supports bytestreams, it MUST answer to that effect in the service discovery result.</p>
    <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Target Replies to Service Discovery Request</p><div class="indent"><pre>
&lt;iq type='result' 
    from='target@host2/bar' 
    to='initiator@host1/foo' 
    id='hello'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    &lt;identity 
        category='proxy'
        type='bytestreams'
        name='SOCKS5 Bytestreams Service'/&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/bytestreams'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>4.2 <a name="proto-proxies" id="proto-proxies">Initiator Queries Server For Proxies</a></h3>
    <p class="" style="">Before attempting to initiate a bytestream, the Initiator needs to find a proxy. It may do so using Service Discovery as follows:</p>
    <p class="caption"><a name="example-3" id="example-3"></a>Example 3. Initiator Sends Service Discovery Request to Server</p><div class="indent"><pre>
&lt;iq type='get' 
    from='initiator@host1/foo'
    to='host1' 
    id='server_items'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#items'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The server will return all of the known JIDs in its disco list.</p>
    <p class="caption"><a name="example-4" id="example-4"></a>Example 4. Server Replies to Service Discovery Request</p><div class="indent"><pre>
&lt;iq type='result' 
    from='host1' 
    to='initiator@host1/foo' 
    id='server_items'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#items'&gt;
    ...
    &lt;item jid='proxy.host3' name='Bytestreams Proxy'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>4.3 <a name="proto-proxyinfo" id="proto-proxyinfo">Initiator Queries Proxy to Find Out if it is a Proxy</a></h3>
    <p class="" style="">For each item in the disco#items result, the Initiator must query to determine if it is a bytestreams proxy. It may do so using Service Discovery as follows:</p>
    <p class="caption"><a name="example-5" id="example-5"></a>Example 5. Initiator Sends Service Discovery Request to Proxy</p><div class="indent"><pre>
&lt;iq type='get' 
    from='initiator@host1/foo'
    to='proxy.host3' 
    id='proxy_info'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The proxy will return its information. The Initiator SHOULD inspect each identity to see if it contains an identity of category "proxy" and type "bytestreams".</p>
    <p class="caption"><a name="example-6" id="example-6"></a>Example 6. Server Replies to Service Discovery Request</p><div class="indent"><pre>
&lt;iq type='result' 
    from='proxy.host3' 
    to='initiator@host1/foo' 
    id='proxy_info'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    ...
    &lt;identity category='proxy'
              type='bytestreams'
              name='SOCKS5 Bytestreams Service'/&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/bytestreams'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>4.4 <a name="proto-address" id="proto-address">Initiator Discovers Network Address of StreamHost</a></h3>
    <p class="" style="">If the StreamHost is a Proxy, the Initiator must first request the full network address used for bytestreaming (obviously this is not required if the StreamHost is the Initiator). This is done by sending an IQ-get to the proxy in the bytestreams namespace, as follows:</p>
    <p class="caption"><a name="example-7" id="example-7"></a>Example 7. Initiator Requests Network Address from Proxy</p><div class="indent"><pre>
&lt;iq type='get' 
    from='initiator@host1/foo' 
    to='proxy.host3' 
    id='discover'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">The &lt;streamhost/&gt; element specifying a network address MUST possess the following attributes:</p>
    <ul class="" style="">
      <li class="" style=""><span class="cite">jid</span> = the JID of the StreamHost for communications over Jabber</li>
    </ul>
    <p class="" style="">In addition, the &lt;streamhost/&gt; element MUST include:</p>
    <p class="" style="">EITHER</p>
    <ul class="" style="">
      <li class="" style=""><span class="cite">host</span> = the hostname or IP address of the StreamHost for SOCKS5 communications over TCP</li>
      <li class="" style=""><span class="cite">port</span> = a port associated with the hostname or IP address for
        SOCKS5 communications over TCP</li>
    </ul>
    <p class="" style="">OR</p>
    <ul class="" style="">
      <li class="" style=""><span class="cite">zeroconf</span> = a zeroconf  [<a href="#nt-id2259281">5</a>] identifier to which an entity may connect, for which the service identifier and protocol name SHOULD be "_jabber.bytestreams".</li>
    </ul>
    <p class="caption"><a name="example-8" id="example-8"></a>Example 8. Proxy Informs Initiator of Network Address</p><div class="indent"><pre>
&lt;iq type='result' 
    from='proxy.host3' 
    to='initiator@host1/foo' 
    id='discover'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams'&gt;
    &lt;streamhost 
        jid='proxy.host3' 
        host='24.24.24.1' 
        zeroconf='_jabber.bytestreams'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the Initiator does not have permissions to initiate bytestreams on the Proxy for whatever reason (e.g., a proxy implementation may enable administrators to ban JIDs or domains from using the Proxy), the Proxy MUST return a &lt;forbidden/&gt; error to the Initiator (for information about error syntax, refer to <span class="ref" style="">Error Condition Mappings</span>  [<a href="#nt-id2259349">6</a>]):</p>
    <p class="caption"><a name="example-9" id="example-9"></a>Example 9. Proxy Returns Error to Initiator</p><div class="indent"><pre>
&lt;iq type='error' 
    from='initiator@host1/foo' 
    to='proxy.host3' 
    id='discover'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams'/&gt;
  &lt;error code='403' type='auth'&gt;
    &lt;forbidden xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the Proxy is unable to act as a StreamHost, the Proxy SHOULD return a &lt;not-allowed/&gt; error to the Initiator:</p>
    <p class="caption"><a name="example-10" id="example-10"></a>Example 10. Proxy Returns Error to Initiator</p><div class="indent"><pre>
&lt;iq type='error' 
    from='initiator@host1/foo' 
    to='proxy.host3' 
    id='discover'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams'/&gt;
  &lt;error code='405' type='cancel'&gt;
    &lt;not-allowed xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>4.5 <a name="proto-inform" id="proto-inform">Initiator Informs Target of StreamHosts</a></h3>
    <p class="" style="">In order to establish a bytestream between the Initiator and the Target, the Initiator must provide network address information for the StreamHost(s) to the Target. This happens in-band via a single IQ-set, which must contain the following information:</p>
    <ul class="" style="">
      <li class="" style="">The network address of at least one StreamHost to which the Target may attempt to connect</li>
      <li class="" style="">The Stream ID for this connection</li>
      <li class="" style="">The "mode" to use, normally "tcp" but optionally "udp" (see the <a href="#udp">Optional UDP Support</a> section of this document)</li>
    </ul>
    <p class="" style="">The protocol format is shown below.</p>  
    <p class="caption"><a name="example-11" id="example-11"></a>Example 11. Initiation of Interaction</p><div class="indent"><pre>
&lt;iq type='set' 
    from='initiator@host1/foo' 
    to='target@host2/bar' 
    id='initiate'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams' 
         sid='mySID' 
	 mode='tcp'&gt;
    &lt;streamhost 
        jid='initiator@host1/foo' 
        host='192.168.4.1' 
        port='5086'/&gt;
    &lt;streamhost 
        jid='proxy.host3' 
        host='24.24.24.1' 
        zeroconf='_jabber.bytestreams'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the Target is unwilling to accept the bytestream, it MUST return a &lt;not-acceptable/&gt; error to the Initiator.</p>
    <p class="caption"><a name="example-12" id="example-12"></a>Example 12. Target Refuses Bytestream</p><div class="indent"><pre>
&lt;iq type='error' 
    from='target@host2/bar' 
    to='initiator@host1/foo' 
    id='initiate'&gt;
  &lt;error code='406' type='auth'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>4.6 <a name="proto-establish" id="proto-establish">Target Establishes SOCKS5 Connection with StreamHost</a></h3>
    <p class="" style="">If the Target is willing to accept the bytestream, it MUST attempt to open a standard TCP socket on the network address of the StreamHost communicated by the Initiator. If the Initiator provides more than one StreamHost, the Target SHOULD try to connect to them in the order they occur.</p>
    <p class="" style="">If the Target tries but is unable to connect to any of the StreamHosts and it does not wish to attempt a connection from its side, it MUST return a &lt;item-not-found/&gt; error to the Initiator.</p>
    <p class="caption"><a name="example-13" id="example-13"></a>Example 13. Target Is Unable to Connect to Any StreamHost and Wishes to End Transaction</p><div class="indent"><pre>
&lt;iq type='error' 
    from='target@host2/bar' 
    to='initiator@host1/foo' 
    id='initiate'&gt;
  &lt;error code='404' type='cancel'&gt;
    &lt;item-not-found xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
  &lt;/error&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the Target is able to open a TCP socket on a StreamHost, it MUST utilize the SOCKS5 protocol specified in <span class="ref" style="">RFC 1928</span>  [<a href="#nt-id2259555">7</a>] to establish the connection with the StreamHost. In accordance with the SOCKS5 RFC, the Target MAY have to authenticate in order to use the proxy. However, any authentication required is beyond the scope of this document.</p>
    <p class="" style="">Once the Target has successfully authenticated with the Proxy (even anonymously), it SHOULD send a CONNECT request to a host named: SHA1(SID + Initiator JID + Target JID), port 0, where the SHA1 hashing algorithm is specified by <span class="ref" style="">RFC 3174</span>  [<a href="#nt-id2259595">8</a>]. The JIDs provided MUST be full JIDs (i.e., &lt;user@host/resource&gt;); furthermore, in order to ensure proper results, the appropriate stringprep profiles (as specified in <span class="ref" style="">XMPP Core</span>  [<a href="#nt-id2259606">9</a>]) MUST be applied to the JIDs before application of the SHA1 hashing algorithm.</p>
    <p class="caption"><a name="example-14" id="example-14"></a>Example 14. Target Connects to StreamHost</p><div class="indent"><pre>
CMD = X'01'
ATYP = X'03'
DST.ADDR = SHA1 Hash of: (SID + Initiator JID + Target JID)
DST.PORT = 0
    </pre></div>
    <p class="caption"><a name="example-15" id="example-15"></a>Example 15. StreamHost Acknowledges Connection</p><div class="indent"><pre>
STATUS = X'00'
    </pre></div>
    
  </div>
  <div class="indent"><h3>4.7 <a name="proto-ack" id="proto-ack">Target Acknowledges SOCKS5 Connection</a></h3>
    <p class="" style="">After the Target has authenticated with the StreamHost, it MUST send an IQ-result to the Initiator indicating which StreamHost was used.</p>
    <p class="caption"><a name="example-16" id="example-16"></a>Example 16. Target Notifies Initiator of Connection</p><div class="indent"><pre>
&lt;iq type='result' 
    from='target@host2/bar' 
    to='initiator@host1/foo' 
    id='initiate'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams'&gt;
    &lt;streamhost-used jid='proxy.host3'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">At this point, the Initiator knows which StreamHost was used by
      the Target.</p>
  </div>
  <div class="indent"><h3>4.8 <a name="proto-initiator" id="proto-initiator">Initiator Establishes SOCKS5 Connection with StreamHost</a></h3>
    <p class="" style="">If the StreamHost used is a Proxy, the Initiator MUST authenticate and establish a connection with the StreamHost before requesting that the StreamHost activate bytestream. The Initiator will establish a connection to the SOCKS5 proxy in the same way the Target did, passing the same value for the CONNECT request.</p>
  </div>
  <div class="indent"><h3>4.9 <a name="proto-activation" id="proto-activation">Activation of Bytestream</a></h3>
    <p class="" style="">In order for the bytestream to be used, it MUST first be activated by the StreamHost. If the StreamHost is the Initiator, this is straightforward and does not require any in-band protocol. However, if the StreamHost is a Proxy, the Initiator MUST send an in-band request to the StreamHost. This is done by sending an IQ-set to the Proxy, including an &lt;activate/&gt; element whose XML character data specifies the full JID of the Target.</p>
    <p class="caption"><a name="example-17" id="example-17"></a>Example 17. Initiator Requests Activation of Bytestream</p><div class="indent"><pre>
&lt;iq type='set' 
    from='initiator@host1/foo' 
    to='proxy.host3' 
    id='activate'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams' sid='mySID'&gt;
    &lt;activate&gt;target@host2/bar&lt;/activate&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">Using this information, with the SID and from address on the packet, the Proxy is able to activate the stream  by hashing the SID + Initiator JID + Target JID. This provides a reasonable level of trust that the activation request came from the Initiator.</p>
    <p class="" style="">If the Proxy can fulfill the request, it MUST then respond to the Initiator with an IQ-result.</p>
    <p class="caption"><a name="example-18" id="example-18"></a>Example 18. Proxy Informs Initiator of Activation</p><div class="indent"><pre>
&lt;iq type='result' 
    from='proxy.host3' 
    to='initiator@host1/foo' 
    id='activate'/&gt;
    </pre></div>
    <p class="" style="">The Proxy MUST then send SOCKS5 acknowledgement of the connection to the Target.</p>
    <p class="caption"><a name="example-19" id="example-19"></a>Example 19. StreamHost Acknowledges Connection to Target</p><div class="indent"><pre>
STATUS = X'00'
    </pre></div>
    <p class="" style="">If the Proxy cannot fulfill the request, it MUST return an IQ-error to the Initiator; the following conditions are defined:</p>
    <ul class="" style="">
      <li class="" style="">&lt;item-not-found/&gt; error if the from address does not match that of the Initiator's full JID</li>
      <li class="" style="">&lt;not-allowed/&gt; error if only one party (either Initiator or Recipient, but not both) is connected to the Proxy</li>
      <li class="" style="">&lt;internal-server-error/&gt; error if the proxy cannot activate the bytestream because of some internal malfunction</li>
    </ul>
  </div>
<h2>5.
       <a name="usecase" id="usecase">Formal Use Case</a></h2>
  <p class="" style="">This is a formal representation of the narrative information provided above. The primary actor is the Initiator and the goal is to establish a bytestream between the Initiator and the Target. (Note: "UCE" stands for "Use Case Ends" (success is assumed unless otherwise specified), "P" stands for "Primary Flow", and "A" stands for "Alternate Flow".)</p>
  <div class="indent"><h3>5.1 <a name="usecase-primary" id="usecase-primary">Primary Flow</a></h3>
    <ol start="" class="" style="">
      <li class="" style="">Initiator wishes to establish a bytestream with Target</li>
      <li class="" style="">Initiator sends an IQ-set to Target specifying a StreamID and the network addresses of one or more StreamHosts [A1]</li>
      <li class="" style="">Target wishes to establish a bytestream with Initiator [A2]</li>
      <li class="" style="">Target requests TCP connection with a StreamHost [A3]</li>
      <li class="" style="">Target receives TCP acknowledgement from StreamHost [A4]</li>
      <li class="" style="">Target provides authentication credentials to StreamHost via SOCKS5</li>
      <li class="" style="">Target receives acknowledgement of authentication with StreamHost via SOCKS5 [A5]</li>
      <li class="" style="">Target requests connection with StreamHost via SOCKS5</li>
      <li class="" style="">Target receives acknowledgement of successful connection with StreamHost via SOCKS5 [A7]</li>
      <li class="" style="">Target sends IQ-result to Initiator announcing successful connection to StreamHost [A6]</li>
      <li class="" style="">Use Case Ends (bytestream is established and ready for use)</li>
    </ol>
  </div>
  <div class="indent"><h3>5.2 <a name="usecase-alternate" id="usecase-alternate">Alternate Flows</a></h3>

    <p class="" style=""><span class="cite">A1.</span> Initiator does not know the full network address of a StreamHost (i.e., Proxy)</p>
    <ol start="" class="" style="">
      <li class="" style="">Initiator sends IQ-get to Proxy</li>
      <li class="" style="">Initiator receives IQ-result from Proxy containing network address [A9][A10]</li>
      <li class="" style="">Return to P2</li>
    </ol>

    <p class="" style=""><span class="cite">A2.</span> Target does not wish to establish a bytestream with Initiator</p>
    <ol start="" class="" style="">
      <li class="" style="">Initiator receives &lt;not-acceptable/&gt; error from Target</li>
      <li class="" style="">UCE unsuccessfully</li>
    </ol>

    <p class="" style=""><span class="cite">A3.</span> No more StreamHosts in list (Target is unable to reach any of the provided StreamHosts)</p>
    <ol start="" class="" style="">
      <li class="" style="">Target returns &lt;remote-server-not-found/&gt; error to Initiator</li>
      <li class="" style="">UCE unsuccessfully</li>
    </ol>

    <p class="" style=""><span class="cite">A4.</span> Target cannot reach StreamHost</p>
    <ol start="" class="" style="">
      <li class="" style="">Return to P4</li>
    </ol>

    <p class="" style=""><span class="cite">A5.</span> Target authentication with StreamHost fails</p>
    <ol start="" class="" style="">
      <li class="" style="">Return to P4</li>
    </ol>

    <p class="" style=""><span class="cite">A6.</span> Proxy is unwilling to act as a StreamHost for Initiator</p>
    <ol start="" class="" style="">
      <li class="" style="">Initiator receives &lt;forbidden/&gt; error from Proxy</li>
      <li class="" style="">Return to P2</li>
    </ol>

    <p class="" style=""><span class="cite">A7.</span> Proxy is unable to act as a StreamHost for Initiator</p>
    <ol start="" class="" style="">
      <li class="" style="">Initiator receives &lt;not-allowed/&gt; error from Proxy</li>
      <li class="" style="">Return to P2</li>
    </ol>

    <p class="" style=""><span class="cite">A8.</span> Target connects to a Proxy</p>
    <ol start="" class="" style="">
      <li class="" style="">Initiator reaches Proxy [A9]</li>
      <li class="" style="">Target receives TCP acknowledgement from StreamHost [A9]</li>
      <li class="" style="">Initiator authenticates with Proxy via SOCKS5</li>
      <li class="" style="">Initiator receives acknowledgement of authentication with Proxy via SOCKS5 [A10]</li>
      <li class="" style="">Initiator requests connection with Proxy via SOCKS5</li>
      <li class="" style="">Initiator receives acknowledgement of successful connection with Proxy via SOCKS5 [A11]</li>
      <li class="" style="">Initiator sends IQ-set to Proxy requesting activation of bytestream</li>
      <li class="" style="">Initiator receives IQ-result from Proxy acknowledging activation of bytestream [A12]</li>
      <li class="" style="">Return to P9</li>
    </ol>

    <p class="" style=""><span class="cite">A9.</span> Initiator is unable to reach Proxy</p>
    <ol start="" class="" style="">
      <li class="" style="">UCE unsuccessfully</li>
    </ol>

    <p class="" style=""><span class="cite">A10.</span> Initiator is unable to authenticate with Proxy</p>
    <ol start="" class="" style="">
      <li class="" style="">UCE unsuccessfully</li>
    </ol>

    <p class="" style=""><span class="cite">A11.</span> Initiator is unable to connect to Proxy</p>
    <ol start="" class="" style="">
      <li class="" style="">UCE unsuccessfully</li>
    </ol>

    <p class="" style=""><span class="cite">A12.</span> Proxy is unable to activate bytestream</p>
    <ol start="" class="" style="">
      <li class="" style="">Initiator receives &lt;internal-server-error/&gt; error from Proxy</li>
      <li class="" style="">UCE unsuccessfully</li>
    </ol>

  </div>
<h2>6.
       <a name="desc" id="desc">Formal Description</a></h2>
  <div class="indent"><h3>6.1 <a name="desc-query" id="desc-query">&lt;query/&gt; Element</a></h3>
    <p class="" style="">The &lt;query/&gt; element is the container for all in-band communications. This element MUST be in the namespace "http://jabber.org/protocol/bytestreams". This element has a single attribute for the stream session identifier, and contains multiple &lt;streamhost/&gt; elements, a single &lt;streamhost-used/&gt; element, or a single &lt;activate/&gt; element.</p>
    <p class="" style="">The "sid" specifies the bytestream session identifier. This attribute MUST be present. The value of this attribute is any character data.</p>
    <p class="" style="">The "mode" specifies the mode to use, either 'tcp' or 'udp'. If this attribute is missing, the default value of "tcp" MUST be assumed.</p>
    <p class="" style="">The &lt;streamhost/&gt; element conveys the network connection information. At least one instance MUST be present in the initial IQ-set from the Initiator to the Target. If multiple instances of this element are present, each one MUST be a separate host/port combination.</p>
    <p class="" style="">The &lt;streamhost-used/&gt; element transports the out-of-band token. It MUST be present in the IQ-set from the Target to the Initiator, and there MUST be only one instance.</p>
    <p class="" style="">The &lt;activate/&gt; element is used to request activation of a unidirectional or bidirectional bytestream. It MUST be present in the IQ-set sent from the Initiator to the StreamHost after the Initiator receives an IQ-result from the Target, and there MUST be only one instance.</p>
  </div>
  <div class="indent"><h3>6.2 <a name="desc-streamhost" id="desc-streamhost">&lt;streamhost/&gt; Element</a></h3>
    <p class="" style="">The &lt;streamhost/&gt; element contains the bytestream connection information. This element has attributes for the StreamHost's JID, network host/address, and network port. This element MUST NOT contain any content nodes.</p>
    <p class="" style="">The "jid" attribute specifies the StreamHost's JID. This attribute MUST be present, and MUST be a valid JID for use with an &lt;iq/&gt;.</p>
    <p class="" style="">The "host" attribute specifies the host to connect to. This attribute MUST be present. The value MUST be either a resolvable domain name or the "dotted decimal" IP address (e.g. "1.2.3.4").</p>
    <p class="" style="">The "port" attribute specifies the port to connect to. This attribute MAY be present. The value MUST be a valid port number in decimal form.</p>
    <p class="" style="">The "zeroconf" attribute specifies the zero-configuration service available for bytestreaming. This attribute SHOULD be present. The value SHOULD be '_jabber.bytestreams'.</p>
    <p class="" style="">When communicating the available hosts, the Initiator MUST include EITHER the host and port OR the zeroconf information.</p>
  </div>
  <div class="indent"><h3>6.3 <a name="desc-streamhost-used" id="desc-streamhost-used">&lt;streamhost-used/&gt; Element</a></h3>
    <p class="" style="">The &lt;streamhost-used/&gt; element indicates the StreamHost connected to. This element has a single attribute for the JID of the StreamHost to which the Target connected. This element MUST NOT contain any content node.</p>
    <p class="" style="">The "jid" attribute specifies the full JID of the StreamHost. This attribute MUST be present, and MUST be a valid JID for use with an &lt;iq/&gt;.</p>
  </div>
  <div class="indent"><h3>6.4 <a name="desc-activate" id="desc-activate">&lt;activate/&gt; Element</a></h3>
    <p class="" style="">The &lt;activate/&gt; element is a flag to trigger a Proxy to complete a connection.</p> 
  </div>
<h2>7.
       <a name="udp" id="udp">Optional UDP Support</a></h2>
  <p class="" style="">Support for UDP associations is strictly OPTIONAL. However, implementations that support UDP associations MUST adhere to the profile described in this section.</p>
  <div class="indent"><h3>7.1 <a name="udp-disco" id="udp-disco">Discovering UDP Support</a></h3>
    <p class="" style="">If an implementation supports UDP associations, it MUST advertise that separately by returning a feature of 'http://jabber.org/protocol/bytestreams#udp' in response to <span class="cite">Service Discovery</span> information requests.</p>
    <p class="caption"><a name="example-20" id="example-20"></a>Example 20. Initiator Sends Service Discovery Request to Target</p><div class="indent"><pre>
&lt;iq type='get' 
    from='initiator@host1/foo' 
    to='target@host2/bar' 
    id='hello2'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'/&gt;
&lt;/iq&gt;
    </pre></div>
    <p class="" style="">If the Target supports UDP associations, it MUST answer to that effect in the service discovery result.</p>
    <p class="caption"><a name="example-21" id="example-21"></a>Example 21. Target Replies to Service Discovery Request</p><div class="indent"><pre>
&lt;iq type='result' 
    from='target@host2/bar' 
    to='initiator@host1/foo' 
    id='hello2'&gt;
  &lt;query xmlns='http://jabber.org/protocol/disco#info'&gt;
    &lt;identity 
        category='proxy'
        type='bytestreams'
        name='SOCKS5 Bytestreams Service'/&gt;
    ...
    &lt;feature var='http://jabber.org/protocol/bytestreams'/&gt;
    &lt;feature var='http://jabber.org/protocol/bytestreams#udp'/&gt;
    ...
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>7.2 <a name="udp-request" id="udp-request">Requesting UDP Mode</a></h3>
    <p class="" style="">UDP associations are requested by setting the 'mode' attribute to a value of "udp" rather than "tcp".</p>
    <p class="caption"><a name="example-22" id="example-22"></a>Example 22. Initiation of Interaction (UDP)</p><div class="indent"><pre>
&lt;iq type='set' 
    from='initiator@host1/foo' 
    to='target@host2/bar' 
    id='initiate'&gt;
  &lt;query xmlns='http://jabber.org/protocol/bytestreams' 
         sid='mySID' 
	 mode='udp'&gt;
    &lt;streamhost 
        jid='initiator@host1/foo' 
        host='192.168.4.1' 
        port='5086'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>7.3 <a name="udp-process" id="udp-process">UDP Process</a></h3>
    <p class="" style="">There is one main difference between UDP mode and TCP mode: rather than simply establishing a TCP connection, the Target and/or Initiator MUST (1) establish a UDP association and then (2) initialize the UDP channel. In particular:</p>
    <ul class="" style="">
      <li class="" style="">If direct connection is followed, Target MUST complete UDP association and initialization of the UDP channel before informing Initiator of success via the &lt;streamhost-used/&gt; element.</li>
      <li class="" style="">If mediated connection is followed, (1) Target MUST complete UDP association and initialization of the UDP channel before informing Initiator of success via the &lt;streamhost-used/&gt; element, and (2) Initiator MUST complete UDP association and initialization of the UDP channel before asking StreamHost to activate the bytestream.</li>
    </ul>
    <p class="" style="">The processes for establishing the UDP association and for initializing the UDP channel are described below.</p>
    <div class="indent"><h3>7.3.1 <a name="udp-process-assoc" id="udp-process-assoc">Establishing the UDP Association</a></h3>
      <p class="" style="">Once the Target has successfully authenticated with the Proxy (as described under <a href="#proto-establish">Target Establishes SOCKS5 Connection with StreamHost</a>), it MUST send a UDP ASSOCIATE (rather than CONNECT) request to the host identified by the algorithm defined above.</p>
      <p class="caption"><a name="example-23" id="example-23"></a>Example 23. Target Requests UDP Association with StreamHost</p><div class="indent"><pre>
CMD = X'03'
ATYP = X'03'
DST.ADDR = SHA1 Hash of: (SID + Initiator JID + Target JID)
DST.PORT = 0
      </pre></div>
      <p class="" style="">The StreamHost then acknowledges this request:</p>
      <p class="caption"><a name="example-24" id="example-24"></a>Example 24. StreamHost Acknowledges Request</p><div class="indent"><pre>
STATUS = X'00'
      </pre></div>
    </div>
    <div class="indent"><h3>7.3.2 <a name="udp-process-init" id="udp-process-init">Initializing the UDP Channel</a></h3>
      <p class="" style="">After connecting to the StreamHost, the Target (direct connection) or both Target and Initiator (mediated connection) MUST initialize the UDP channel. In order to do so, each sending entity MUST send a SOCKS5 UDP packet to the StreamHost on the same port used for the initial TCP connection (in the foregeoing example, a host of 192.168.4.1 and port of 5086), with DST.PORT set to '1' and DATA containing the sending entity's JID (i.e, the JID of either the Target or Initiator).</p>
      <p class="caption"><a name="example-25" id="example-25"></a>Example 25. Target or Initiator Sends UDP Initialization Packet to StreamHost</p><div class="indent"><pre>
ATYP = X'03'
DST.ADDR = SHA1 Hash of: (SID + Initiator JID + Target JID)
DST.PORT = 1
DATA = Target or Initiator JID
      </pre></div>
      <p class="" style="">Upon successful receipt by the StreamHost, the StreamHost MUST reply with a message notification indicating success:</p>
      <p class="caption"><a name="example-26" id="example-26"></a>Example 26. StreamHost Notifies Target or Initiator of UDP Success</p><div class="indent"><pre>
&lt;message 
    from='proxy.host3' 
    to='target@host2/bar' 
    id='initiate'&gt;
  &lt;udpsuccess xmlns='http://jabber.org/protocol/bytestreams' dstaddr='Value of Hash'/&gt;
&lt;/message&gt;
      </pre></div>
      <p class="" style="">The &lt;udpsuccess/&gt; element indicates that the StreamHost has received a UDP initialization packet. This element has a single attribute containing the DST.ADDR that was used in the UDP packet.</p>
      <p class="" style="">If Target is unable to initialize the UDP channel, it MUST return a &lt;remote-server-not-found/&gt; error to Initiator.</p>
      <p class="" style="">Note: Since UDP is not reliable, the Target SHOULD resend the UDP packet if the reply notification is not received within a short time (a 5-second retry is RECOMMENDED). The StreamHost SHOULD ignore duplicate UDP initialization packets once it has replied with a notification.</p>
    </div>
  </div>
  <div class="indent"><h3>7.4 <a name="udp-ports" id="udp-ports">Exchanging UDP Packets</a></h3>
    <p class="" style="">Once the UDP association is established, UDP packets can be exchanged with the StreamHost. When a UDP packet is sent by either party, it MUST contain a 4-byte header (in addition to other possible headers, such as that of SOCKS5), which consists of the source virtual port and then the destination virtual port of the packet, both 16-bit values in network byte order. This allows the peers to multiplex many packets for different purposes over one session. The actual application data should follow this header, and thus the payload size will always be "Application Data Size + 4".</p>
    <p class="" style="">For all packets sent to the StreamHost, DST.PORT is set to 0, and DATA contains the payload.</p>
    <p class="caption"><a name="example-27" id="example-27"></a>Example 27. Sending UDP to StreamHost</p><div class="indent"><pre>
ATYP = X'03'
DST.ADDR = SHA1 Hash of: (SID + Initiator JID + Target JID)
DST.PORT = 0
DATA = (payload)
    </pre></div>
    <p class="" style="">UDP packets sent from the StreamHost do not have any SOCKS5 headers, and so the payload should be delivered as-is.</p>
    <p class="" style="">The programming interface for a SOCKS5 Bytestreams-aware UDP MUST report an available buffer space for UDP datagrams that is smaller than the actual space provided by the operating system and SOCKS5 layer if applicable. In other words, 4 more octets smaller.</p>
  </div>
<h2>8.
       <a name="impl" id="impl">Implementation Notes</a></h2>
  <div class="indent"><h3>8.1 <a name="impl-streamhost" id="impl-streamhost">StreamHost Requirements</a></h3>
    <p class="" style="">A StreamHost MUST support TCP connections.</p>
    <p class="" style="">A StreamHost SHOULD:</p>
    <ol start="" class="" style="">
      <li class="" style="">Allow bi-directional bytestreaming between the Initiator and Target.</li>
      <li class="" style="">Allow only one Target to connect to a bytestream (i.e., disallow multicasting).</li>
      <li class="" style="">Track sessions based on a combination of the StreamID and the Initiator's full JID, thus allowing an Initiator to create more than one simultaneous session.</li>
      <li class="" style="">Ignore but not drop any bytes sent before the bytestream is activated.</li>
      <li class="" style="">Prefer to use zero-configuration IP networking if supported.</li>
    </ol>
    <p class="" style="">A StreamHost MAY:</p>
    <ol start="" class="" style="">
      <li class="" style="">Support UDP associations in addition TCP connections.</li>
      <li class="" style="">Ignore the DST.ADDR and DST.PORT parameters if desired.</li>
    </ol>
  </div>
  <div class="indent"><h3>8.2 <a name="impl-socks5" id="impl-socks5">SOCKS5 Parameter Mapping</a></h3>
    <p class="" style="">To facilitate the usage of SOCKS5, command parameters MUST be mapped to the appropriate values. Parameters not specified in the table below SHOULD be used as defined in RFC 1928.</p>
    <p class="caption">Table 2: Request/Parameter Mapping for CONNECT</p><table border="1" cellpadding="3" cellspacing="0">
      <tr class="body"><th colspan="" rowspan="">Parameter</th><th colspan="" rowspan="">Value</th></tr>
      <tr class="body"><td colspan="" rowspan="">CMD</td><td colspan="" rowspan="">1 (CONNECT)</td></tr>
      <tr class="body"><td colspan="" rowspan="">ATYP</td><td colspan="" rowspan="">1 (IP V4), 3 (DOMAINNAME), or 4 (IP V6)</td></tr>
      <tr class="body"><td colspan="" rowspan="">DST.ADDR</td><td colspan="" rowspan="">SHA1 Hash of: (SID + Initiator JID + Target JID)</td></tr>
      <tr class="body"><td colspan="" rowspan="">DST.PORT</td><td colspan="" rowspan="">0</td></tr>
    </table>
    <p class="caption">Table 3: Request/Parameter Mapping for UDP ASSOCIATE</p><table border="1" cellpadding="3" cellspacing="0">
      <tr class="body"><th colspan="" rowspan="">Parameter</th><th colspan="" rowspan="">Value</th></tr>
      <tr class="body"><td colspan="" rowspan="">CMD</td><td colspan="" rowspan="">3 (UDP ASSOCIATE)</td></tr>
      <tr class="body"><td colspan="" rowspan="">ATYP</td><td colspan="" rowspan="">1 (IP V4), 3 (DOMAINNAME), or 4 (IP V6)</td></tr>
      <tr class="body"><td colspan="" rowspan="">DST.ADDR</td><td colspan="" rowspan="">SHA1 Hash of: (SID + Initiator JID + Target JID)</td></tr>
      <tr class="body"><td colspan="" rowspan="">DST.PORT</td><td colspan="" rowspan="">0</td></tr>
    </table>
    <p class="caption">Table 4: Request/Parameter Mapping for UDP Packets</p><table border="1" cellpadding="3" cellspacing="0">
      <tr class="body"><th colspan="" rowspan="">Parameter</th><th colspan="" rowspan="">Value</th></tr>
      <tr class="body"><td colspan="" rowspan="">ATYP</td><td colspan="" rowspan="">1 (IP V4), 3 (DOMAINNAME), or 4 (IP V6)</td></tr>
      <tr class="body"><td colspan="" rowspan="">DST.ADDR</td><td colspan="" rowspan="">SHA1 Hash of: (SID + Initiator JID + Target JID)</td></tr>
      <tr class="body"><td colspan="" rowspan="">DST.PORT</td><td colspan="" rowspan="">0 or 1, for payload or initialization packets, respectively.</td></tr>
    </table>
  </div>
<h2>9.
       <a name="security" id="security">Security Considerations</a></h2>
  <p class="" style="">This proposal does not include a method for securing or encrypting SOCKS5 bytetreams. If such security is desired, it MUST be negotiated over the bytestream (once established) using standard protocols such as SSL or TLS. Negotiation of such security methods is outside the scope of this document.</p>
<h2>10.
       <a name="iana" id="iana">IANA Considerations</a></h2>
  <p class="" style="">This document requires no interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2261521">10</a>].</p>
<h2>11.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
  <div class="indent"><h3>11.1 <a name="registrar-ns" id="registrar-ns">Protocol Namespaces</a></h3>
    <p class="" style="">The <span class="ref" style="">XMPP Registrar</span>  [<a href="#nt-id2261572">11</a>] includes 'http://jabber.org/protocol/bytestreams' in its registry of protocol namespaces.</p> 
  </div>
  <div class="indent"><h3>11.2 <a name="registrar-discovar" id="registrar-discovar">Service Discovery Features</a></h3>
    <p class="" style="">The XMPP Registrar shall includes 'http://jabber.org/protocol/bytestreams#udp' in its registry of service discovery features.</p> 
  </div>
  <div class="indent"><h3>11.3 <a name="registrar-discoid" id="registrar-discoid">Service Discovery Category/Type</a></h3>
    <p class="" style="">The XMPP Registrar includes the "proxy" category and associated "bytestreams" type in the Service Discovery registry. The registry submission is as follows:</p>
    <p class="caption"></p><div class="indent"><pre>
  &lt;category&gt;
    &lt;name&gt;proxy&lt;/name&gt;
    &lt;desc&gt;Proxy servers or services&lt;/desc&gt;
    &lt;type&gt;
      &lt;name&gt;bytestreams&lt;/name&gt;
      &lt;desc&gt;A proxy for SOCKS5 bytestreams&lt;/desc&gt;
      &lt;doc&gt;XEP-0065&lt;/doc&gt;
    &lt;/type&gt;
  &lt;/category&gt;
    </pre></div>
  </div>
<h2>12.
       <a name="schema" id="schema">Schema</a></h2>
  <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://jabber.org/protocol/bytestreams'
    xmlns='http://jabber.org/protocol/bytestreams'
    elementFormDefault='qualified'&gt;

  &lt;xs:annotation&gt;
    &lt;xs:documentation&gt;
      The protocol documented by this schema is defined in
      XEP-0065: http://www.xmpp.org/extensions/xep-0065.html
    &lt;/xs:documentation&gt;
  &lt;/xs:annotation&gt;

  &lt;xs:element name='query'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:choice&gt;
        &lt;xs:element ref='streamhost' minOccurs='0' maxOccurs='unbounded'/&gt;
        &lt;xs:element ref='streamhost-used' minOccurs='0'/&gt;
        &lt;xs:element name='activate' type='empty' minOccurs='0'/&gt;
      &lt;/xs:choice&gt;
      &lt;xs:attribute name='sid' type='xs:string' use='optional'/&gt;
      &lt;xs:attribute name='mode' use='optional' default='tcp'&gt;
        &lt;xs:simpleType&gt;
          &lt;xs:restriction base='xs:NCName'&gt;
            &lt;xs:enumeration value='tcp'/&gt;
            &lt;xs:enumeration value='udp'/&gt;
          &lt;/xs:restriction&gt;
        &lt;/xs:simpleType&gt;
      &lt;/xs:attribute&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='streamhost'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='jid' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='host' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='zeroconf' type='xs:string' use='optional'/&gt;
          &lt;xs:attribute name='port' type='xs:string' use='optional'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='udpsuccess'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='dstaddr' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='streamhost-used'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='empty'&gt;
          &lt;xs:attribute name='jid' type='xs:string' use='required'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
  </pre></div>
<hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2251135" id="nt-id2251135">1</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/rfc3920">http://tools.ietf.org/html/rfc3920</a>&gt;.</p><p><a name="nt-id2251187" id="nt-id2251187">2</a>. RFC 793: Transmission Control Protocol &lt;<a href="http://tools.ietf.org/html/rfc0793">http://tools.ietf.org/html/rfc0793</a>&gt;.</p><p><a name="nt-id2251210" id="nt-id2251210">3</a>. RFC 768: User Datagram Protocol &lt;<a href="http://tools.ietf.org/html/rfc0768">http://tools.ietf.org/html/rfc0768</a>&gt;.</p><p><a name="nt-id2259022" id="nt-id2259022">4</a>. XEP-0030: Service Discovery &lt;<a href="http://www.xmpp.org/extensions/xep-0030.html">http://www.xmpp.org/extensions/xep-0030.html</a>&gt;.</p><p><a name="nt-id2259281" id="nt-id2259281">5</a>. Zeroconf is a set of protocols that enable IP networking without the need for configuration. For further information, refer to &lt;<a href="http://www.zeroconf.org/">http://www.zeroconf.org/</a>&gt;.</p><p><a name="nt-id2259349" id="nt-id2259349">6</a>. XEP-0086: Error Condition Mappings &lt;<a href="http://www.xmpp.org/extensions/xep-0086.html">http://www.xmpp.org/extensions/xep-0086.html</a>&gt;.</p><p><a name="nt-id2259555" id="nt-id2259555">7</a>. RFC 1928: SOCKS Protocol Version 5 &lt;<a href="http://tools.ietf.org/html/rfc1928">http://tools.ietf.org/html/rfc1928</a>&gt;.</p><p><a name="nt-id2259595" id="nt-id2259595">8</a>. RFC 3174: US Secure Hash Algorithm 1 (SHA1) &lt;<a href="http://tools.ietf.org/html/rfc3174">http://tools.ietf.org/html/rfc3174</a>&gt;.</p><p><a name="nt-id2259606" id="nt-id2259606">9</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/rfc3920">http://tools.ietf.org/html/rfc3920</a>&gt;.</p><p><a name="nt-id2261521" id="nt-id2261521">10</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p><p><a name="nt-id2261572" id="nt-id2261572">11</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 1.6 (2004-11-12)</h4><div class="indent">Added UDP support (OPTIONAL). (ds/psa)
    </div><h4>Version 1.5 (2004-06-29)</h4><div class="indent">Added requirement to apply stringprep profiles before SHA1 hashing; added reference to RFC 3174. (psa)
    </div><h4>Version 1.4 (2004-06-28)</h4><div class="indent">Cleaned up narratives to reflect current practices and removed unnecessary authentication references; fixed mismatch SOCKS5 parameter table values. (ds)
    </div><h4>Version 1.3 (2003-09-24)</h4><div class="indent">Added disco#info &lt;identity/&gt; and corresponding XMPP Registrar submission; added XMPP error handling. (psa)
    </div><h4>Version 1.2 (2003-07-15)</h4><div class="indent">Removed SIDs from the result queries, you should key off the IQ 'id' attribute instead. Added the disco exchange for finding available proxies. (rwe)
    </div><h4>Version 1.1 (2003-07-09)</h4><div class="indent">Changed srvid to zeroconf; cleaned up use cases; updated the schema. (ds)
    </div><h4>Version 1.0 (2003-04-21)</h4><div class="indent">Per a vote of the Jabber Council, advanced status to Draft. (psa)
    </div><h4>Version 0.7 (2003-03-04)</h4><div class="indent">Clarified that this proposal uses an adaptation of the SOCKS5 protocol, not the full protocol; replaced DTD with schema; added security considerations. (psa)
    </div><h4>Version 0.6 (2003-01-27)</h4><div class="indent">Added service discovery example; added 'srvid' attribute to streamhost element and required inclusion of either 'srvid' or 'port' attribute; improved the algorithms for generating SOCKS5 UNAME and PASSWD parameters; specified that the DST.ADDR and DST.PORT parameters may be ignored; removed references to connected/disconnected notification, bidirectional bytestreams, and multiple targets; updated implementation notes. (psa/ds)
    </div><h4>Version 0.5 (2002-12-20)</h4><div class="indent">Specified option of "reversing the connection" (Target becomes Initiator); added more error cases; resurrected and cleaned up formal use case. (psa)
    </div><h4>Version 0.4 (2002-12-19)</h4><div class="indent">Added section on connected/disconnected notifications sent from Proxy to Initiator; cleaned up several examples; specified more error conditions; clarified the formal descriptions; added implementation notes and future considerations. (psa, mm)
    </div><h4>Version 0.3 (2002-12-17)</h4><div class="indent">Added lots of detail to the narrative and protocol. (psa)
    </div><h4>Version 0.2 (2002-12-16)</h4><div class="indent">Added SOCKS info. (ds)
    </div><h4>Version 0.1 (2002-12-13)</h4><div class="indent">Initial version. (ds)
    </div></div><hr /><p>END</p></body></html>
