<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0201: Best Practices for Message Threads</title><link rel="stylesheet" type="text/css" href="/xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="Best Practices for Message Threads" /><meta name="DC.Creator" content="Peter Saint-Andre" /><meta name="DC.Creator" content="Ian Paterson" /><meta name="DC.Creator" content="Kevin Smith" /><meta name="DC.Description" content="This specification defines recommended handling of XMPP message threads." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2007-01-29" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0201" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright 1999 - 2007 by the XMPP Standards Foundation (XSF) and is in full conformance with the XSF's Intellectual Property Rights Policy &lt;http://www.xmpp.org/extensions/ipr-policy.shtml&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;http://creativecommons.org/licenses/by/2.5/&gt;)." /></head><body><h1>XEP-0201: Best Practices for Message Threads</h1><p>This specification defines recommended handling of XMPP message threads.</p><hr /><p style="color:red">WARNING: This Informational document is Experimental. Publication as an XMPP Extension Protocol does not imply approval of this proposal by the XMPP Standards Foundation. Implementation of the best practice or protocol profile described herein is encouraged in exploratory implementations, although production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0201<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Experimental">Experimental</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Informational">Informational</a><br />
            Version: 0.3<br />
            Last Updated: 2007-01-29<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: N/A<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Best Practices for Message Threads (XEP-0201)">http://wiki.jabber.org/index.php/Best Practices for Message Threads (XEP-0201)</a>&gt;
            </p><h2>Author Information</h2><div class="indent"><h3>Peter Saint-Andre</h3><p class="indent">
        Email:
        <a href="mailto:stpeter@jabber.org">stpeter@jabber.org</a><br />
        JabberID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a></p><h3>Ian Paterson</h3><p class="indent">
        Email:
        <a href="mailto:ian.paterson@clientside.co.uk">ian.paterson@clientside.co.uk</a><br />
        JabberID: 
        <a href="xmpp:ian@zoofy.com">ian@zoofy.com</a></p><h3>Kevin Smith</h3><p class="indent">
        Email:
        <a href="mailto:kevin@kismith.co.uk">kevin@kismith.co.uk</a><br />
        JabberID: 
        <a href="xmpp:kevdadrum@jabber.ex.ac.uk">kevdadrum@jabber.ex.ac.uk</a></p></div><h2>Legal Notice</h2><p class="indent">This XMPP Extension Protocol is copyright 1999 - 2007 by the <a href="http://www.xmpp.org/xsf/">XMPP Standards Foundation</a> (XSF) and is in full conformance with the XSF's Intellectual Property Rights Policy &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt;. This material may be distributed only subject to the terms and conditions set forth in the Creative Commons Attribution License (&lt;<a href="http://creativecommons.org/licenses/by/2.5/">http://creativecommons.org/licenses/by/2.5/</a>&gt;).</p><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in RFC 2119: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />2.  <a href="#motivation">Motivation</a><br />3.  <a href="#semantics">Semantics</a><br />4.  <a href="#unique">Uniqueness</a><br />5.  <a href="#handling">Handling</a><br />6.  <a href="#inclusion">Inclusion</a><br />7.  <a href="#shim">SHIM Header</a><br />8.  <a href="#impl">Implementation Notes</a><br />9.  <a href="#security">Security Considerations</a><br />10.  <a href="#iana">IANA Considerations</a><br />11.  <a href="#registrar">XMPP Registrar Considerations</a><br />&#xA0;&#xA0;&#xA0;
      11.1.  <a href="#registrar-shim">SHIM Headers Registry</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
  <p class="" style="">Although message threads are re-used in XMPP extension protocols such as <span class="ref" style="">Chat State Notifications</span>  [<a href="#nt-id2251023">1</a>] and <span class="ref" style="">Chat Session Negotiation</span>  [<a href="#nt-id2251045">2</a>], the semantics of message threads have never been well specified (e.g., in <span class="ref" style="">RFC 3921</span>  [<a href="#nt-id2251063">3</a>]). This document attempts to clearly specify the meaning and handling of message threads for implementation by XMPP clients and for potential inclusion in <span class="ref" style="">rfc3921bis</span>  [<a href="#nt-id2251087">4</a>].</p>
<h2>2.
       <a name="motivation" id="motivation">Motivation</a></h2>
  <p class="" style="">Threads matter because they enable XMPP clients to:</p>
  <ul class="" style="">
    <li class="" style="">Track conversation topics within the context of a one-to-one chat session, a <span class="ref" style="">Multi-User Chat</span>  [<a href="#nt-id2251141">5</a>] room, or exchange of normal messages.</li>
    <li class="" style="">Restart a conversation from message history.</li>
    <li class="" style="">Enable clients to distinguish between different conversation threads when presenting a user's message, chat, and groupchat histories, thus providing a more coherent user interface (e.g. by collapsing threads to a single history entry).</li>
    <li class="" style="">Separate logical sessions from physical interface objects such as windows.</li>
    <li class="" style="">Route XMPP stanzas internally (e.g., dispatching different content types to different windows), thus facilitating the creation of more robust plugin architectures.</li>
  </ul>
<h2>3.
       <a name="semantics" id="semantics">Semantics</a></h2>
  <p class="" style="">Section 2.1.2.3 of <span class="cite">RFC 3921</span> currently states the following regarding the semantics of the ThreadID:</p>
  <p class="indent" style="">The &lt;thread/&gt; element contains non-human-readable XML character data specifying an identifier that is used for tracking a conversation thread (sometimes referred to as an "instant messaging session") between two entities.</p>
  <p class="" style="">The description in <span class="cite">RFC 3921</span> is deemed to be too limiting, since it ignores the potential use of the ThreadID when exchanging message stanzas of types other than 'chat'. Therefore we proposal the following description:</p>
  <p class="indent" style="">The primary use of the XMPP &lt;thread/&gt; element is to uniquely identify a conversation thread or "chat session" between two entities instantiated by &lt;message/&gt; stanzas of type 'chat'.  However, the XMPP &lt;thread/&gt; element may also be used to uniquely identify an analogous thread between two entities instantiated by &lt;message/&gt; stanzas of type 'headline' or 'normal', or among multiple entities in the context of a multi-user chat room instantiated by &lt;message/&gt; stanzas of type 'groupchat'. It may also be used for &lt;message/&gt; stanzas not related to a conversation, such as a game session or between plugins.</p>
<h2>4.
       <a name="unique" id="unique">Uniqueness</a></h2>
  <p class="" style="">Section 2.1.2.3 of <span class="cite">RFC 3921</span> currently states the following uniqueness requirement:</p>
  <p class="indent" style="">The value of the &lt;thread/&gt; element ... MUST be unique to that conversation thread within the stream and MUST be consistent throughout that conversation (a client that receives a message from the same full JID but with a different thread ID MUST assume that the message in question exists outside the context of the existing conversation thread).</p>
  <p class="" style="">The uniqueness requirement in <span class="cite">RFC 3921</span> is not deemed strong enough since it is desirable that a ThreadID could be used to (for instance) restart a conversation at a later date. Therefore we propose the following uniqueness requirement:</p>
  <p class="indent" style="">The value of the &lt;thread/&gt; element MUST be a universally unique identifier (UUID). The format described in <span class="ref" style="">RFC 4122</span>  [<a href="#nt-id2258527">6</a>] is RECOMMENDED.</p>
<h2>5.
       <a name="handling" id="handling">Handling</a></h2>
  <p class="" style="">In the context of &lt;message/&gt; stanzas of type 'chat' exchanged between two entities, the value of the &lt;thread/&gt; element shall be considered equivalent to a unique identifier for the chat session or conversation thread. If an entity receives such a message with a new or unknown ThreadID, it SHOULD treat the message as part of a session with unnegotiated parameters (i.e., as equivalent to the first message in a chat session that has been negotiated via <span class="cite">XEP-0155</span> with no parameters specified). An entity SHOULD destroy the thread when it sends or receives a <span class="cite">XEP-0155</span> "terminate" stanza (such a stanza SHOULD be sent even for sessions that were not negotitated with <span class="cite">XEP-0155</span>) and MAY destroy the thread when it goes offline, but SHOULD NOT destroy the thread if a human user merely closes a window in a client interface.</p>
  <p class="" style="">If an entity receives an XMPP presence stanza of type 'unavailable' from the other entity during a chat session, it SHOULD NOT destroy the thread, it SHOULD assume the other entity will still be able to continue the session (perhaps the other entity simply became "invisible", or was temporarily disconnected by a network error, or it is persisting the state of the session until it reconnects and receives "offline" messages).</p>
  <p class="" style="">When sending a &lt;message/&gt; stanza of type 'normal', the value of the &lt;thread/&gt; element is used to uniquely identify a conversation thread which may not be progressing in real-time. A &lt;message/&gt; stanza of type 'normal' SHOULD always use a new &lt;thread/&gt; element identifier unless it is written in direct reply to another &lt;message/&gt; stanza, in which case the &lt;thread/&gt; element of the original &lt;message/&gt; should be used. Determining what constitutes a &lt;message/&gt; stanza written in reply to another is a matter left to individual implementation, but it is envisaged that in most cases it would be the result of, e.g., the user clicking a 'reply' button when reading the contents of the previous stanza; alternatively, the entity that replies can include an "In-Reply-To" header as described in the <a href="#impl">Implementation Notes</a> section of this document.</p>
  <p class="" style="">There are no special handling requirements related to threads in the context of &lt;message/&gt; stanzas of type 'headline'.</p>
  <p class="" style="">When displaying historical conversations within a user interface, a client SHOULD provide a visual indication of thread membership of messages. Methods for such indications include (non-exhaustively) the grouping of all messages within a thread together, providing an index of threads, or formatting all messages within a thread in a cohesive manner, e.g. with a uniform coloring.</p>
  <p class="" style="">If an entity receives a message of type 'chat' without a thread ID then:</p>
  <ul class="" style="">
    <li class="" style="">If the receiving entity has no sessions open with the message sender (full JID), or if all the open sessions have already <span class="em">received</span> a message that included the session's thread ID, then the receiver should create a new session with a new thread ID (and include that thread ID in all the messages it sends within the session).</li>
    <li class="" style="">If the receiver has a session open with the sender within which it has never received any message that included the session's thread ID, then it should consider the message to be part of that session. If more than one of such sessions exist, then the message should be considered part of the session in which the receiver last sent a message.</li>
  </ul>
<h2>6.
       <a name="inclusion" id="inclusion">Inclusion</a></h2>
  <p class="" style="">Depending on the type of the message (i.e., the value of the 'type' attribute), the &lt;thread/&gt; should be included as follows:</p>
  <p class="caption">Table 1: When to Include Threads</p><table border="1" cellpadding="3" cellspacing="0">
    <tr class="body">
      <th colspan="" rowspan="">Message Type</th>
      <th colspan="" rowspan="">Inclusion</th>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">chat</td>
      <td colspan="" rowspan="">RECOMMENDED</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">groupchat</td>
      <td colspan="" rowspan="">RECOMMENDED</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">headline</td>
      <td colspan="" rowspan="">OPTIONAL</td>
    </tr>
    <tr class="body">
      <td colspan="" rowspan="">normal</td>
      <td colspan="" rowspan="">OPTIONAL</td>
    </tr>
  </table>
<h2>7.
       <a name="shim" id="shim">SHIM Header</a></h2>
  <p class="" style="">In some contexts it may be desirable to enforce thread-like semantics when exchanging XMPP &lt;iq/&gt; stanzas. Because <span class="cite">RFC 3920</span> disallows more than one direct child element of the &lt;iq/&gt; stanza, it is not possible to include the &lt;thread/&gt; element for tracking purposes. Therefore we define a "ThreadID" <span class="ref" style="">Stanza Headers and Internet Metadata</span>  [<a href="#nt-id2258877">7</a>] header with the same semantics as the &lt;thread/&gt; element, but with the syntax of a SHIM header:</p>
  <p class="caption"><a name="example-1" id="example-1"></a>Example 1. ThreadID header</p><div class="indent"><pre>
&lt;iq from='romeo@montague.net/home'
    to='joogle@botster.shakespeare.lit'
    type='get'
    id='create1'&gt;
  &lt;command xmlns='http://jabber.org/protocol/commands'
           node='create'
           action='execute'&gt;
    &lt;headers xmlns='http://jabber.org/protocol/shim'&gt;
      &lt;header name='ThreadID'&gt;e0ffe42b28561960c6b12b944a092794b9683a38&lt;/header&gt;
    &lt;/headers&gt;
  &lt;/command&gt;
&lt;/iq&gt;
  </pre></div>
<h2>8.
       <a name="impl" id="impl">Implementation Notes</a></h2>
  <p class="" style="">An entity that needs to track replies to particular messages may do so by including an 'id' attribute with the &lt;message/&gt; stanza.</p>
  <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Message with ID</p><div class="indent"><pre>
&lt;message
    to='romeo@example.net/orchard'
    from='juliet@example.com/balcony'
    id='asiwe8289ljfdalk'
    type='chat'
    xml:lang='en'&gt;
  &lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;
  &lt;thread&gt;e0ffe42b28561960c6b12b944a092794b9683a38&lt;/thread&gt;
&lt;/message&gt;
  </pre></div>
  <p class="" style="">The entity that replies then MAY include an "In-Reply-To" header:</p>
  <p class="caption"><a name="example-3" id="example-3"></a>Example 3. Reply</p><div class="indent"><pre>
&lt;message
    to='juliet@example.com/balcony'
    from='romeo@example.net/orchard'
    type='chat'
    id='pertio4387435ilq'
    xml:lang='en'&gt;
  &lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;
  &lt;thread&gt;e0ffe42b28561960c6b12b944a092794b9683a38&lt;/thread&gt;
  &lt;headers xmlns='http://jabber.org/protocol/shim'&gt;
    &lt;header name='In-Reply-To'&gt;asiwe8289ljfdalk&lt;/header&gt;
  &lt;/headers&gt;
&lt;/message&gt;
  </pre></div>
<h2>9.
       <a name="security" id="security">Security Considerations</a></h2>
  <p class="" style="">An entity that generates the UUID used as the ThreadID MUST ensure that the UUID does not reveal (identifying) information about the entity.</p>
<h2>10.
       <a name="iana" id="iana">IANA Considerations</a></h2>
  <p class="" style="">This document requires no interaction with the <span class="ref" style="">Internet Assigned Numbers Authority (IANA)</span>  [<a href="#nt-id2258988">8</a>].</p>
<h2>11.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
  <div class="indent"><h3>11.1 <a name="registrar-shim" id="registrar-shim">SHIM Headers Registry</a></h3>
    <p class="" style="">The XMPP Registrar shall add "ThreadID" to its registry of SHIM headers. The submission is as follows:</p>
    <p class="caption"></p><div class="indent"><pre>
&lt;header&gt;
  &lt;name&gt;ThreadID&lt;/name&gt;
  &lt;desc&gt;
    This header has the same semantics as the thread child element
    of the XMPP message stanza but is for use in IQ stanzas.
  &lt;/desc&gt;
  &lt;doc&gt;XEP-0201&lt;/doc&gt;
&lt;/header&gt;
    </pre></div>
  </div>
<hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2251023" id="nt-id2251023">1</a>. XEP-0085: Chat State Notifications &lt;<a href="http://www.xmpp.org/extensions/xep-0085.html">http://www.xmpp.org/extensions/xep-0085.html</a>&gt;.</p><p><a name="nt-id2251045" id="nt-id2251045">2</a>. XEP-0155: Chat Session Negotiation &lt;<a href="http://www.xmpp.org/extensions/xep-0155.html">http://www.xmpp.org/extensions/xep-0155.html</a>&gt;.</p><p><a name="nt-id2251063" id="nt-id2251063">3</a>. RFC 3921: Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://tools.ietf.org/html/rfc3921">http://tools.ietf.org/html/rfc3921</a>&gt;.</p><p><a name="nt-id2251087" id="nt-id2251087">4</a>. rfc3921bis: proposed revisions to Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence &lt;<a href="http://www.ietf.org/internet-drafts/draft-saintandre-rfc3921bis-01.txt">http://www.ietf.org/internet-drafts/draft-saintandre-rfc3921bis-01.txt</a>&gt;. (work in progress)</p><p><a name="nt-id2251141" id="nt-id2251141">5</a>. XEP-0045: Multi-User Chat &lt;<a href="http://www.xmpp.org/extensions/xep-0045.html">http://www.xmpp.org/extensions/xep-0045.html</a>&gt;.</p><p><a name="nt-id2258527" id="nt-id2258527">6</a>. RFC 4122: A Universally Unique IDentifier (UUID) URN Namespace &lt;<a href="http://tools.ietf.org/html/rfc4122">http://tools.ietf.org/html/rfc4122</a>&gt;.</p><p><a name="nt-id2258877" id="nt-id2258877">7</a>. XEP-0131: Stanza Headers and Internet Metadata &lt;<a href="http://www.xmpp.org/extensions/xep-0131.html">http://www.xmpp.org/extensions/xep-0131.html</a>&gt;.</p><p><a name="nt-id2258988" id="nt-id2258988">8</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 0.3 (2007-01-29)</h4><div class="indent"><p class="" style="">Described handling of unavailable presence and 'chat' messages without thread IDs; minor changes</p> (ip)
    </div><h4>Version 0.2 (2007-01-23)</h4><div class="indent"><p class="" style="">Equalized treatment of different message types (chat and groupchat not preferred over normal); required the use of UUIDs; specified use of In-Reply-To header; added Kevin Smith as co-author.</p> (psa/ks)
    </div><h4>Version 0.1 (2006-12-20)</h4><div class="indent"><p class="" style="">Initial version.</p> (psa)
    </div><h4>Version 0.0.2 (2006-12-14)</h4><div class="indent">Corrected SHIM example; added XMPP Registrar considerations. (psa)
    </div><h4>Version 0.0.1 (2006-12-13)</h4><div class="indent">First draft. (psa/ip)
    </div></div><hr /><p>END</p></body></html>
