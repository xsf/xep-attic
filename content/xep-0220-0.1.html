<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>XEP-0220: Server Dialback</title><link rel="stylesheet" type="text/css" href="../xmpp.css" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /><meta name="DC.Title" content="Server Dialback" /><meta name="DC.Creator" content="Peter Saint-Andre" /><meta name="DC.Creator" content="Jeremie Miller" /><meta name="DC.Description" content="This document provides documentation of the server dialback protocol." /><meta name="DC.Publisher" content="XMPP Standards Foundation" /><meta name="DC.Contributor" content="XMPP Extensions Editor" /><meta name="DC.Date" content="2007-07-11" /><meta name="DC.Type" content="XMPP Extension Protocol" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="XEP-0220" /><meta name="DC.Language" content="en" /><meta name="DC.Rights" content="This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF)." /></head><body><h1>XEP-0220: Server Dialback</h1><p>This document provides documentation of the server dialback protocol.</p><hr /><p style="color:red">WARNING: This Standards-Track document is Experimental. Publication as an XMPP Extension Protocol does not imply approval of this proposal by the XMPP Standards Foundation. Implementation of the protocol described herein is encouraged in exploratory implementations, but production systems should not deploy implementations of this protocol until it advances to a status of Draft.</p><hr /><h2>Document Information</h2><p class="indent">
            Series: <a href="http://www.xmpp.org/extensions/">XEP</a><br />
            Number: 0220<br />
            Publisher: <a href="/xsf/">XMPP Standards Foundation</a><br />
            Status: 
            <a href="http://www.xmpp.org/extensions/xep-0001.html#states-Experimental">Experimental</a><br />
            Type:
            <a href="http://www.xmpp.org/extensions/xep-0001.html#types-Standards Track">Standards Track</a><br />
            Version: 0.1<br />
            Last Updated: 2007-07-11<br />
                Approving Body: <a href="http://www.xmpp.org/council/">XMPP Council</a><br />Dependencies: XMPP Core<br />
                Supersedes: None<br />
                Superseded By: None<br />
            Short Name: dialback<br />
              Wiki Page: &lt;<a href="http://wiki.jabber.org/index.php/Server Dialback (XEP-0220)">http://wiki.jabber.org/index.php/Server Dialback (XEP-0220)</a>&gt;
            </p><hr /><h2>Author Information</h2><div class="indent"><h3>Peter Saint-Andre</h3><p class="indent">
        JabberID: 
        <a href="xmpp:stpeter@jabber.org">stpeter@jabber.org</a><br />
        URI: 
        <a href="https://stpeter.im/">https://stpeter.im/</a><br /></p><h3>Jeremie Miller</h3><p class="indent">
        Email:
        <a href="mailto:jer@jabber.org">jer@jabber.org</a><br />
        JabberID: 
        <a href="xmpp:jer@jabber.org">jer@jabber.org</a><br /></p></div><hr /><h2>Legal Notices</h2><div class="indent"><h3>Copyright</h3>This XMPP Extension Protocol is copyright (c) 1999 - 2008 by the XMPP Standards Foundation (XSF).<h3>Permissions</h3>Permission is hereby granted, free of charge, to any person obtaining a copy of this specification (the "Specification"), to make use of the Specification without restriction, including without limitation the rights to implement the Specification in a software program, deploy the Specification in a network service, and copy, modify, merge, publish, translate, distribute, sublicense, or sell copies of the Specification, and to permit persons to whom the Specification is furnished to do so, subject to the condition that the foregoing copyright notice and this permission notice shall be included in all copies or substantial portions of the Specification. Unless separate permission is granted, modified works that are redistributed shall not contain misleading information regarding the authors, title, number, or publisher of the Specification, and shall not claim endorsement of the modified works by the authors, any organization or project to which the authors belong, or the XMPP Standards Foundation.<h3>Disclaimer of Warranty</h3><span style="font-weight: bold">## NOTE WELL: This Specification is provided on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. In no event shall the XMPP Standards Foundation or the authors of this Specification be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the Specification or the implementation, deployment, or other use of the Specification. ##</span><h3>Limitation of Liability</h3>In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall the XMPP Standards Foundation or any author of this Specification be liable for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising out of the use or inability to use the Specification (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if the XMPP Standards Foundation or such author has been advised of the possibility of such damages.<h3>IPR Conformance</h3>This XMPP Extension Protocol has been contributed in full conformance with the XSF's Intellectual Property Rights Policy (a copy of which may be found at &lt;<a href="http://www.xmpp.org/extensions/ipr-policy.shtml">http://www.xmpp.org/extensions/ipr-policy.shtml</a>&gt; or obtained by writing to XSF, P.O. Box 1641, Denver, CO 80201 USA).</div><hr /><h2>Discussion Venue</h2><p class="indent">The preferred venue for discussion of this document is the Standards discussion list: &lt;<a href="http://mail.jabber.org/mailman/listinfo/standards">http://mail.jabber.org/mailman/listinfo/standards</a>&gt;.</p><p class="indent">Errata may be sent to &lt;<a href="mailto:editor@xmpp.org">editor@xmpp.org</a>&gt;.</p><h2>Relation to XMPP</h2><p class="indent">The Extensible Messaging and Presence Protocol (XMPP) is defined in the XMPP Core (RFC 3920) and XMPP IM (RFC 3921) specifications contributed by the XMPP Standards Foundation to the Internet Standards Process, which is managed by the Internet Engineering Task Force in accordance with RFC 2026. Any protocol defined in this document has been developed outside the Internet Standards Process and is to be understood as an extension to XMPP rather than as an evolution, development, or modification of XMPP itself.</p><h2>Conformance Terms</h2><p class="indent">The following keywords as used in this document are to be interpreted as described in <a href="http://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>: "MUST", "SHALL", "REQUIRED"; "MUST NOT", "SHALL NOT"; "SHOULD", "RECOMMENDED"; "SHOULD NOT", "NOT RECOMMENDED"; "MAY", "OPTIONAL".</p><hr /><h2>Table of Contents</h2><div class="indent"><p><br />1.  <a href="#intro">Introduction</a><br />2.  <a href="#terms">Terminology</a><br />3.  <a href="#order">Order of Events</a><br />4.  <a href="#protocol">Protocol</a><br />   
      4.1.  <a href="#proto-setup-o2r">Stream Setup Between Originating Server and Receiving Server</a><br />   
      4.2.  <a href="#proto-key">Dialback Key</a><br />   
      4.3.  <a href="#proto-setup-r2a">Stream Setup Between Receiving Server and Authoritative Server</a><br />   
      4.4.  <a href="#proto-verify">Verification Request</a><br />   
      4.5.  <a href="#proto-result">Result</a><br />5.  <a href="#dialback-reuse">Reuse of Negotiated Connections</a><br />6.  <a href="#generation">Dialback Key Generation</a><br />7.  <a href="#dialback-advertise">Advertisement</a><br />8.  <a href="#security">Security Considerations</a><br />9.  <a href="#iana">IANA Considerations</a><br />10.  <a href="#registrar">XMPP Registrar Considerations</a><br />   
      10.1.  <a href="#registrar-ns">Protocol Namespaces</a><br />   
      10.2.  <a href="#registrar-stream">Stream Features</a><br />11.  <a href="#schema">XML Schema</a><br />   
      11.1.  <a href="#schema-dialback">Dialback</a><br />   
      11.2.  <a href="#schema-dialbackfeature">Stream Feature</a><br /><a href="#notes">Notes</a><br /><a href="#revs">Revision History</a></p></div><hr /><h2>1.
       <a name="intro" id="intro">Introduction</a></h2>
  <p class="" style="">Server dialback, formerly documented in <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc3920">RFC 3920</a></span>  [<a href="#nt-id2244810">1</a>] but now canonically documented in this specification, is a weak identify verification method that is made possible by the existence of the Domain Name System (DNS), since one server can (normally) discover the authoritative server for a given domain.  Dialback is a native XMPP method that occurs over XML streams, with the result that it is more difficult to spoof XMPP server domains and XML stanzas sent over XML streams between servers.</p>
  <p class="" style="">Server dialback is not a security mechanism, and results only in weak verification of server identities.  Domains requiring robust security SHOULD use TLS and SASL.  If SASL is used for server-to-server authentication, dialback SHOULD NOT be used since it is unnecessary.  However, depending on local policies, a service may wish to use dialback to provide weak identity verification in cases where SASL negotiation would not result in strong authentication (e.g., because the certificate presented by the peer service during TLS negotiation is self-signed and thus provides even weaker identity verification than DNS).</p>
  <p class="" style="">Server dialback is uni-directional, and results in weak identity verification for one stream in one direction.  Because server dialback is not an authentication mechanism, mutual authentication is not possible via dialback.  Therefore, server dialback MUST be completed in each direction in order to enable bi-directional communications between two domains.</p>
  <p class="" style="">The method for generating and verifying the keys used in server dialback MUST take into account the hostnames being used, the stream ID generated by the receiving server, and a secret known by the authoritative server's network; see <a href="#generation">Dialback Key Generation</a>.</p>
  <p class="" style="">Any error that occurs during dialback negotiation MUST be considered a stream error, resulting in termination of the stream and of the underlying TCP connection.  The possible error conditions are specified in the protocol description below.</p>
<h2>2.
       <a name="terms" id="terms">Terminology</a></h2>
  <p class="" style="">The following terminology applies:</p>
  <ul class="" style="">
    <li class="" style="">ORIGINATING SERVER -- the server that is attempting to establish a connection between two domains.</li>
    <li class="" style="">RECEIVING SERVER -- the server that is trying to authenticate that the Originating Server represents the domain which it claims to be.</li>
    <li class="" style="">AUTHORITATIVE SERVER -- the server that answers to the DNS hostname asserted by the Originating Server; for basic environments this will be the Originating Server, but it could be a separate machine in the Originating Server's network (where "network" is defined by knowledge of a shared secret for verification of dialback keys).</li>
  </ul>
<h2>3.
       <a name="order" id="order">Order of Events</a></h2>
  <p class="" style="">The following is a brief summary of the order of events in dialback:</p>
  <ol start="" class="" style="">
    <li class="" style="">The Originating Server establishes an XML stream with the Receiving Server.</li>
    <li class="" style="">The Originating Server sends a 'key' value over the connection to the Receiving Server.</li>
    <li class="" style="">The Receiving Server establishes an XML stream with the Authoritative Server.</li>
    <li class="" style="">The Receiving Server sends the same 'key' value to the Authoritative Server for verification.</li>
    <li class="" style="">The Authoritative Server replies that key is valid or invalid.</li>
    <li class="" style="">The Receiving Server informs the Originating Server whether it is authenticated or not.</li>
  </ol>
  <p class="" style="">We can represent this flow of events graphically as follows.</p>
  <p class="caption"></p><div class="indent"><pre>
Originating               Receiving
  Server                    Server
-----------               ---------
    |                         |
    |   establish stream      |
    | ----------------------&gt; |
    |                         |                   Authoritative
    |   send dialback key     |                       Server
    | ----------------------&gt; |                   -------------
    |                         |                         |
                              |   establish stream      |
                              | ----------------------&gt; |
                              |                         |
                              |   send verify request   |
                              | ----------------------&gt; |
                              |                         |
                              |   send verify response  |
                              | &lt;---------------------- |
                              |
    |  report dialback result |
    | &lt;---------------------- |
    |                         |
  </pre></div>
<h2>4.
       <a name="protocol" id="protocol">Protocol</a></h2>
  <p class="" style="">This section describes the detailed protocol interaction between the Originating Server, the Receiving Server, and the Authoritative Server.</p>
  <p class="" style="">This section uses the following domain names, IP addresses, stream IDs, and shared secret in the examples:</p>
  <ul class="" style="">
    <li class="" style="">The Originating Server is "example.org" (there is no IP address associated with this domain since it is merely asserted by the Originating Server).</li>
    <li class="" style="">The Receiving Server is "xmpp.example.com" and its IP address is "192.0.2.0".</li>
    <li class="" style="">The Authoritative Server is "example.org" and its IP address is "192.0.2.1".</li>
    <li class="" style="">The stream ID of the stream from the Originating Server to the Receiving Server is "D60000229F".</li>
    <li class="" style="">The shared secret known by the Authoritative Server's network is "s3cr3tf0rd14lb4ck".</li>
  </ul>
  <p class="" style="">To assist the reader, the following conventions are used to clarify the flow of packets:</p>
  <ul class="" style="">
    <li class="" style="">"O2R:" -- packets sent from the Originating Server to the Receiving Server.</li>
    <li class="" style="">"R2O:" -- packets sent from the Receiving Server to the Originating Server.</li>
    <li class="" style="">"R2A:" -- packets sent from the Receiving Server to the Authoritative Server.</li>
    <li class="" style="">"A2R:" -- packets sent from the Authoritative Server to the Receiving Server.</li>
  </ul>
  <p class="" style="">Note: A dialback namespace declaration is REQUIRED for all elements used in server dialback.  The name of the dialback namespace MUST be 'jabber:server:dialback'.  All elements qualified by this namespace MUST be prefixed.  An implementation SHOULD generate only the 'db:' prefix for such elements and MAY accept only the 'db:' prefix.</p>
  <p class="" style="">The flow of events is as follows.</p>

  <div class="indent"><h3>4.1 <a name="proto-setup-o2r" id="proto-setup-o2r">Stream Setup Between Originating Server and Receiving Server</a></h3>
    <p class="" style="">The Originating Server (asserted to be "example.org") performs a DNS lookup for the Receiving Server (in accordance with the procedure described in RFC 3920) and establishes a TCP connection to the Receiving Server at the IP address and port discovered during the DNS lookup (here assumed to be "192.0.2.0" and "5269").  Alternatively, the Originating Server MAY reuse an existing TCP connnection to the Receiving Server here rather than opening a new TCP connection (see <a href="piggybacking">Piggybacking</a>).</p>
    <p class="" style="">The Originating Server then sends a stream header to the Receiving Server:</p>
    <p class="caption"><a name="example-1" id="example-1"></a>Example 1. Stream Header</p><div class="indent"><pre>
O2R: &lt;stream:stream
          xmlns='jabber:server'
          xmlns:db='jabber:server:dialback'
          xmlns:stream='http://etherx.jabber.org/streams'
          from='example.org'
          to='xmpp.example.com'
          version='1.0'&gt;
    </pre></div>
    <p class="" style="">Note: The inclusion of the xmlns:db namespace declaration with the name shown indicates to the Receiving Server that the Originating Server supports server dialback.  If any of the namespace names provided by the Originating Server is incorrect, then the Receiving Server MUST generate an &lt;invalid-namespace/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  If the value of the 'to' address provided by the Originating Server does not match a hostname serviced by the Receiving Server, then the Receiving Server MUST generate a &lt;host-unknown/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.</p>
    <p class="" style="">The Receiving Server SHOULD send a stream header back to the Originating Server over the same TCP connection, including a unique ID for this interaction:</p>
    <p class="caption"><a name="example-2" id="example-2"></a>Example 2. Stream Header</p><div class="indent"><pre>
R2O: &lt;stream:stream
         xmlns='jabber:server'
         xmlns:db='jabber:server:dialback'
         xmlns:stream='http://etherx.jabber.org/streams'
         from='xmpp.example.com'
         id='D60000229F'
         to='example.org'
         version='1.0'&gt;
    </pre></div>
    <p class="" style="">Note: The Receiving Server SHOULD reply but MAY silently terminate the XML stream and underlying TCP connection depending on local security policies; however, if the Receiving Server desires to proceed, it MUST send a stream header back to the Originating Server.  If any of the namespace names provided by the Receiving Server is incorrect, then the Originating Server MUST generate an &lt;invalid-namespace/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  If the value of the 'to' address provided by the Receiving Server does not match a hostname serviced by the Originating Server, then the Originating Server MUST generate a &lt;host-unknown/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.</p>
    <p class="" style="">The Receiving Server SHOULD also send stream features to the Originating Server, including the dialback feature:</p>
    <p class="caption"><a name="example-3" id="example-3"></a>Example 3. Stream Features</p><div class="indent"><pre>
R2O: &lt;stream:features&gt;
       &lt;starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'/&gt;
       &lt;dialback xmlns='urn:xmpp:features:dialback'/&gt;
     &lt;/stream:features&gt;
    </pre></div>
  </div>

  <div class="indent"><h3>4.2 <a name="proto-key" id="proto-key">Dialback Key</a></h3>
    <p class="" style="">The Originating Server MUST then send a dialback key to the Receiving Server:</p>
    <p class="caption"><a name="example-4" id="example-4"></a>Example 4. Dialback Key</p><div class="indent"><pre>
O2R: &lt;db:result
         from='example.org'
         to='xmpp.example.com'&gt;
       37c69b1cf07a3f67c04a5ef5902fa5114f2c76fe4a2686482ba5b89323075643
     &lt;/db:result&gt;
    </pre></div>
    <p class="" style="">If the value of the 'to' address provided by the Originating Server does not match a hostname serviced by the Receiving Server, then the Receiving Server MUST generate a &lt;host-unknown/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  The key generated by the Originating Server MUST be verifiable only by servers in the Authoritative Server's network, based on information known only to those servers.  Any verifiable method MAY be used to generate the key; however, the method specified under <a href="#generation">Dialback Key Generation</a> is RECOMMENDED.  The key is not examined by the Receiving Server, since the key is validated by the Authoritative Server.</p>
  </div>

  <div class="indent"><h3>4.3 <a name="proto-setup-r2a" id="proto-setup-r2a">Stream Setup Between Receiving Server and Authoritative Server</a></h3>
    <p class="" style="">The Receiving Server performs a DNS lookup for the Authoritative Server (in accordance with the procedure described in RFC 3920) and establishes a TCP connection to the Authoritative Server at the IP address and port discovered during the DNS lookup (here assumed to be "192.0.2.1" and "5269").  If the Receiving Server cannot connect to the Authoritive Server, it MUST return a &lt;remote-connection-failed/&gt; stream error to the Originating Server and terminate both the XML stream and the underlying TCP connection.</p>
    <p class="" style="">The Receiving Server sends a stream header to the Authoritative Server:</p>
    <p class="caption"><a name="example-5" id="example-5"></a>Example 5. Stream Header</p><div class="indent"><pre>
R2A: &lt;stream:stream
         xmlns='jabber:server'
         xmlns:db='jabber:server:dialback'
         xmlns:stream='http://etherx.jabber.org/streams'
         from='xmpp.example.com'
         to='example.org'
         version='1.0'&gt;
    </pre></div>
    <p class="" style="">Note: If the namespace name is incorrect, then the Authoritative Server MUST generate an &lt;invalid-namespace/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  If the value of the 'to' address provided by the Receiving Server does not match a hostname serviced by the Authoritative Server, then the Authoritative Server MUST generate a &lt;host-unknown/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.</p>
    <p class="" style="">The Authoritative Server sends the Receiving Server a stream header:</p>
    <p class="caption"><a name="example-6" id="example-6"></a>Example 6. Stream Header</p><div class="indent"><pre>
A2R: &lt;stream:stream
         xmlns='jabber:server'
         xmlns:db='jabber:server:dialback'
         xmlns:stream='http://etherx.jabber.org/streams'
         from='example.org'
         id='F92200006D'
         to='xmpp.example.com'
         version='1.0'&gt;
    </pre></div>
    <p class="" style="">Note: If any of the namespace names provided by the Authoritative Server is incorrect, then the Receiving Server MUST generate an &lt;invalid-namespace/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection between it and the Authoritative Server.  If the value of the 'to' address provided by the Authoritative Server does not match a hostname serviced by the Receiving Server, then the Receiving Server MUST generate a &lt;host-unknown/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  If a stream error occurs between the Receiving Server and the Authoritative Server, then the Receiving Server MUST not only terminate the XML stream and the underlying TCP connection between it and the Authoritative Server but also terminate the XML stream and the underlying TCP connection between it and the Originating Server, generating a &lt;remote-connection-failed/&gt; stream error for the latter stream.</p>
    <p class="" style="">The Authoritative Server SHOULD also send stream features to the Receiving Server, including the dialback feature:</p>
    <p class="caption"><a name="example-7" id="example-7"></a>Example 7. Stream Header</p><div class="indent"><pre>
A2R: &lt;stream:features&gt;
       &lt;starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'/&gt;
       &lt;dialback xmlns='urn:xmpp:features:dialback'/&gt;
     &lt;/stream:features&gt;
    </pre></div>
  </div>

  <div class="indent"><h3>4.4 <a name="proto-verify" id="proto-verify">Verification Request</a></h3>
    <p class="" style="">The Receiving Server sends the Authoritative Server a request for verification of a key:</p>
    <p class="caption"><a name="example-8" id="example-8"></a>Example 8. Stream Header</p><div class="indent"><pre>
R2A: &lt;db:verify
         from='xmpp.example.com'
         id='D60000229F'
         to='example.org'&gt;
       37c69b1cf07a3f67c04a5ef5902fa5114f2c76fe4a2686482ba5b89323075643
     &lt;/db:verify&gt;
    </pre></div>
    <p class="" style="">Note: Passed here are the hostnames of the Receiving Server ('from') and the Originating Server ('to'), the original identifier from the Receiving Server's stream header to the Originating Server in Step 3, and the key that the Originating Server sent to the Receiving Server in Step 5.  Based on this information, as well as shared secret information within the Authoritative Server's network, the Authoritative Server determines whether the key is valid or invalid.  If the value of the 'to' address does not match a hostname serviced by the Authoritative Server, then the Authoritative Server MUST generate a &lt;host-unknown/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  If the value of the 'from' address does not match the hostname sent by the Receiving Server in the 'from' address of the stream header it sent to the Authoritative Server in Step 7, then the Authoritative Server MUST generate an &lt;invalid-from/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.</p>
    <p class="" style="">The Authoritative Server determines whether the key was valid or invalid and informs the Receiving Server of its determination, where the &lt;db:verify/&gt; element SHOULD include the key sent by the Receiving Server:</p>
    <p class="caption"><a name="example-9" id="example-9"></a>Example 9. Key is Valid</p><div class="indent"><pre>
A2R: &lt;db:verify
         from='example.org'
         id='D60000229F'
         to='xmpp.example.com'
         type='valid'&gt;
       37c69b1cf07a3f67c04a5ef5902fa5114f2c76fe4a2686482ba5b89323075643
     &lt;/db:verify&gt;
    </pre></div>
    <p class="" style="">Or:</p>
    <p class="caption"><a name="example-10" id="example-10"></a>Example 10. Key is Invalid</p><div class="indent"><pre>
A2R: &lt;db:verify
         from='example.org'
         id='D60000229F'
         to='xmpp.example.com'
         type='invalid'&gt;
       37c69b1cf07a3f67c04a5ef5902fa5114f2c76fe4a2686482ba5b89323075643
     &lt;/db:verify&gt;
    </pre></div>
    <p class="" style="">Note: If the ID does not match that provided by the Receiving Server in Step 3, then the Receiving Server MUST generate an &lt;invalid-id/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  If the value of the 'to' address does not match a hostname serviced by the Receiving Server, then the Receiving Server MUST generate a &lt;host-unknown/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  If the value of the 'from' address does not match the hostname represented by the Originating Server in the 'from' address of the stream header it sent to the Receiving Server in Step 2, then the Receiving Server MUST generate an &lt;invalid-from/&gt; stream error condition and terminate both the XML stream and the underlying TCP connection.  After receiving the verification from the Authoritative Server, the Receiving Server SHOULD terminate the stream between them and the underlying TCP connection.</p>
  </div>

  <div class="indent"><h3>4.5 <a name="proto-result" id="proto-result">Result</a></h3>
    <p class="" style="">The Receiving Server informs the Originating Server of the result, where the &lt;db:result/&gt; element SHOULD include the key sent by the Originating Server:</p>
    <p class="caption"><a name="example-11" id="example-11"></a>Example 11. Result</p><div class="indent"><pre>
R2O: &lt;db:result
         from='xmpp.example.com'
         to='example.org'
         type='valid'&gt;
       37c69b1cf07a3f67c04a5ef5902fa5114f2c76fe4a2686482ba5b89323075643
     &lt;/db:result&gt;
    </pre></div>
    <p class="" style="">Note: At this point, the connection from the Originating Server to the Receiving Server has either been validated or reported as invalid.  If the connection is invalid, then the Receiving Server MUST terminate both the XML stream and the underlying TCP connection between itself and the Originating Server.  If the connection is valid, the Receiving Server has verified the identity of the Originating Server; as a result, the Originating Server may now send XML stanzas to the Receiving Server over the validated connection (i.e., over the "initial stream" from the Originating Server to the Receiving Server).</p>
    <p class="" style="">Until the initial stream has been validated, the Originating Server MUST NOT send any further XML data to the Receiving Server.  If it receives any XML stanzas from the Originating Server before the initial stream has been validated, the Receiving Server MUST silently drop them.</p>
    <p class="" style="">After successful dialback negotiation, the Receiving Server MUST follow the rules specified in RFC 3920 regarding inclusion and checking of 'from' and 'to' attributes on all XML stanzas it receives from the Originating Server.  These checks help to prevent address spoofing.</p>
    <p class="" style="">As mentioned, server dialback results in weak identity verification in one direction only (in the foregoing text, verification of the Originating Server by the Receiving Server).  In order to proceed with bi-directional communication so that the Receiving Server may sent XML stanzas to the Originating Server, the Receiving Server MUST now also initiate a dialback negotiation with the Originating Server (this happens on a different TCP connection).</p>
  </div>
<h2>5.
       <a name="dialback-reuse" id="dialback-reuse">Reuse of Negotiated Connections</a></h2>
  <p class="" style="">After the Receiving Server has validated the connection from the Originating Server, the Originating Server may wish to reuse that connection for validation of additional domains.  This feature is called PIGGYBACKING.  Support for piggybacking is OPTIONAL.</p>
  <p class="" style="">One common motivation for such reuse is the existence of additional services associated with the Originating Server but hosted at subdomains of the Originating Server (the use of subdomains helps to ensure proper routing of XML stanzas to the hosted services). For example, the "example.org" XMPP server may host a groupchat service at "chat.example.org".  In order to accept XML stanzas from rooms at "chat.example.org" intended for addresses at "xmpp.example.com", the "xmpp.example.com" domain will need to validate the "chat.example.org" domain (just as it already did for the "example.org" domain).  Thus the "example.org" server would now initiate a dialback negotiation with "xmpp.example.com" but specify the Originating Server as "chat.example.org".</p>
  <p class="" style="">However, because the "example.org" server already has a validated connection open to the Receiving Server ("xmpp.example.com"), it MAY send a &lt;db:result/&gt; element with the key to be validated for the new Originating Server ("chat.example.org") over the XML stream that has already been negotiated, rather than opening a new TCP connection and XML stream.</p>
  <p class="caption"><a name="example-12" id="example-12"></a>Example 12. Piggybacked Key</p><div class="indent"><pre>
O2R: &lt;db:result
         from='chat.example.org'
         to='xmpp.example.com'&gt;
       88a96894060d5f4258c37cd51b772e5a483430d8203f71d3782cac72a0866458
     &lt;/db:result&gt;
  </pre></div>
  <p class="" style="">The Receiving Server SHOULD accept this &lt;db:result/&gt; element (as it did for the first &lt;db:result/&gt; element) and process it according to the rules already specified.  If that process is successful, it would eventually result in sending of a &lt;db:result/&gt; element from the Receiving Server to the Originating Server.</p>
  <p class="caption"><a name="example-13" id="example-13"></a>Example 13. Piggybacked Result</p><div class="indent"><pre>
R2O: &lt;db:result
         from='xmpp.example.com'
         to='chat.example.org'
         type='valid'&gt;
       88a96894060d5f4258c37cd51b772e5a483430d8203f71d3782cac72a0866458
     &lt;/db:result&gt;
  </pre></div>
  <p class="" style="">However, if the Receiving Server does not allow reuse of the existing connection, it MUST return an error of the following form to the Originating Server.</p>
  <p class="caption"><a name="example-14" id="example-14"></a>Example 14. Piggybacking Not Supported</p><div class="indent"><pre>
R2O: &lt;db:result
         from='xmpp.example.com'
         to='chat.example.org'
         type='error'&gt;
       88a96894060d5f4258c37cd51b772e5a483430d8203f71d3782cac72a0866458
     &lt;/db:result&gt;
  </pre></div>
<h2>6.
       <a name="generation" id="generation">Dialback Key Generation</a></h2>
  <p class="" style="">As mentioned, the dialback key is generated based on four different pieces of information:</p>
  <ul class="" style="">
    <li class="" style="">the hostname of the Originating Server</li>
    <li class="" style="">the hostname of the Receiving Server</li>
    <li class="" style="">the Stream ID</li>
    <li class="" style="">a shared secret known by the Authoritative Server's network</li>
  </ul>
  <p class="" style="">The stream ID is security-critical in server dialback and therefore MUST be both unpredictable and non-repeating (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4086">RFC 4086</a></span>  [<a href="#nt-id2254148">2</a>] for recommendations regarding randomness for security purposes).</p>
  <p class="" style="">It is RECOMMENDED for the dialback key to be the hexadecimal representation of a Keyed-Hash Message Authentication Code (see <span class="ref" style=""><a href="http://csrc.nist.gov/publications/fips/fips198/fips-198a.pdf">HMAC</a></span>  [<a href="#nt-id2254184">3</a>]) generated using the SHA256 hashing algorithm (see <span class="ref" style=""><a href="http://csrc.nist.gov/publications/fips/fips180-2/fips180-2withchangenotice.pdf">SHA</a></span>  [<a href="#nt-id2254214">4</a>]), as follows.</p>
  <p class="caption"><a name="example-15" id="example-15"></a>Example 15. HMAC</p><div class="indent"><pre>
HMAC-SHA256
( 
  SHA256(secret), 
  {Receiving Server, ' ', Originating Server, ' ', Stream ID} 
)
  </pre></div>
  <p class="" style="">The shared secret SHOULD either be set up in a configuration option for each host or process within the Authoritative Server's network or generated as a random string when starting each host or process.  The secret's length SHOULD be at least 128 bits or 16 characters long.</p>
  <p class="" style="">Consider the following scenario:</p>
  <ul class="" style="">
    <li class="" style="">The Originating Server is "example.org"</li>
    <li class="" style="">The Receiving Server is "xmpp.example.com"</li>
    <li class="" style="">The Stream ID is "D60000229F"</li>
    <li class="" style="">The secret is "s3cr3tf0rd14lb4ck"</li>
  </ul>
  <p class="" style="">The resulting dialback key would be:</p>
  <p class="caption"><a name="example-16" id="example-16"></a>Example 16. A Key</p><div class="indent"><pre>
HMAC-SHA256
( 
  SHA256(secret), 
  {Receiving Server, ' ', Originating Server, ' ', Stream ID} 
)

that is,

HMAC-SHA256
(SHA256('s3cr3tf0rd14lb4ck'),
{'xmpp.example.net',' ','example.org',' ','D60000229F'})

that is,

HMAC-SHA256
('a7136eb1f46c9ef18c5e78c36ca257067c69b3d518285f0b18a96c33beae9acc',
{'xmpp.example.com chat.example.org D60000229F'})

that is,

37c69b1cf07a3f67c04a5ef5902fa5114f2c76fe4a2686482ba5b89323075643
  </pre></div>
<h2>7.
       <a name="dialback-advertise" id="dialback-advertise">Advertisement</a></h2>
  <p class="" style="">Support for the server dialback protocol can be indicated in two ways:</p>
  <ol start="" class="" style="">
    <li class="" style="">By inclusion of the server dialback feature in a given set of stream features.</li>
    <li class="" style="">By inclusion of the dialback namespace declaration in the stream header.</li>
  </ol>
  <p class="" style="">The former method is preferred, but the latter method is also specified herein for the purpose of backward-compatibility with older "XMPP 0.9" deployments.</p>
  <p class="" style="">The server dialback stream feature is advertised by including in any given set of stream features a &lt;dialback/&gt; element qualified by the 'urn:xmpp:features:dialback' namespace; the &lt;dialback/&gt; element MAY also include an empty &lt;required/&gt; element, indicating that the entity sending the stream features requires dialback to be negotiated for the stream.</p>
  <p class="caption"><a name="example-17" id="example-17"></a>Example 17. Stream Features</p><div class="indent"><pre>
&lt;stream:features&gt;
  &lt;dialback xmlns='urn:xmpp:features:dialback'&gt;
    &lt;required/&gt;
  &lt;/dialback&gt;
&lt;/stream:features&gt;
  </pre></div>
  <p class="" style="">As mentioned, support for the server dialback protocol can also be advertised by including the dialback namespace declaration in a stream header.</p>
  <p class="caption"><a name="example-18" id="example-18"></a>Example 18. Stream Header</p><div class="indent"><pre>
&lt;stream:stream
    xmlns='jabber:server'
    xmlns:db='jabber:server:dialback'
    xmlns:stream='http://etherx.jabber.org/streams'
    from='example.com'
    to='example.net'&gt;
  </pre></div>
  <p class="" style="">No matter which method is used, a service SHOULD advertise support for server dialback only at a point in the stream negotiation when it will accept negotiation of server dialback for that stream.  For example, if a service wishes to be backward-compatible with older "XMPP 0.9" deployments, it SHOULD include the server dialback namespace declaration in the initial stream header it sends to other servers (so that "XMPP 0.9" servers can proceed with dialback in the absence of TLS and SASL authentication).  However, in the midst of stream negotiation with an XMPP 1.0 or higher server, a service SHOULD advertise the dialback stream feature only at a point when negotiation of server dialback is allowed in accordance with local service policies (e.g., after TLS negotiation in the case when a self-signed certificate was presented by the Originating Server and local service policies stipulate that it is preferable to weakly identify the Originating Server via server dialback rather than depend on the self-signed certificate for identity verification).</p>
<h2>8.
       <a name="security" id="security">Security Considerations</a></h2>
  <p class="" style="">Server dialback helps protect against domain spoofing, thus making it more difficult to spoof XML stanzas.  It is not a mechanism for authenticating, securing, or encrypting streams between servers as is done via SASL and TLS, and results in weak verification of server identities only.  Furthermore, it is susceptible to DNS poisoning attacks unless DNSSEC (see <span class="ref" style=""><a href="http://tools.ietf.org/html/rfc4033">RFC 4033</a></span>  [<a href="#nt-id2254492">5</a>]) is used, and even if the DNS information is accurate, dialback cannot protect from attacks where the attacker is capable of hijacking the IP address of the remote domain.  Domains requiring robust security SHOULD use TLS and SASL.  If SASL is used for server-to-server authentication, dialback SHOULD NOT be used since it is unnecessary.</p>
<h2>9.
       <a name="iana" id="iana">IANA Considerations</a></h2>
  <p class="" style="">This document requires no interaction with the <span class="ref" style=""><a href="http://www.iana.org/">Internet Assigned Numbers Authority (IANA)</a></span>  [<a href="#nt-id2254540">6</a>].</p> 
<h2>10.
       <a name="registrar" id="registrar">XMPP Registrar Considerations</a></h2>
  <div class="indent"><h3>10.1 <a name="registrar-ns" id="registrar-ns">Protocol Namespaces</a></h3>
    <p class="" style="">The <span class="ref" style=""><a href="http://www.xmpp.org/registrar/">XMPP Registrar</a></span>  [<a href="#nt-id2254593">7</a>] includes 'jabber:server:dialback' in its registry of protocol namespaces (see &lt;<a href="http://www.xmpp.org/registrar/namespaces.html">http://www.xmpp.org/registrar/namespaces.html</a>&gt;).</p>
  </div>
  <div class="indent"><h3>10.2 <a name="registrar-stream" id="registrar-stream">Stream Features</a></h3>
    <p class="" style="">The XMPP Registrar includes 'urn:xmpp:features:dialback' in its registry of stream features (see &lt;<a href="http://www.xmpp.org/registrar/stream-features.html">http://www.xmpp.org/registrar/stream-features.html</a>&gt;).</p>
  </div>
<h2>11.
       <a name="schema" id="schema">XML Schema</a></h2>
  <div class="indent"><h3>11.1 <a name="schema-dialback" id="schema-dialback">Dialback</a></h3>
    <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='jabber:server:dialback'
    xmlns='jabber:server:dialback'
    elementFormDefault='qualified'&gt;

  &lt;xs:element name='result'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='xs:NMTOKEN'&gt;
          &lt;xs:attribute name='from' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='to' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='type' use='optional'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='error'/&gt;
                &lt;xs:enumeration value='invalid'/&gt;
                &lt;xs:enumeration value='valid'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='verify'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='xs:NMTOKEN'&gt;
          &lt;xs:attribute name='from' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='id' type='xs:NMTOKEN' use='required'/&gt;
          &lt;xs:attribute name='to' type='xs:string' use='required'/&gt;
          &lt;xs:attribute name='type' use='optional'&gt;
            &lt;xs:simpleType&gt;
              &lt;xs:restriction base='xs:NCName'&gt;
                &lt;xs:enumeration value='error'/&gt;
                &lt;xs:enumeration value='invalid'/&gt;
                &lt;xs:enumeration value='valid'/&gt;
              &lt;/xs:restriction&gt;
            &lt;/xs:simpleType&gt;
          &lt;/xs:attribute&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

&lt;/xs:schema&gt;
    </pre></div>
  </div>
  <div class="indent"><h3>11.2 <a name="schema-dialbackfeature" id="schema-dialbackfeature">Stream Feature</a></h3>
    <p class="caption"></p><div class="indent"><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='urn:xmpp:features:dialback'
    xmlns='urn:xmpp:features:dialback'
    elementFormDefault='qualified'&gt;

  &lt;xs:element name='dialback'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element name='required'
                    minOccurs='0'
                    maxOccurs='1'
                    type='empty'/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
    </pre></div>
  </div>
<hr /><h2><a name="notes" id="notes"></a>Notes</h2><div class="indent"><p><a name="nt-id2244810" id="nt-id2244810">1</a>. RFC 3920: Extensible Messaging and Presence Protocol (XMPP): Core &lt;<a href="http://tools.ietf.org/html/rfc3920">http://tools.ietf.org/html/rfc3920</a>&gt;.</p><p><a name="nt-id2254148" id="nt-id2254148">2</a>. RFC 4086: Randomness Requirements for Security &lt;<a href="http://tools.ietf.org/html/rfc4086">http://tools.ietf.org/html/rfc4086</a>&gt;.</p><p><a name="nt-id2254184" id="nt-id2254184">3</a>. The Keyed-Hash Message Authentication Code (HMAC): Federal Information Processing Standards Publication 198 &lt;<a href="http://csrc.nist.gov/publications/fips/fips198/fips-198a.pdf">http://csrc.nist.gov/publications/fips/fips198/fips-198a.pdf</a>&gt;.</p><p><a name="nt-id2254214" id="nt-id2254214">4</a>. Secure Hash Standard: Federal Information Processing Standards Publication 180-2  &lt;<a href="http://csrc.nist.gov/publications/fips/fips180-2/fips180-2withchangenotice.pdf">http://csrc.nist.gov/publications/fips/fips180-2/fips186-2withchangenotice.pdf</a>&gt;.</p><p><a name="nt-id2254492" id="nt-id2254492">5</a>. RFC 4033: DNS Security Introduction and Requirements &lt;<a href="http://tools.ietf.org/html/rfc4033">http://tools.ietf.org/html/rfc4033</a>&gt;.</p><p><a name="nt-id2254540" id="nt-id2254540">6</a>. The Internet Assigned Numbers Authority (IANA) is the central coordinator for the assignment of unique parameter values for Internet protocols, such as port numbers and URI schemes. For further information, see &lt;<a href="http://www.iana.org/">http://www.iana.org/</a>&gt;.</p><p><a name="nt-id2254593" id="nt-id2254593">7</a>. The XMPP Registrar maintains a list of reserved protocol namespaces as well as registries of parameters used in the context of XMPP extension protocols approved by the XMPP Standards Foundation. For further information, see &lt;<a href="http://www.xmpp.org/registrar/">http://www.xmpp.org/registrar/</a>&gt;.</p></div><hr /><h2><a name="revs" id="revs"></a>Revision History</h2><div class="indent"><h4>Version 0.1 (2007-07-11)</h4><div class="indent"><p class="" style="">Initial published version.</p> (psa)
    </div><h4>Version 0.0.1 (2007-06-22)</h4><div class="indent"><p class="" style="">Content moved from rfc3920bis.</p> (psa)
    </div></div><hr /><p>END</p></body></html>
